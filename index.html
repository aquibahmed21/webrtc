<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video Calling App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #videos {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        video {
            width: 45%;
            margin: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>WebRTC Video Calling App</h1>
    <div id="videos"></div>

    <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
    <script>
        const roomName = "hello";
        const configuration = {
            iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
        };

        let room;
        let pc;
        const localVideo = document.createElement("video");
        const remoteVideo = document.createElement("video");
        localVideo.autoplay = true;
        remoteVideo.autoplay = true;
        document.getElementById("videos").appendChild(localVideo);
        document.getElementById("videos").appendChild(remoteVideo);

        const drone = new Scaledrone("YOUR_SCALEDRONE_CHANNEL_ID", {
            room: roomName,
        });

        drone.on("open", error => {
            if (error) {
                return console.error(error);
            }
            room = drone.subscribe("observable-room");
            room.on("open", error => {
                if (error) {
                    return console.error(error);
                }
                console.log("Joined room");
            });

            room.on("members", members => {
                console.log("Members", members);
                if (members.length >= 2) {
                    startWebRTC(members);
                }
            });

            room.on("member_join", member => {
                console.log("Member joined", member);
                if (room.members.length >= 2) {
                    startWebRTC(room.members);
                }
            });
        });

        function startWebRTC(members) {
            pc = new RTCPeerConnection(configuration);

            pc.onicecandidate = event => {
                if (event.candidate) {
                    drone.publish({
                        room: roomName,
                        message: { candidate: event.candidate }
                    });
                }
            };

            pc.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
            };

            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    localVideo.srcObject = stream;
                    stream.getTracks().forEach(track => pc.addTrack(track, stream));
                    pc.createOffer().then(offer => {
                        return pc.setLocalDescription(offer);
                    }).then(() => {
                        drone.publish({
                            room: roomName,
                            message: { sdp: pc.localDescription }
                        });
                    });
                });

            drone.on("message", message => {
                if (message.sdp) {
                    pc.setRemoteDescription(new RTCSessionDescription(message.sdp)).then(() => {
                        if (pc.remoteDescription.type === "offer") {
                            pc.createAnswer().then(answer => {
                                return pc.setLocalDescription(answer);
                            }).then(() => {
                                drone.publish({
                                    room: roomName,
                                    message: { sdp: pc.localDescription }
                                });
                            });
                        }
                    });
                } else if (message.candidate) {
                    pc.addIceCandidate(new RTCIceCandidate(message.candidate));
                }
            });
        }
    </script>
</body>
</html>
