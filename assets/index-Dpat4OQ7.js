(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))e(a);new MutationObserver(a=>{for(const c of a)if(c.type==="childList")for(const g of c.addedNodes)g.tagName==="LINK"&&g.rel==="modulepreload"&&e(g)}).observe(document,{childList:!0,subtree:!0});function o(a){const c={};return a.integrity&&(c.integrity=a.integrity),a.referrerPolicy&&(c.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?c.credentials="include":a.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function e(a){if(a.ep)return;a.ep=!0;const c=o(a);fetch(a.href,c)}})();function A(t,n,o){const e=new window.Scaledrone("EoIG3R1I4JdyS4L1"),a=e.subscribe(t);return e.on("open",n),a.on("message",o),{drone:e,room:a}}const f={};let k,y=null,m=null,E=null;const M=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],N={iceServers:M};function O(t,n){k=t;const o="observable-e7b2d4",{drone:e,room:a}=A(o,c,g);m=e,E=a;function c(s){if(s)return console.error(s);console.log("Connected to Scaledrone")}function g(s){const{data:i,member:w}=s,r=w.id;if(r!==m.clientId)switch(i.type){case"offer":p(r,!1,n),f[r].setRemoteDescription(new RTCSessionDescription(i.offer)),f[r].createAnswer().then(h=>{f[r].setLocalDescription(h),m.publish({room:o,message:{type:"answer",answer:h,to:r}})});break;case"answer":i.to===m.clientId&&f[r]&&f[r].setRemoteDescription(new RTCSessionDescription(i.answer));break;case"candidate":i.to===m.clientId&&f[r]&&f[r].addIceCandidate(new RTCIceCandidate(i.candidate));break;case"leave":const d=document.getElementById(r);d&&d.remove(),f[r]&&(f[r].close(),delete f[r]);break}}E.on("members",s=>{s.forEach(i=>{i.id!==m.clientId&&p(i.id,!0,n)})});async function p(s,i,w){const r=y=new RTCPeerConnection(N);if(r.onicecandidate=d=>{d.candidate?(console.log("New ICE Candidate:",d.candidate),m.publish({room:o,message:{type:"candidate",candidate:d.candidate,to:s}})):console.log("All ICE candidates have been gathered.")},r.oniceconnectionstatechange=()=>{var d,h,v;console.log("ICE connection state changed:",r.iceConnectionState),r.iceConnectionState==="failed"?(console.warn("ICE Connection failed. Likely need TURN."),(d=document.getElementById(s))==null||d.remove()):r.iceConnectionState==="disconnected"?(console.warn("ICE Connection disconnected. Could be a network issue."),(h=document.getElementById(s))==null||h.remove()):r.iceConnectionState==="closed"&&(console.warn("ICE Connection closed."),(v=document.getElementById(s))==null||v.remove())},r.onconnectionstatechange=()=>{console.log("PeerConnection state:",r.connectionState)},r.onnegotiationneeded=()=>{console.log("Negotiation needed")},r.onsignalingstatechange=()=>{console.log("Signaling state changed:",r.signalingState)},r.ontrack=d=>{console.log("Track received:",d.track.kind),w(d.streams[0],s)},k.getTracks().forEach(d=>r.addTrack(d,k)),i){const d=await R(r);m.publish({room:o,message:{type:"offer",offer:d,to:s}})}f[s]=r}}let C=0,S=0,l=null,b=0;const P=document.querySelector("#quality"),V=document.querySelector("#framerate");P.addEventListener("change",async t=>{if(!l)return;const[n,o]=t.target.value.split("x").map(Number);await T(n,o,b)&&await L()});V.addEventListener("change",async t=>{if(!l)return;const n=Number(t.target.value);await T(C,S,n)&&await L()});async function D(t,n,o){try{const e={video:{width:{ideal:t},height:{ideal:n},frameRate:{ideal:o}},audio:!0};return await navigator.mediaDevices.getUserMedia(e)}catch(e){return console.error("Failed to get media stream:",e),null}}async function x(){const n=(l.getVideoTracks()[0].getSettings().facingMode||"user")==="user"?"environment":"user";try{const o={video:{width:{ideal:C},height:{ideal:S},frameRate:{ideal:b},facingMode:n},audio:!1},e=await navigator.mediaDevices.getUserMedia(o);return l.getVideoTracks()[0].stop(),l.removeTrack(l.getVideoTracks()[0]),l.addTrack(e.getVideoTracks()[0]),l}catch(o){return console.error("Failed to get media stream:",o),null}}async function T(t,n,o){S=n,C=t,b=o;const e=await D(t,n,o);if(!e)return!1;const a=e.getVideoTracks()[0];if(l){const c=l.getVideoTracks()[0];c&&c.stop(),l.removeTrack(c),l.addTrack(a)}else l=e;return!0}async function q(){const[t,n]=P.value.split("x").map(Number),o=Number(V.value);return await T(t,n,o),l}function I(t,n,o=!1){const e=document.createElement("video");e.srcObject=t,e.id=n,e.autoplay=!0,e.playsInline=!0,o&&(e.muted=!0),o?document.getElementsByClassName("Channel")[0].appendChild(e):document.getElementsByClassName("Channel")[0].prepend(e)}async function L(){const t=y;if(!t)return;const n=t.getSenders().find(o=>o.track&&o.track.kind==="video");if(n){const o=n.track;try{o.stop();const a=l.getVideoTracks()[0];await n.replaceTrack(a),await R(t)}catch(e){console.error("Error updating local video stream:",e),n&&o&&n.replaceTrack&&await n.replaceTrack(o)}}else console.log("No video sender found.")}function B(){const t=navigator.userAgent;return/iPhone|iPad|iPod/.test(t)&&/Safari/.test(t)&&!/CriOS/.test(t)?"H264":(/Android/.test(t)&&/Chrome/.test(t)||/Firefox/.test(t)||/Edge|Edg/.test(t),"VP8")}function F(t,n,o="video"){const e=t.split(`\r
`),a=e.findIndex(i=>i.startsWith(`m=${o}`));if(a===-1)return t;const c=new RegExp(`a=rtpmap:(\\d+)\\s${n}`,"i"),g=e.filter(i=>c.test(i)).map(i=>i.match(c)[1]);if(g.length===0)return t;const p=e[a].split(" "),s=g.concat(p.slice(3).filter(i=>!g.includes(i)));return e[a]=[...p.slice(0,3),...s].join(" "),e.join(`\r
`)}async function R(t){const n=await t.createOffer(),o=B(),e=F(n.sdp,o);return await t.setLocalDescription({type:n.type,sdp:e}),console.log("Preferred codec:",o),console.log("Modified SDP:",e),n}const U=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let u=null;document.querySelector("#controls").addEventListener("click",async t=>{const n=t.target;switch(t.target.id){case"start":await j();break;case"muteAudio":n.textContent=u.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio",u.getAudioTracks()[0].enabled=!u.getAudioTracks()[0].enabled;break;case"muteVideo":n.textContent=u.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video",u.getVideoTracks()[0].enabled=!u.getVideoTracks()[0].enabled;break;case"switchCamera":await x();break;case"hangup":u&&(u.getTracks().forEach(e=>{e.enabled=!1}),setTimeout(()=>{u.getTracks().forEach(e=>e.stop()),u=null,m.publish({room:Object.keys(m.rooms)[0],message:{type:"leave",from:m.clientId}}),document.querySelector(".Channel").innerHTML="",y&&(y.getSenders().forEach(e=>{e.track&&e.track.stop()}),y.close())},300));break}});async function j(){u=await q(),I(u,"localVideo",!0),O(u,(t,n)=>{document.getElementById(n)||I(t,n)})}U||(document.querySelector("#switchCamera").style.display="none");
