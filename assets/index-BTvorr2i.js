(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const d of n)if(d.type==="childList")for(const m of d.addedNodes)m.tagName==="LINK"&&m.rel==="modulepreload"&&o(m)}).observe(document,{childList:!0,subtree:!0});function r(n){const d={};return n.integrity&&(d.integrity=n.integrity),n.referrerPolicy&&(d.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?d.credentials="include":n.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function o(n){if(n.ep)return;n.ep=!0;const d=r(n);fetch(n.href,d)}})();function U(e,t,r){const o=new window.Scaledrone("EoIG3R1I4JdyS4L1"),n=o.subscribe(e);return o.on("open",t),n.on("message",r),{drone:o,room:n}}function y(e,t){const r=document.getElementById("toastContainer"),o=document.createElement("div");o.classList.add("toast",e.toLowerCase()),o.textContent=t,r.innerHTML="",r.appendChild(o),setTimeout(()=>{o.remove()},3e3)}const g={};let V,E=null,l=null,D=null;const $=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],F={iceServers:$};function H(e,t){V=e;const r="observable-e7b2d4",{drone:o,room:n}=U(r,d,m);l=o,D=n;function d(i){if(i)return console.error(i);console.log("Connected to Scaledrone")}function m(i){const{data:s,member:b}=i,a=b.id;if(a!==l.clientId)switch(s.type){case"offer":console.log("Received an offer from",a),p(a,!1,t),g[a].setRemoteDescription(new RTCSessionDescription(s.offer)),g[a].createAnswer().then(h=>{g[a].setLocalDescription(h),l.publish({room:r,message:{type:"answer",answer:h,to:a}})});break;case"answer":console.log("Received an answer from",a),s.to===l.clientId&&g[a]&&g[a].setRemoteDescription(new RTCSessionDescription(s.answer));break;case"candidate":console.log("Received a candidate from",a),s.to===l.clientId&&g[a]&&g[a].addIceCandidate(new RTCIceCandidate(s.candidate));break;case"leave":console.log(a,"has left the room");const u=document.getElementById(a);u&&u.remove(),g[a]&&(g[a].close(),delete g[a]);break;case"join":console.log(a,"has joined the room"),p(a,!0,t);break;case"screenShare":{const h=document.getElementById(a);h&&(s.isShared===!0?h.setAttribute("screenShare","true"):h.removeAttribute("screenShare"))}break;default:console.warn("Unknown data type:",s.type),y("Warning","Unknown data type: "+s.type)}}D.on("members",i=>{console.log("Members connected:",i),i.forEach(s=>{s.id!==l.clientId&&p(s.id,!0,t)})});async function p(i,s,b){const a=E=new RTCPeerConnection(F);if(a.onicecandidate=u=>{u.candidate?l.publish({room:r,message:{type:"candidate",candidate:u.candidate,to:i}}):console.log("All ICE candidates have been gathered.")},a.oniceconnectionstatechange=()=>{var u,h,M;a.iceConnectionState==="failed"?((u=document.getElementById(i))==null||u.remove(),y("Error","Connection failed. User is not connected!")):a.iceConnectionState==="disconnected"?((h=document.getElementById(i))==null||h.remove(),y("Error","Connection disconnected. Could be a network issue!")):a.iceConnectionState==="closed"&&((M=document.getElementById(i))==null||M.remove(),y("Info","User has left the room!"))},a.onconnectionstatechange=()=>{},a.onnegotiationneeded=()=>{},a.onsignalingstatechange=()=>{},a.ontrack=u=>{console.log("Track received:",u.track.kind),b(u.streams[0],i),y("Info","User has joined the room!")},V.getTracks().forEach(u=>a.addTrack(u,V)),s){const u=await N(a);l.publish({room:r,message:{type:"offer",offer:u,to:i}})}g[i]=a}}let S=0,v=0,c=null,k=0,O="user";const T=document.querySelector("#quality"),I=document.querySelector("#framerate"),L=document.querySelector("#shareScreen"),q=document.querySelector("#muteVideo"),x=document.querySelector("#switchCamera");T.addEventListener("change",async e=>{if(!c)return;const[t,r]=e.target.value.split("x").map(Number);await w(t,r,k)});I.addEventListener("change",async e=>{if(!c)return;const t=Number(e.target.value);await w(S,v,t)});L.addEventListener("click",async e=>{const t=document.querySelector("#localVideo");if(e.target.setAttribute("disabled","true"),e.target.getAttribute("isShared")==="true"){e.target.textContent="🖥️ Share Screen",e.target.setAttribute("isShared","false"),q.removeAttribute("disabled"),T.removeAttribute("disabled"),I.removeAttribute("disabled"),x.removeAttribute("disabled"),e.target.removeAttribute("disabled"),t.removeAttribute("screenShare"),await w(S,v,k),l.publish({room:Object.keys(l.rooms)[0],message:{type:"screenShare",from:l.clientId,isShared:!1}});return}if(c)try{const r=await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:"screen"}});e.target.textContent="🖥️ Stop Sharing",e.target.setAttribute("isShared","true"),q.setAttribute("disabled","true"),T.setAttribute("disabled","true"),I.setAttribute("disabled","true"),x.setAttribute("disabled","true"),t.setAttribute("screenShare","true"),c&&(c.getVideoTracks()[0].stop(),c.removeTrack(c.getVideoTracks()[0]));const o=r.getVideoTracks()[0];c.addTrack(o),await B(),l.publish({room:Object.keys(l.rooms)[0],message:{type:"screenShare",from:l.clientId,isShared:!0}})}catch(r){console.error("Error starting screen share:",r)}finally{e.target.removeAttribute("disabled")}});async function W(e,t,r,o){c&&(c.getVideoTracks()[0].stop(),c.removeTrack(c.getVideoTracks()[0]));try{const n={video:{width:{ideal:e},height:{ideal:t},frameRate:{ideal:r},facingMode:{ideal:o}},audio:!c};return await navigator.mediaDevices.getUserMedia(n)}catch(n){return console.error("Failed to get media stream:",n),y("Error","Failed to get media stream!"),null}}async function w(e,t,r,o=!1,n=!1){v=t,S=e,k=r;const d=n&&c.getVideoTracks()[0].getSettings().facingMode||"user";O=n?d==="user"?"environment":"user":O;const m=await W(S,v,k,O);if(!m)return!1;const p=m.getVideoTracks()[0];if(c){const i=c.getVideoTracks()[0];i&&(i.stop(),c.removeTrack(i)),c.addTrack(p)}else c=m;if(o){const i=document.querySelector("#localVideo");i.setAttribute("mode",c.getVideoTracks()[0].getSettings().facingMode||"user"),i.srcObject=c}return await B(),!0}function G(){w(S,v,k,!0,!0)}async function z(){const[e,t]=T.value.split("x").map(Number),r=Number(I.value);return await w(e,t,r),c}function R(e,t,r=!1){const o=document.createElement("video");o.srcObject=e,o.id=t,o.autoplay=!0,o.playsInline=!0,o.setAttribute("memberId",t),r?(o.muted=!0,document.getElementsByClassName("Channel")[0].appendChild(o),o.setAttribute("mode",c.getVideoTracks()[0].getSettings().facingMode||"user")):(o.setAttribute("isRemote","true"),document.getElementsByClassName("Channel")[0].prepend(o),J(e,o))}function J(e,t){const o=new AudioContext,n=o.createMediaStreamSource(e),d=o.createGain();d.gain.value=2.5;const m=o.createAnalyser();m.fftSize=256;const p=m.frequencyBinCount,i=new Uint8Array(p);n.connect(m),n.connect(d).connect(o.destination),t.srcObject=e,t.volume=0;let s=!1;setInterval(()=>{m.getByteFrequencyData(i);let b=0;for(let u=0;u<i.length;u++)b+=i[u];b/i.length>20?s||(s=!0,j(!0,t)):s&&(s=!1,j(!1,t))},100)}function j(e,t){const r=t;e?r.style.border="2px solid #1e90ff":r.style.border=""}async function B(){const e=E;if(!e)return;const t=e.getSenders().find(r=>r.track&&r.track.kind==="video");if(t){const r=t.track;try{r.stop();const n=c.getVideoTracks()[0];await t.replaceTrack(n),await N(e)}catch(o){console.error("Error updating local video stream:",o),y("Error","Error updating local video stream!"),t&&r&&t.replaceTrack&&await t.replaceTrack(r)}}else console.log("No video sender found.")}function K(){const e=navigator.userAgent;return/iPhone|iPad|iPod/.test(e)&&/Safari/.test(e)&&!/CriOS/.test(e)?"H264":(/Android/.test(e)&&/Chrome/.test(e)||/Firefox/.test(e)||/Edge|Edg/.test(e),"VP8")}function Y(e,t,r="video"){const o=e.split(`\r
`),n=o.findIndex(s=>s.startsWith(`m=${r}`));if(n===-1)return e;const d=new RegExp(`a=rtpmap:(\\d+)\\s${t}`,"i"),m=o.filter(s=>d.test(s)).map(s=>s.match(d)[1]);if(m.length===0)return e;const p=o[n].split(" "),i=m.concat(p.slice(3).filter(s=>!m.includes(s)));return o[n]=[...p.slice(0,3),...i].join(" "),o.join(`\r
`)}async function N(e){const t=await e.createOffer(),r=K(),o=Y(t.sdp,r);return await e.setLocalDescription({type:t.type,sdp:o}),console.log("Preferred codec:",r),console.log("Modified SDP:",o),t}function _(){return/iphone|ipod|ipad/i.test(navigator.userAgent)?(console.log("Screen sharing is not supported on iOS devices via web apps. Please use a native app or WebView."),L.setAttribute("disabled","true"),!1):"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices?(console.log("Screen sharing is supported on this platform."),!0):(console.log("Screen sharing is not supported on this platform."),L.setAttribute("disabled","true"),!1)}_();const Q=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let f=null;const X=document.querySelector("#muteVideo"),Z=document.querySelector("#muteAudio");document.querySelector("#audioOutputSelect").addEventListener("change",e=>{const t=audioOutputSelect.value,r=document.querySelectorAll("video[isRemote]");try{r.forEach(async o=>{await o.setSinkId(t)}),console.log(`Audio output set to device: ${t}`)}catch(o){console.error("Error setting audio output device:",o)}});navigator.mediaDevices.addEventListener("devicechange",()=>{P()});async function P(){try{const t=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="audiooutput"||r.label.includes("headset"));t.length>0&&t.forEach(r=>{if(audioOutputSelect.querySelector(`option[value="${r.deviceId}"]`))return;const o=document.createElement("option");o.value=r.deviceId,o.text=r.label||r.kind||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(o)})}catch(e){console.error("Error fetching audio output devices:",e)}}document.querySelector("#controls").addEventListener("click",async e=>{const t=e.target;switch(e.target.id){case"start":t.disabled=!0,await ee(),t.disabled=!1;break;case"muteAudio":t.textContent="🔇 "+(f.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio"),f.getAudioTracks()[0].enabled=!f.getAudioTracks()[0].enabled;break;case"muteVideo":t.textContent="🎥 "+(f.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video"),f.getVideoTracks()[0].enabled=!f.getVideoTracks()[0].enabled;break;case"switchCamera":await G();break;case"audioOutputRefresh":P();break;case"hangup":X.textContent="🎥 Mute Video",Z.textContent="🔇 Mute Audio",f&&(f.getTracks().forEach(o=>{o.enabled=!1}),setTimeout(()=>{f.getTracks().forEach(o=>o.stop()),f=null,l.publish({room:Object.keys(l.rooms)[0],message:{type:"leave",from:l.clientId}}),document.querySelector(".Channel").innerHTML="",E&&E.getSenders().forEach(o=>{o.track&&o.track.stop()})},300));break}});async function ee(){if(f=await z(),R(f,"localVideo",!0),l){l.publish({room:Object.keys(l.rooms)[0],message:{type:"join",from:l.clientId}});return}H(f,(e,t)=>{document.getElementById(t)||R(e,t)})}P();Q||(document.querySelector("#switchCamera").style.display="none");let A;const C=document.getElementById("install-btn");window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),A=e,C.style.display="flex",setTimeout(()=>{C.style.display="none",y("Info","You can add this app to your home screen!")},15e3),C.addEventListener("click",()=>{A.prompt(),A.userChoice.then(t=>{t.outcome==="accepted"?console.log("User accepted the A2HS prompt"):console.log("User dismissed the A2HS prompt"),A=null})})});window.matchMedia("(display-mode: standalone)").matches&&(C.style.display="none");
