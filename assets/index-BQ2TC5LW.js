(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const d of n)if(d.type==="childList")for(const f of d.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&o(f)}).observe(document,{childList:!0,subtree:!0});function r(n){const d={};return n.integrity&&(d.integrity=n.integrity),n.referrerPolicy&&(d.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?d.credentials="include":n.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function o(n){if(n.ep)return;n.ep=!0;const d=r(n);fetch(n.href,d)}})();function N(e,t,r){const o=new window.Scaledrone("EoIG3R1I4JdyS4L1"),n=o.subscribe(e);return o.on("open",t),n.on("message",r),{drone:o,room:n}}const g={};let A,w=null,l=null,V=null;const R=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],x={iceServers:R};function j(e,t){A=e;const r="observable-e7b2d4",{drone:o,room:n}=N(r,d,f);l=o,V=n;function d(c){if(c)return console.error(c);console.log("Connected to Scaledrone")}function f(c){const{data:s,member:E}=c,a=E.id;if(a!==l.clientId)switch(s.type){case"offer":h(a,!1,t),g[a].setRemoteDescription(new RTCSessionDescription(s.offer)),g[a].createAnswer().then(p=>{g[a].setLocalDescription(p),l.publish({room:r,message:{type:"answer",answer:p,to:a}})});break;case"answer":s.to===l.clientId&&g[a]&&g[a].setRemoteDescription(new RTCSessionDescription(s.answer));break;case"candidate":s.to===l.clientId&&g[a]&&g[a].addIceCandidate(new RTCIceCandidate(s.candidate));break;case"leave":const u=document.getElementById(a);u&&u.remove(),g[a]&&(g[a].close(),delete g[a]);break;case"join":h(a,!0,t);break;case"screenShare":{const p=document.getElementById(a);p&&(s.isShared===!0?p.setAttribute("screenShare","true"):p.removeAttribute("screenShare"))}break;default:console.warn("Unknown data type:",s.type)}}V.on("members",c=>{c.forEach(s=>{s.id!==l.clientId&&h(s.id,!0,t)})});async function h(c,s,E){const a=w=new RTCPeerConnection(x);if(a.onicecandidate=u=>{u.candidate?(console.log("New ICE Candidate:",u.candidate),l.publish({room:r,message:{type:"candidate",candidate:u.candidate,to:c}})):console.log("All ICE candidates have been gathered.")},a.oniceconnectionstatechange=()=>{var u,p,I;console.log("ICE connection state changed:",a.iceConnectionState),a.iceConnectionState==="failed"?(console.warn("ICE Connection failed. Likely need TURN."),(u=document.getElementById(c))==null||u.remove()):a.iceConnectionState==="disconnected"?(console.warn("ICE Connection disconnected. Could be a network issue."),(p=document.getElementById(c))==null||p.remove()):a.iceConnectionState==="closed"&&(console.warn("ICE Connection closed."),(I=document.getElementById(c))==null||I.remove())},a.onconnectionstatechange=()=>{console.log("PeerConnection state:",a.connectionState)},a.onnegotiationneeded=()=>{console.log("Negotiation needed")},a.onsignalingstatechange=()=>{console.log("Signaling state changed:",a.signalingState)},a.ontrack=u=>{console.log("Track received:",u.track.kind),E(u.streams[0],c)},A.getTracks().forEach(u=>a.addTrack(u,A)),s){const u=await q(a);l.publish({room:r,message:{type:"offer",offer:u,to:c}})}g[c]=a}}let S=0,b=0,i=null,y=0,T="user";const k=document.querySelector("#quality"),C=document.querySelector("#framerate"),B=document.querySelector("#shareScreen"),O=document.querySelector("#muteVideo"),P=document.querySelector("#switchCamera");k.addEventListener("change",async e=>{if(!i)return;const[t,r]=e.target.value.split("x").map(Number);await v(t,r,y)});C.addEventListener("change",async e=>{if(!i)return;const t=Number(e.target.value);await v(S,b,t)});B.addEventListener("click",async e=>{const t=document.querySelector("#localVideo");if(e.target.setAttribute("disabled","true"),e.target.getAttribute("isShared")==="true"){e.target.textContent="Share Screen",e.target.setAttribute("isShared","false"),O.removeAttribute("disabled"),k.removeAttribute("disabled"),C.removeAttribute("disabled"),P.removeAttribute("disabled"),e.target.removeAttribute("disabled"),t.removeAttribute("screenShare"),await v(S,b,y),l.publish({room:ROOM_NAME,message:{type:"screenShare",from:l.clientId,isShared:!1}});return}if(i)try{const r=await navigator.mediaDevices.getDisplayMedia({video:{cursor:"always"},audio:!1});e.target.textContent="Stop Sharing",e.target.setAttribute("isShared","true"),O.setAttribute("disabled","true"),k.setAttribute("disabled","true"),C.setAttribute("disabled","true"),P.setAttribute("disabled","true"),t.setAttribute("screenShare","true"),i&&(i.getVideoTracks()[0].stop(),i.removeTrack(i.getVideoTracks()[0]));const o=r.getVideoTracks()[0];i.addTrack(o),await L(),l.publish({room:ROOM_NAME,message:{type:"screenShare",from:l.clientId,isShared:!0}})}catch(r){console.error("Error starting screen share:",r)}finally{e.target.removeAttribute("disabled")}});async function $(e,t,r,o){i&&(i.getVideoTracks()[0].stop(),i.removeTrack(i.getVideoTracks()[0]));try{const n={video:{width:{ideal:e},height:{ideal:t},frameRate:{ideal:r},facingMode:{ideal:o}},audio:!i};return await navigator.mediaDevices.getUserMedia(n)}catch(n){return console.error("Failed to get media stream:",n),null}}async function v(e,t,r,o=!1,n=!1){b=t,S=e,y=r;const d=n&&i.getVideoTracks()[0].getSettings().facingMode||"user";T=n?d==="user"?"environment":"user":T;const f=await $(S,b,y,T);if(!f)return!1;const h=f.getVideoTracks()[0];if(i){const c=i.getVideoTracks()[0];c&&(c.stop(),i.removeTrack(c)),i.addTrack(h)}else i=f;if(o){const c=document.querySelector("#localVideo");c.setAttribute("mode",i.getVideoTracks()[0].getSettings().facingMode||"user"),c.srcObject=i}return await L(),!0}function U(){v(S,b,y,!0,!0)}async function F(){const[e,t]=k.value.split("x").map(Number),r=Number(C.value);return await v(e,t,r),i}function M(e,t,r=!1){const o=document.createElement("video");o.srcObject=e,o.id=t,o.autoplay=!0,o.playsInline=!0,r?(o.muted=!0,document.getElementsByClassName("Channel")[0].appendChild(o),o.setAttribute("mode",i.getVideoTracks()[0].getSettings().facingMode||"user")):(document.getElementsByClassName("Channel")[0].prepend(o),_(e,o))}function _(e,t){const r=new AudioContext,o=r.createMediaStreamSource(e),n=r.createGain();n.gain.value=3,o.connect(n).connect(r.destination),t.srcObject=e,t.volume=0}async function L(){const e=w;if(!e)return;const t=e.getSenders().find(r=>r.track&&r.track.kind==="video");if(t){const r=t.track;try{r.stop();const n=i.getVideoTracks()[0];await t.replaceTrack(n),await q(e)}catch(o){console.error("Error updating local video stream:",o),t&&r&&t.replaceTrack&&await t.replaceTrack(r)}}else console.log("No video sender found.")}function G(){const e=navigator.userAgent;return/iPhone|iPad|iPod/.test(e)&&/Safari/.test(e)&&!/CriOS/.test(e)?"H264":(/Android/.test(e)&&/Chrome/.test(e)||/Firefox/.test(e)||/Edge|Edg/.test(e),"VP8")}function H(e,t,r="video"){const o=e.split(`\r
`),n=o.findIndex(s=>s.startsWith(`m=${r}`));if(n===-1)return e;const d=new RegExp(`a=rtpmap:(\\d+)\\s${t}`,"i"),f=o.filter(s=>d.test(s)).map(s=>s.match(d)[1]);if(f.length===0)return e;const h=o[n].split(" "),c=f.concat(h.slice(3).filter(s=>!f.includes(s)));return o[n]=[...h.slice(0,3),...c].join(" "),o.join(`\r
`)}async function q(e){const t=await e.createOffer(),r=G(),o=H(t.sdp,r);return await e.setLocalDescription({type:t.type,sdp:o}),console.log("Preferred codec:",r),console.log("Modified SDP:",o),t}const W=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let m=null;document.querySelector("#audioOutputSelect").addEventListener("change",e=>{const t=audioOutputSelect.value,r=document.querySelectorAll("video:not(#localVideo)");try{r.forEach(async o=>{await o.setSinkId(t)}),console.log(`Audio output set to device: ${t}`)}catch(o){console.error("Error setting audio output device:",o)}});navigator.mediaDevices.addEventListener("devicechange",()=>{D()});async function D(){const e=document.querySelectorAll("video:not(#localVideo)");for(const t of e)if(typeof t.setSinkId>"u"){console.log("Audio output device selection is not supported on this device.");return}try{const r=(await navigator.mediaDevices.enumerateDevices()).filter(o=>o.kind==="audiooutput");r.length>0&&r.forEach(o=>{if(audioOutputSelect.querySelector(`option[value="${o.deviceId}"]`))return;const n=document.createElement("option");n.value=o.deviceId,n.text=o.label||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(n)})}catch(t){console.error("Error fetching audio output devices:",t)}}document.querySelector("#controls").addEventListener("click",async e=>{const t=e.target;switch(e.target.id){case"start":t.disabled=!0,await J(),t.disabled=!1;break;case"muteAudio":t.textContent=m.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio",m.getAudioTracks()[0].enabled=!m.getAudioTracks()[0].enabled;break;case"muteVideo":t.textContent=m.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video",m.getVideoTracks()[0].enabled=!m.getVideoTracks()[0].enabled;break;case"switchCamera":await U();break;case"hangup":m&&(m.getTracks().forEach(o=>{o.enabled=!1}),setTimeout(()=>{m.getTracks().forEach(o=>o.stop()),m=null,l.publish({room:Object.keys(l.rooms)[0],message:{type:"leave",from:l.clientId}}),document.querySelector(".Channel").innerHTML="",w&&w.getSenders().forEach(o=>{o.track&&o.track.stop()})},300));break}});async function J(){if(m=await F(),M(m,"localVideo",!0),l){l.publish({room:Object.keys(l.rooms)[0],message:{type:"join",from:l.clientId}});return}j(m,(e,t)=>{document.getElementById(t)||M(e,t)})}D();W||(document.querySelector("#switchCamera").style.display="none");
