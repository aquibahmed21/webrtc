(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const d of a.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&n(d)}).observe(document,{childList:!0,subtree:!0});function o(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(r){if(r.ep)return;r.ep=!0;const a=o(r);fetch(r.href,a)}})();let Y=null;"serviceWorker"in navigator&&window.addEventListener("load",async()=>{Y=await navigator.serviceWorker.register("/webrtc/service-worker.js").catch(t=>console.log("ServiceWorker registration failed:",t))});function Z(e,t,o){const n=JSON.parse(window.localStorage.getItem("userInfo")),r="EoIG3R1I4JdyS4L1",a=new ScaleDrone(r,{data:{userInfo:n}}),d=a.subscribe(e);return a.on("open",t),d.on("message",o),{drone:a,room:d}}function m(e,t){const o=document.getElementById("toastContainer"),n=document.createElement("div");n.classList.add("toast",e.toLowerCase()),n.textContent=t,o.innerHTML="",o.appendChild(n),setTimeout(()=>{n.remove()},3e3)}const p=[],x=JSON.parse(window.localStorage.getItem("userInfo")),S={};let j,V=null,f=null,C=null;const ee=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],te={iceServers:ee};function oe(e,t){j=e;const o="observable-e7b2d4",{drone:n,room:r}=Z(o,a,d);f=n,C=r;function a(s){if(s)return console.error(s);console.log("Connected to Scaledrone")}function d(s){const{data:i,member:b}=s,c=b.id;if(c!==f.clientId)switch(i.type){case"offer":y(c,!1,t),S[c].setRemoteDescription(new RTCSessionDescription(i.offer)),S[c].createAnswer().then(g=>{S[c].setLocalDescription(g),f.publish({room:o,message:{type:"answer",answer:g,to:c,userInfo:x}})});break;case"answer":i.to===f.clientId&&S[c]&&S[c].setRemoteDescription(new RTCSessionDescription(i.answer));break;case"candidate":i.to===f.clientId&&S[c]&&S[c].addIceCandidate(new RTCIceCandidate(i.candidate));break;case"leave":console.log(c,"has left the room");const u=p.findIndex(g=>b.id===g.id),v=document.getElementById(c);v&&(v.remove(),u>-1&&m("Info",p[u].clientData.userInfo.nickname+" has left the room!")),p.splice(u,1),S[c]&&(S[c].close(),delete S[c]);break;case"join":p.push(b),console.log(c,"has joined the room"),y(c,!0,t);break;case"screenShare":{const g=document.getElementById(c);g&&(i.isShared===!0?g.setAttribute("screenShare","true"):g.removeAttribute("screenShare"))}break;default:console.warn("Unknown data type:",i.type),m("Warning","Unknown data type: "+i.type)}}C.on("members",s=>{console.log("Members connected:",s),s.forEach(i=>{i.id!==f.clientId&&(p.push(i),y(i.id,!0,t))})}),C.on("member_join",s=>{var i;p.push(s),console.log("Member joined:",(i=s.clientData)==null?void 0:i.userInfo.nickname),y(s.id,!1,t)}),C.on("member_leave",s=>{var c;const i=p.findIndex(u=>u.id===s.id);console.log("Member left:",(c=p[i].clientData)==null?void 0:c.userInfo.nickname);const b=document.getElementById(s.id);b&&(b.remove(),i>-1&&m("Info",p[i].clientData.userInfo.nickname+" has left the room!")),p.splice(i,1)});async function y(s,i,b){const c=V=new RTCPeerConnection(te);if(c.onicecandidate=u=>{u.candidate&&f.publish({room:o,message:{type:"candidate",candidate:u.candidate,to:s,userInfo:x}})},c.oniceconnectionstatechange=()=>{var u,v,g;c.iceConnectionState==="failed"?((u=document.getElementById(s))==null||u.remove(),m("Error","Connection failed. User is not connected!")):c.iceConnectionState==="disconnected"?((v=document.getElementById(s))==null||v.remove(),m("Error","Connection disconnected. Could be a network issue!")):c.iceConnectionState==="closed"&&((g=document.getElementById(s))==null||g.remove(),m("Info","User has left the room!"))},c.onconnectionstatechange=()=>{},c.onnegotiationneeded=()=>{},c.onsignalingstatechange=()=>{},c.ontrack=u=>{var g,J;b(u.streams[0],s,(J=(g=p.find(P=>P.id===s).clientData)==null?void 0:g.userInfo)==null?void 0:J.nickname);const v=p.findIndex(P=>P.id===s);v>-1&&m("Info",p[v].clientData.userInfo.nickname+" has joined the room!")},j.getTracks().forEach(u=>c.addTrack(u,j)),i){const u=await G(c);f.publish({room:o,message:{type:"offer",offer:u,to:s,userInfo:x}})}S[s]=c}}const R=JSON.parse(window.localStorage.getItem("userInfo"));let k=0,I=0,l=null,A=0,U="user";const q=document.querySelector("#quality"),L=document.querySelector("#framerate"),B=document.querySelector("#shareScreen"),H=document.querySelector("#muteVideo"),$=document.querySelector("#switchCamera");q.addEventListener("change",async e=>{if(!l)return;const[t,o]=e.target.value.split("x").map(Number);await E(t,o,A)});L.addEventListener("change",async e=>{if(!l)return;const t=Number(e.target.value);await E(k,I,t)});B.addEventListener("click",async e=>{const t=document.querySelector("#localVideo");if(e.target.setAttribute("disabled","true"),e.target.getAttribute("isShared")==="true"){e.target.textContent="üñ•Ô∏è Share Screen",e.target.setAttribute("isShared","false"),H.removeAttribute("disabled"),q.removeAttribute("disabled"),L.removeAttribute("disabled"),$.removeAttribute("disabled"),e.target.removeAttribute("disabled"),t.removeAttribute("screenShare"),await E(k,I,A),f.publish({room:Object.keys(f.rooms)[0],message:{type:"screenShare",from:f.clientId,isShared:!1,userInfo:R}});return}if(l)try{const o=await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:"screen"}});e.target.textContent="üñ•Ô∏è Stop Sharing",e.target.setAttribute("isShared","true"),H.setAttribute("disabled","true"),q.setAttribute("disabled","true"),L.setAttribute("disabled","true"),$.setAttribute("disabled","true"),t.setAttribute("screenShare","true"),l&&(l.getVideoTracks()[0].stop(),l.removeTrack(l.getVideoTracks()[0]));const n=o.getVideoTracks()[0];l.addTrack(n),await z(),f.publish({room:Object.keys(f.rooms)[0],message:{type:"screenShare",from:f.clientId,isShared:!0,userInfo:R}})}catch(o){console.error("Error starting screen share:",o)}finally{e.target.removeAttribute("disabled")}});async function ne(e,t,o,n){l&&(l.getVideoTracks()[0].stop(),l.removeTrack(l.getVideoTracks()[0]));try{const r={video:{width:{ideal:e},height:{ideal:t},frameRate:{ideal:o},facingMode:{ideal:n}},audio:!l};return await navigator.mediaDevices.getUserMedia(r)}catch(r){return console.error("Failed to get media stream:",r),m("Error","Failed to get media stream!"),null}}async function E(e,t,o,n=!1,r=!1){I=t,k=e,A=o;const a=r&&l.getVideoTracks()[0].getSettings().facingMode||"user";U=r?a==="user"?"environment":"user":U;const d=await ne(k,I,A,U);if(!d)return!1;const y=d.getVideoTracks()[0];if(l){const s=l.getVideoTracks()[0];s&&(s.stop(),l.removeTrack(s)),l.addTrack(y)}else l=d;if(n){const s=document.querySelector("#localVideo");s.setAttribute("mode",l.getVideoTracks()[0].getSettings().facingMode||"user"),s.srcObject=l}return await z(),!0}function re(){E(k,I,A,!0,!0)}async function ae(){const[e,t]=q.value.split("x").map(Number),o=Number(L.value);return await E(e,t,o),l}function W(e,t,o=!1,n=""){const r=document.createElement("div");r.className="participant",r.setAttribute("data-id",t),r.innerHTML=`<video autoplay playsinline></video>
    <div class="overlay">
      <span class="name">${n}</span>
      <div class="controls">
        <button class="muteAudio">üîá</button>
        <button class="muteVideo">üé•</button>
        <button class="switchCamera">üîÑ</button>
        <button class="hangup">üìû</button>
      </div>
    </div>
  </div>`;const a=r.querySelector("video");a.srcObject=e,a.id=t,a.autoplay=!0,a.playsInline=!0,a.setAttribute("memberId",t),o?(a.muted=!0,document.getElementsByClassName("Channel")[0].appendChild(r),a.setAttribute("mode",l.getVideoTracks()[0].getSettings().facingMode||"user")):(a.setAttribute("isRemote","true"),document.getElementsByClassName("Channel")[0].prepend(r),se(e,a))}function se(e,t){const n=new AudioContext,r=n.createMediaStreamSource(e),a=n.createGain();a.gain.value=2.5;const d=n.createAnalyser();d.fftSize=256;const y=d.frequencyBinCount,s=new Uint8Array(y);r.connect(d),r.connect(a).connect(n.destination),t.srcObject=e,t.volume=0;let i=!1;setInterval(()=>{d.getByteFrequencyData(s);let b=0;for(let u=0;u<s.length;u++)b+=s[u];b/s.length>20?i||(i=!0,F(!0,t)):i&&(i=!1,F(!1,t))},100)}function F(e,t){const o=t;e?o.style.border="2px solid #1e90ff":o.style.border=""}async function z(){const e=V;if(!e)return;const t=e.getSenders().find(o=>o.track&&o.track.kind==="video");if(t){const o=t.track;try{o.stop();const r=l.getVideoTracks()[0];await t.replaceTrack(r),await G(e)}catch(n){console.error("Error updating local video stream:",n),m("Error","Error updating local video stream!"),t&&o&&t.replaceTrack&&await t.replaceTrack(o)}}else console.log("No video sender found.")}function ie(){const e=navigator.userAgent;return/iPhone|iPad|iPod/.test(e)&&/Safari/.test(e)&&!/CriOS/.test(e)?"H264":(/Android/.test(e)&&/Chrome/.test(e)||/Firefox/.test(e)||/Edge|Edg/.test(e),"VP8")}function ce(e,t,o="video"){const n=e.split(`\r
`),r=n.findIndex(i=>i.startsWith(`m=${o}`));if(r===-1)return e;const a=new RegExp(`a=rtpmap:(\\d+)\\s${t}`,"i"),d=n.filter(i=>a.test(i)).map(i=>i.match(a)[1]);if(d.length===0)return e;const y=n[r].split(" "),s=d.concat(y.slice(3).filter(i=>!d.includes(i)));return n[r]=[...y.slice(0,3),...s].join(" "),n.join(`\r
`)}async function G(e){const t=await e.createOffer(),o=ie(),n=ce(t.sdp,o);return await e.setLocalDescription({type:t.type,sdp:n}),console.log("Preferred codec:",o),t}function de(){return/iphone|ipod|ipad/i.test(navigator.userAgent)?(console.log("Screen sharing is not supported on iOS devices via web apps. Please use a native app or WebView."),B.setAttribute("disabled","true"),!1):"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices?(console.log("Screen sharing is supported on this platform."),!0):(console.log("Screen sharing is not supported on this platform."),B.setAttribute("disabled","true"),!1)}de();function le(e){const t="=".repeat((4-e.length%4)%4),o=(e+t).replace(/\-/g,"+").replace(/_/g,"/"),n=atob(o),r=new Uint8Array(n.length);for(let a=0;a<n.length;++a)r[a]=n.charCodeAt(a);return r}const Q=/iphone|ipod|ipad/i.test(navigator.userAgent),ue=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let h=null;const fe=document.querySelector("#muteVideo"),me=document.querySelector("#muteAudio"),M=document.querySelector("#userInfoModal"),K=window.location.hostname==="localhost"?"http://localhost:3000/":"https://web-push-3zaz.onrender.com/",X=document.querySelector("#push");X.addEventListener("click",async e=>{const t=await fetch(K+"vapid").catch(d=>console.log(d));if(!t)return;const{publicKey:o}=await t.json();if(await Notification.requestPermission()!=="granted"){m("Error","Unable to subscribe to push notifications");return}const r=await Y.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:le(o)}),a={endpoint:r.toJSON().endpoint,expirationTime:r.toJSON().expirationTime,keys:{p256dh:r.toJSON().keys.p256dh,auth:r.toJSON().keys.auth,id:JSON.parse(window.localStorage.getItem("userInfo")).id}};await fetch(K+"subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(d=>{d.status===200?m("Success","Push notifications subscribed successfully"):m("Error","Unable to subscribe to push notifications")}).catch(d=>{console.log(d),m("Error","Unable to subscribe to push notifications")})},!1);Notification.permission==="granted"&&(X.style.display="none");let w=window.localStorage.getItem("userInfo");if(!w)D();else{w=JSON.parse(w);const{nickname:e,gender:t,status:o,age:n}=w;(!e||!t||!o||!n)&&D()}document.querySelector("#audioOutputSelect").addEventListener("change",e=>{const t=audioOutputSelect.value,o=document.querySelectorAll("video[isRemote]");try{o.forEach(async n=>{await n.setSinkId(t)}),console.log(`Audio output set to device: ${t}`)}catch(n){console.error("Error setting audio output device:",n)}});navigator.mediaDevices.addEventListener("devicechange",()=>{N()});async function N(){try{const t=(await navigator.mediaDevices.enumerateDevices()).filter(o=>o.kind==="audiooutput"||o.label.includes("headset"));t.length>0&&t.forEach(o=>{if(audioOutputSelect.querySelector(`option[value="${o.deviceId}"]`))return;const n=document.createElement("option");n.value=o.deviceId,n.text=o.label||o.kind||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(n)})}catch(e){console.error("Error fetching audio output devices:",e)}}document.querySelector("#controls").addEventListener("click",async e=>{const t=e.target;switch(e.target.id){case"start":t.disabled=!0,await ge(),t.disabled=!1;break;case"muteAudio":t.textContent="üîá "+(h.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio"),h.getAudioTracks()[0].enabled=!h.getAudioTracks()[0].enabled;break;case"muteVideo":t.textContent="üé• "+(h.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video"),h.getVideoTracks()[0].enabled=!h.getVideoTracks()[0].enabled;break;case"switchCamera":await re();break;case"audioOutputRefresh":N();break;case"hangup":fe.textContent="üé• Mute Video",me.textContent="üîá Mute Audio",h&&(h.getTracks().forEach(n=>{n.enabled=!1}),setTimeout(()=>{h.getTracks().forEach(n=>n.stop()),h=null,f.publish({room:Object.keys(f.rooms)[0],message:{type:"leave",from:f.clientId,userInfo:w}}),document.querySelector(".Channel").innerHTML="",V&&V.getSenders().forEach(n=>{n.track&&n.track.stop()})},300));break}});async function ge(){if(h=await ae(),W(h,"localVideo",!0,"You"),Q||N(),f){f.publish({room:Object.keys(f.rooms)[0],message:{type:"join",from:f.clientId,userInfo:w}});return}oe(h,(e,t,o)=>{document.getElementById(t)||W(e,t,!1,o)})}Q||N();ue||(document.querySelector("#switchCamera").style.display="none");let T;const O=document.getElementById("install-btn");window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),T=e,O.style.display="flex",setTimeout(()=>{O.style.display="none",m("Info","You can add this app to your home screen!")},15e3),O.addEventListener("click",()=>{T.prompt(),T.userChoice.then(t=>{t.outcome==="accepted"?console.log("User accepted the A2HS prompt"):console.log("User dismissed the A2HS prompt"),T=null})})});window.matchMedia("(display-mode: standalone)").matches&&(O.style.display="none");M.addEventListener("click",e=>{if(e.target===M||e.target.id==="closeModal")_();else if(e.target.id==="submit-btn"){e.stopPropagation();const t=document.querySelector("#nickname").value,o=document.querySelector("#gender").value,n=document.querySelector("#status").value,r=document.querySelector("#age").value;if(!t||!o||!n||!r){m("Error","Please fill all the fields!");return}w={nickname:t,gender:o,status:n,age:r,id:new Date().getTime()},window.localStorage.setItem("userInfo",JSON.stringify(w)),_()}});function D(){M.classList.add("show-modal");const e=window.localStorage.getItem("userInfo"),t=document.querySelector("h4");e?(document.querySelector("#nickname").value=JSON.parse(e).nickname,document.querySelector("#gender").value=JSON.parse(e).gender,document.querySelector("#status").value=JSON.parse(e).status,document.querySelector("#age").value=JSON.parse(e).age,t.innerHTML="Video Conferencing with KiteCite"):(document.querySelector("#start").setAttribute("disabled",!0),t.innerHTML="Dear Anonymous User, Please Enter Your Details")}function _(){const e=window.localStorage.getItem("userInfo"),t=document.querySelector("h4");M.classList.remove("show-modal"),e?(document.querySelector("#nickname").value="",document.querySelector("#gender").value="",document.querySelector("#status").value="",document.querySelector("#age").value="",t.innerHTML="Video Conferencing with KiteCite",document.querySelector("#start").removeAttribute("disabled"),t.removeEventListener("click",D)):(document.querySelector("#start").setAttribute("disabled",!0),t.innerHTML="Dear Anonymous User, Please Enter Your Details By Clicking Here",t.addEventListener("click",D))}
