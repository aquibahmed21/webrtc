(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}})();let H=null;"serviceWorker"in navigator&&window.addEventListener("load",async()=>{H=await navigator.serviceWorker.register("/webrtc/service-worker.js").catch(t=>console.log("ServiceWorker registration failed:",t))});function Z(e,t,n){const o=JSON.parse(window.localStorage.getItem("userInfo")),r="EoIG3R1I4JdyS4L1",a=new ScaleDrone(r,{data:{userInfo:o}}),l=a.subscribe(e);return a.on("open",t),l.on("message",n),{drone:a,room:l}}function m(e,t){const n=document.getElementById("toastContainer"),o=document.createElement("div");o.classList.add("toast",e.toLowerCase()),o.textContent=t,n.innerHTML="",n.appendChild(o),setTimeout(()=>{o.remove()},3e3)}const g=[],J=JSON.parse(window.localStorage.getItem("userInfo")),S={};let U,L=null,f=null,q=null;const ee=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],te={iceServers:ee};function oe(e,t){U=e;const n="observable-e7b2d4",{drone:o,room:r}=Z(n,a,l);f=o,q=r;function a(i){if(i)return console.error(i);console.log("Connected to Scaledrone")}function l(i){const{data:s,member:b}=i,c=b.id;if(c!==f.clientId)switch(s.type){case"offer":y(c,!1,t),S[c].setRemoteDescription(new RTCSessionDescription(s.offer)),S[c].createAnswer().then(p=>{S[c].setLocalDescription(p),f.publish({room:n,message:{type:"answer",answer:p,to:c,userInfo:J}})});break;case"answer":s.to===f.clientId&&S[c]&&S[c].setRemoteDescription(new RTCSessionDescription(s.answer));break;case"candidate":s.to===f.clientId&&S[c]&&S[c].addIceCandidate(new RTCIceCandidate(s.candidate));break;case"leave":console.log(c,"has left the room");const u=g.findIndex(p=>b.id===p.id),v=document.getElementById(c);v&&(v.remove(),u>-1&&m("Info",g[u].clientData.userInfo.nickname+" has left the room!")),g.splice(u,1),S[c]&&(S[c].close(),delete S[c]);break;case"join":g.push(b),console.log(c,"has joined the room"),y(c,!0,t);break;case"screenShare":{const p=document.getElementById(c);p&&(s.isShared===!0?p.setAttribute("screenShare","true"):p.removeAttribute("screenShare"))}break;default:console.warn("Unknown data type:",s.type),m("Warning","Unknown data type: "+s.type)}}q.on("members",i=>{console.log("Members connected:",i),i.forEach(s=>{s.id!==f.clientId&&(g.push(s),y(s.id,!0,t))})}),q.on("member_join",i=>{var s;g.push(i),console.log("Member joined:",(s=i.clientData)==null?void 0:s.userInfo.nickname),y(i.id,!1,t)}),q.on("member_leave",i=>{var c;const s=g.findIndex(u=>u.id===i.id);console.log("Member left:",(c=g[s].clientData)==null?void 0:c.userInfo.nickname);const b=document.getElementById(i.id);b&&(b.remove(),s>-1&&m("Info",g[s].clientData.userInfo.nickname+" has left the room!")),g.splice(s,1)});async function y(i,s,b){const c=L=new RTCPeerConnection(te);if(c.onicecandidate=u=>{u.candidate&&f.publish({room:n,message:{type:"candidate",candidate:u.candidate,to:i,userInfo:J}})},c.oniceconnectionstatechange=()=>{var u,v,p;c.iceConnectionState==="failed"?((u=document.getElementById(i))==null||u.remove(),m("Error","Connection failed. User is not connected!")):c.iceConnectionState==="disconnected"?((v=document.getElementById(i))==null||v.remove(),m("Error","Connection disconnected. Could be a network issue!")):c.iceConnectionState==="closed"&&((p=document.getElementById(i))==null||p.remove(),m("Info","User has left the room!"))},c.onconnectionstatechange=()=>{},c.onnegotiationneeded=()=>{},c.onsignalingstatechange=()=>{},c.ontrack=u=>{var p,$;b(u.streams[0],i,($=(p=g.find(j=>j.id===i).clientData)==null?void 0:p.userInfo)==null?void 0:$.nickname);const v=g.findIndex(j=>j.id===i);v>-1&&m("Info",g[v].clientData.userInfo.nickname+" has joined the room!")},U.getTracks().forEach(u=>c.addTrack(u,U)),s){const u=await Q(c);f.publish({room:n,message:{type:"offer",offer:u,to:i,userInfo:J}})}S[i]=c}}const W=JSON.parse(window.localStorage.getItem("userInfo"));let I=0,E=0,d=null,A=0,B="user";const C=document.querySelector("#quality"),T=document.querySelector("#framerate"),R=document.querySelector("#shareScreen"),F=document.querySelector("#muteVideo"),K=document.querySelector("#switchCamera");C.addEventListener("click",async e=>{if(e.target.tagName!=="INPUT"||!d)return;const t=C.querySelector("input:checked").value,[n,o]=t.split("x").map(Number);await O(n,o,A)});T.addEventListener("click",async e=>{if(e.target.tagName!=="INPUT"||!d)return;const t=T.querySelector("input:checked").value,n=Number(t);await O(I,E,n)});R.addEventListener("click",async e=>{const t=document.querySelector("#localVideo");if(e.target.setAttribute("disabled","true"),e.target.getAttribute("isShared")==="true"){e.target.textContent="ðŸ–¥ï¸ Share Screen",e.target.setAttribute("isShared","false"),F.removeAttribute("disabled"),C.removeAttribute("disabled"),T.removeAttribute("disabled"),K.removeAttribute("disabled"),e.target.removeAttribute("disabled"),t.removeAttribute("screenShare"),await O(I,E,A),f.publish({room:Object.keys(f.rooms)[0],message:{type:"screenShare",from:f.clientId,isShared:!1,userInfo:W}});return}if(d)try{const n=await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:"screen"}});e.target.textContent="ðŸ–¥ï¸ Stop Sharing",e.target.setAttribute("isShared","true"),F.setAttribute("disabled","true"),C.setAttribute("disabled","true"),T.setAttribute("disabled","true"),K.setAttribute("disabled","true"),t.setAttribute("screenShare","true"),d&&(d.getVideoTracks()[0].stop(),d.removeTrack(d.getVideoTracks()[0]));const o=n.getVideoTracks()[0];d.addTrack(o),await G(),f.publish({room:Object.keys(f.rooms)[0],message:{type:"screenShare",from:f.clientId,isShared:!0,userInfo:W}})}catch(n){console.error("Error starting screen share:",n)}finally{e.target.removeAttribute("disabled")}});async function ne(e,t,n,o){d&&d.getVideoTracks().forEach(r=>{d.removeTrack(r),r.stop()});try{const r={video:{width:{ideal:e},height:{ideal:t},frameRate:{ideal:n},facingMode:{ideal:o}},audio:!d};return await navigator.mediaDevices.getUserMedia(r)}catch(r){return console.error("Failed to get media stream:",r),m("Error","Failed to get media stream!"),null}}async function O(e,t,n,o=!1,r=!1){E=t,I=e,A=n;const a=r&&d.getVideoTracks()[0].getSettings().facingMode||"user";B=r?a==="user"?"environment":"user":B;const l=await ne(I,E,A,B);if(!l)return!1;const y=l.getVideoTracks()[0];if(d){const i=d.getVideoTracks()[0];i&&(i.stop(),d.removeTrack(i)),d.addTrack(y)}else d=l;if(o){const i=document.querySelector("#localVideo");i.setAttribute("mode",d.getVideoTracks()[0].getSettings().facingMode||"user"),i.srcObject=d}return await G(),!0}function re(){O(I,E,A,!0,!0)}async function ae(){const e=C.querySelector("input:checked").value,[t,n]=e.split("x").map(Number),o=T.querySelector("input:checked"),r=Number(o.value);return await O(t,n,r),d}function _(e,t,n=!1,o=""){const r=document.createElement("div");r.className="participant",r.setAttribute("data-id",t),r.innerHTML=`<video autoplay playsinline></video>
    <div class="overlay">
      <span class="name">${o}</span>
      <div class="controls">
        <button class="muteAudio">ðŸ”‡</button>
        <button class="muteVideo">ðŸŽ¥</button>
        <button class="switchCamera">ðŸ”„</button>
        <button class="hangup">ðŸ“ž</button>
      </div>
    </div>
  </div>`;const a=r.querySelector("video");a.srcObject=e,a.id=t,a.autoplay=!0,a.playsInline=!0,a.setAttribute("memberId",t),n?(a.muted=!0,document.getElementsByClassName("Channel")[0].appendChild(r),a.setAttribute("mode",d.getVideoTracks()[0].getSettings().facingMode||"user"),a.click()):(a.setAttribute("isRemote","true"),document.getElementsByClassName("Channel")[0].prepend(r),ie(e,a))}function ie(e,t){const o=new AudioContext,r=o.createMediaStreamSource(e),a=o.createGain();a.gain.value=2.5;const l=o.createAnalyser();l.fftSize=256;const y=l.frequencyBinCount,i=new Uint8Array(y);r.connect(l),r.connect(a).connect(o.destination),t.srcObject=e,t.volume=0;let s=!1;setInterval(()=>{l.getByteFrequencyData(i);let b=0;for(let u=0;u<i.length;u++)b+=i[u];b/i.length>20?s||(s=!0,Y(!0,t)):s&&(s=!1,Y(!1,t))},100)}function Y(e,t){const n=t;e?n.style.border="2px solid #1e90ff":n.style.border=""}async function G(){const e=L;if(!e)return;const t=e.getSenders().find(n=>n.track&&n.track.kind==="video");if(t){const n=t.track;try{n.stop();const r=d.getVideoTracks()[0];await t.replaceTrack(r),await Q(e)}catch(o){console.error("Error updating local video stream:",o),m("Error","Error updating local video stream!"),t&&n&&t.replaceTrack&&await t.replaceTrack(n)}}else console.log("No video sender found.")}function se(){const e=navigator.userAgent;return/iPhone|iPad|iPod/.test(e)&&/Safari/.test(e)&&!/CriOS/.test(e)?"H264":(/Android/.test(e)&&/Chrome/.test(e)||/Firefox/.test(e)||/Edge|Edg/.test(e),"VP8")}function ce(e,t,n="video"){const o=e.split(`\r
`),r=o.findIndex(s=>s.startsWith(`m=${n}`));if(r===-1)return e;const a=new RegExp(`a=rtpmap:(\\d+)\\s${t}`,"i"),l=o.filter(s=>a.test(s)).map(s=>s.match(a)[1]);if(l.length===0)return e;const y=o[r].split(" "),i=l.concat(y.slice(3).filter(s=>!l.includes(s)));return o[r]=[...y.slice(0,3),...i].join(" "),o.join(`\r
`)}async function Q(e){const t=await e.createOffer(),n=se(),o=ce(t.sdp,n);return await e.setLocalDescription({type:t.type,sdp:o}),console.log("Preferred codec:",n),t}function le(){return/iphone|ipod|ipad/i.test(navigator.userAgent)?(console.log("Screen sharing is not supported on iOS devices via web apps. Please use a native app or WebView."),R.setAttribute("disabled","true"),!1):"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices?(console.log("Screen sharing is supported on this platform."),!0):(console.log("Screen sharing is not supported on this platform."),R.setAttribute("disabled","true"),!1)}le();function de(e){const t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/\-/g,"+").replace(/_/g,"/"),o=atob(n),r=new Uint8Array(o.length);for(let a=0;a<o.length;++a)r[a]=o.charCodeAt(a);return r}const X=/iphone|ipod|ipad/i.test(navigator.userAgent),ue=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let h=null;const fe=document.querySelector("#muteVideo"),me=document.querySelector("#muteAudio"),M=document.querySelector("#userInfoModal"),P=window.location.hostname==="localhost"?"http://localhost:3000/":"https://web-push-3zaz.onrender.com/",k=document.querySelector("#push");function pe(e,t){var o;const n=((o=JSON.parse(window.localStorage.getItem("userInfo")))==null?void 0:o.id)||0;fetch(P+"notifyAll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({initiator:n,title:e,body:t})})}async function ge(){if(!JSON.parse(window.localStorage.getItem("userInfo")))return!1;if(Notification.permission==="granted"){const t=localStorage.getItem("subscription");if(!t){const r=await H.pushManager.getSubscription();return r&&(await r.unsubscribe(),m("Info","Notification unsubscribed locally!, Please resubscribe.")),!1}return(await(await fetch(P+"isPushSubscribed",{method:"POST",headers:{"Content-Type":"application/json"},body:t})).json()).isSubscribed}}k.addEventListener("click",async e=>{const t=await fetch(P+"vapid").catch(l=>console.log(l));if(!t)return;const{publicKey:n}=await t.json();if(k.setAttribute("disabled","true"),await Notification.requestPermission()!=="granted"){m("Error","Unable to subscribe to push notifications"),k.setAttribute("disabled","false");return}const r=await H.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:de(n)}),a={endpoint:r.toJSON().endpoint,expirationTime:r.toJSON().expirationTime,keys:{p256dh:r.toJSON().keys.p256dh,auth:r.toJSON().keys.auth,id:JSON.parse(window.localStorage.getItem("userInfo")).id}};localStorage.setItem("subscription",JSON.stringify(r)),await fetch(P+"subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)}).then(l=>{l.status===200?m("Success","Push notifications subscribed successfully"):m("Error","Unable to subscribe to push notifications")}).catch(l=>{console.log(l),m("Error","Unable to subscribe to push notifications")}),k.style.display="none",m("Success","Push notifications subscribed successfully")},!1);setTimeout(async()=>{const e=await ge();k.style.display=e?"none":""},1e3);let w=window.localStorage.getItem("userInfo");if(!w)D();else{w=JSON.parse(w);const{nickname:e,gender:t,status:n,age:o}=w;(!e||!t)&&D()}document.querySelector("#audioOutputSelect").addEventListener("change",e=>{const t=audioOutputSelect.value,n=document.querySelectorAll("video[isRemote]");try{n.forEach(async o=>{await o.setSinkId(t)}),console.log(`Audio output set to device: ${t}`)}catch(o){console.error("Error setting audio output device:",o)}});navigator.mediaDevices.addEventListener("devicechange",()=>{x()});async function x(){try{const t=(await navigator.mediaDevices.enumerateDevices()).filter(n=>n.kind==="audiooutput"||n.label.includes("headset"));t.length>0&&t.forEach(n=>{if(audioOutputSelect.querySelector(`option[value="${n.deviceId}"]`))return;const o=document.createElement("option");o.value=n.deviceId,o.text=n.label||n.kind||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(o)})}catch(e){console.error("Error fetching audio output devices:",e)}}document.querySelector("#controls").addEventListener("click",async e=>{const t=e.target;switch(e.target.id){case"start":t.disabled=!0,await he(),t.disabled=!1;break;case"muteAudio":t.textContent="ðŸ”‡ "+(h.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio"),h.getAudioTracks()[0].enabled=!h.getAudioTracks()[0].enabled;break;case"muteVideo":t.textContent="ðŸŽ¥ "+(h.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video"),h.getVideoTracks()[0].enabled=!h.getVideoTracks()[0].enabled;break;case"switchCamera":await re();break;case"audioOutputRefresh":x();break;case"hangup":fe.textContent="ðŸŽ¥ Mute Video",me.textContent="ðŸ”‡ Mute Audio",document.querySelector("#localMainVideo").classList.remove("active"),h&&(h.getTracks().forEach(o=>{o.enabled=!1}),setTimeout(()=>{h.getTracks().forEach(o=>o.stop()),h=null,f.publish({room:Object.keys(f.rooms)[0],message:{type:"leave",from:f.clientId,userInfo:w}}),document.querySelector(".Channel").innerHTML="",L&&L.getSenders().forEach(o=>{o.track&&o.track.stop()})},300));break}});document.querySelector(".Channel").addEventListener("click",e=>{if(e.target.tagName!=="VIDEO")return;const t=document.getElementById("localMainVideo");t.srcObject=e.target.srcObject,t.classList.add("active"),t.style.transform=e.target.id==="localVideo"?"scale(-1, 1)":""});document.querySelector("#localMainVideo").addEventListener("dblclick",e=>{e.target.requestFullscreen()});async function he(){var t;const e=((t=JSON.parse(window.localStorage.getItem("userInfo")))==null?void 0:t.nickname)||"No name";if(pe("Video Conferencing with KiteCite","Started by "+e),h=await ae(),_(h,"localVideo",!0,"You"),X||x(),f){f.publish({room:Object.keys(f.rooms)[0],message:{type:"join",from:f.clientId,userInfo:w}});return}oe(h,(n,o,r)=>{document.getElementById(o)||_(n,o,!1,r)})}X||x();ue||(document.querySelector("#switchCamera").style.display="none");let V;const N=document.getElementById("install-btn");window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),V=e,N.style.display="flex",setTimeout(()=>{N.style.display="none",m("Info","You can add this app to your home screen!")},15e3),N.addEventListener("click",()=>{V.prompt(),V.userChoice.then(t=>{t.outcome==="accepted"?console.log("User accepted the A2HS prompt"):console.log("User dismissed the A2HS prompt"),V=null})})});window.matchMedia("(display-mode: standalone)").matches&&(N.style.display="none");M.addEventListener("click",e=>{if(e.target===M||e.target.id==="closeModal")z();else if(e.target.id==="submit-btn"){e.stopPropagation();const t=document.querySelector("#nickname").value,n=document.querySelector(".radio-group").querySelector("input:checked").value,o=document.querySelector("#status").value,r=document.querySelector("#age").value;if(!t||!n){m("Error","Please fill all the fields!");return}w={nickname:t,gender:n,status:o,age:r,id:new Date().getTime()},window.localStorage.setItem("userInfo",JSON.stringify(w)),z()}});function D(){M.classList.add("show-modal");const e=window.localStorage.getItem("userInfo"),t=document.querySelector("h4");e?(document.querySelector("#nickname").value=JSON.parse(e).nickname,document.querySelector(".radio-group").querySelector("input[value="+JSON.parse(e).gender+"]").checked=!0,document.querySelector("#status").value=JSON.parse(e).status,document.querySelector("#age").value=JSON.parse(e).age,t.innerHTML="Video Conferencing with KiteCite"):(document.querySelector("#start").setAttribute("disabled",!0),t.innerHTML="Dear Anonymous User, Please Enter Your Details")}function z(){const e=window.localStorage.getItem("userInfo"),t=document.querySelector("h4");M.classList.remove("show-modal"),e?(document.querySelector("#nickname").value="",document.querySelector(".radio-group").querySelector("input[value='male']").checked=!0,document.querySelector("#status").value="",document.querySelector("#age").value="",t.innerHTML="Video Conferencing with KiteCite",document.querySelector("#start").removeAttribute("disabled"),t.removeEventListener("click",D)):(document.querySelector("#start").setAttribute("disabled",!0),t.innerHTML="Dear Anonymous User, Please Enter Your Details By Clicking Here",t.addEventListener("click",D))}
