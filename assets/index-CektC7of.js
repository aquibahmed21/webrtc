(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const p of c.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&a(p)}).observe(document,{childList:!0,subtree:!0});function o(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function a(r){if(r.ep)return;r.ep=!0;const c=o(r);fetch(r.href,c)}})();function N(t,e,o){const a=new window.Scaledrone("EoIG3R1I4JdyS4L1"),r=a.subscribe(t);return a.on("open",e),r.on("message",o),{drone:a,room:r}}const u={};let k,w=null,m=null,S=null;const R=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],O={iceServers:R};function M(t,e){k=t;const o="observable-e7b2d4",{drone:a,room:r}=N(o,c,p);m=a,S=r;function c(l){if(l)return console.error(l);console.log("Connected to Scaledrone")}function p(l){const{data:d,member:y}=l,n=y.id;if(n!==m.clientId)switch(d.type){case"offer":g(n,!1,e),u[n].setRemoteDescription(new RTCSessionDescription(d.offer)),u[n].createAnswer().then(h=>{u[n].setLocalDescription(h),m.publish({room:o,message:{type:"answer",answer:h,to:n}})});break;case"answer":d.to===m.clientId&&u[n]&&u[n].setRemoteDescription(new RTCSessionDescription(d.answer));break;case"candidate":d.to===m.clientId&&u[n]&&u[n].addIceCandidate(new RTCIceCandidate(d.candidate));break;case"leave":const s=document.getElementById(n);s&&s.remove(),u[n]&&(u[n].close(),delete u[n]);break}}S.on("members",l=>{l.forEach(d=>{d.id!==m.clientId&&g(d.id,!0,e)})});function g(l,d,y){const n=w=new RTCPeerConnection(O);n.onicecandidate=s=>{s.candidate?(console.log("New ICE Candidate:",s.candidate),m.publish({room:o,message:{type:"candidate",candidate:s.candidate,to:l}})):console.log("All ICE candidates have been gathered.")},n.oniceconnectionstatechange=()=>{var s,h,C;console.log("ICE connection state changed:",n.iceConnectionState),n.iceConnectionState==="failed"?(console.warn("ICE Connection failed. Likely need TURN."),(s=document.getElementById(l))==null||s.remove()):n.iceConnectionState==="disconnected"?(console.warn("ICE Connection disconnected. Could be a network issue."),(h=document.getElementById(l))==null||h.remove()):n.iceConnectionState==="closed"&&(console.warn("ICE Connection closed."),(C=document.getElementById(l))==null||C.remove())},n.onconnectionstatechange=()=>{console.log("PeerConnection state:",n.connectionState)},n.onnegotiationneeded=()=>{console.log("Negotiation needed")},n.onsignalingstatechange=()=>{console.log("Signaling state changed:",n.signalingState)},n.ontrack=s=>{console.log("Track received:",s.track.kind),y(s.streams[0],l)},k.getTracks().forEach(s=>n.addTrack(s,k)),d&&n.createOffer().then(s=>{n.setLocalDescription(s),m.publish({room:o,message:{type:"offer",offer:s,to:l}})}),u[l]=n}}let T=0,E=0,f=null,I=0;const V=document.querySelector("#quality"),D=document.querySelector("#framerate");V.addEventListener("change",async t=>{if(!f)return;const[e,o]=t.target.value.split("x").map(Number);await b(e,o,I)&&await L()});D.addEventListener("change",async t=>{if(!f)return;const e=Number(t.target.value);await b(T,E,e)&&await L()});async function A(t,e,o){try{const a={video:{width:{ideal:t},height:{ideal:e},frameRate:{ideal:o}},audio:!0};return await navigator.mediaDevices.getUserMedia(a)}catch(a){return console.error("Failed to get media stream:",a),null}}async function q(){try{return!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices?(console.log("enumerateDevices() not supported."),[]):(await navigator.mediaDevices.enumerateDevices()).filter(o=>o.kind==="videoinput")}catch(t){return console.error("Error getting camera list:",t),[]}}async function b(t,e,o){E=e,T=t,I=o;const a=await A(t,e,o);if(!a)return!1;const r=a.getVideoTracks()[0];if(f){const c=f.getVideoTracks()[0];c&&c.stop(),f.removeTrack(c),f.addTrack(r)}else f=a;return!0}async function B(){const[t,e]=V.value.split("x").map(Number),o=Number(D.value);return await b(t,e,o),f}function v(t,e,o=!1){const a=document.createElement("video");a.srcObject=t,a.id=e,a.autoplay=!0,a.playsInline=!0,o?document.getElementsByClassName("Channel")[0].appendChild(a):document.getElementsByClassName("Channel")[0].prepend(a)}async function L(){const t=w,e=t.getSenders().find(o=>o.track&&o.track.kind==="video");if(e){const o=e.track;try{o.stop();const r=f.getVideoTracks()[0];await e.replaceTrack(r);const c=await t.createOffer();await t.setLocalDescription(c)}catch(a){console.error("Error updating local video stream:",a),e&&o&&e.replaceTrack&&await e.replaceTrack(o)}}else console.log("No video sender found.")}let i=null;document.querySelector("#controls").addEventListener("click",async t=>{const e=t.target;switch(t.target.id){case"start":await P();break;case"muteAudio":e.textContent=i.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio",i.getAudioTracks()[0].enabled=!i.getAudioTracks()[0].enabled;break;case"muteVideo":e.textContent=i.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video",i.getVideoTracks()[0].enabled=!i.getVideoTracks()[0].enabled;break;case"switchCamera":const r=(i.getVideoTracks()[0].getSettings().facingMode||"user")==="user"?"environment":"user",c={video:{width:localwidth,height:localheight,frameRate:localframeRate,facingMode:{ideal:r}},audio:!0},p=await navigator.mediaDevices.getUserMedia(c);i.getVideoTracks()[0].stop(),i.removeTrack(i.getVideoTracks()[0]),i.addTrack(p.getVideoTracks()[0]),i=p,v(i,"localVideo",!0);break;case"hangup":i&&(i.getTracks().forEach(g=>{g.enabled=!1}),setTimeout(()=>{i.getTracks().forEach(g=>g.stop()),i=null,m.publish({room:Object.keys(m.rooms)[0],message:{type:"leave",from:m.clientId}}),document.querySelector(".Channel").innerHTML="",w&&(w.getSenders().forEach(g=>{g.track&&g.track.stop()}),w.close())},300));break}});async function P(){i=await B(),v(i,"localVideo",!0),M(i,(t,e)=>{document.getElementById(e)||v(t,e)})}q().then(t=>{t.length<=1&&(document.querySelector("#switchCamera").style.display="none")});
