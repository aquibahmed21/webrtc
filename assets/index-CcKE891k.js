(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const c of n)if(c.type==="childList")for(const l of c.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function r(n){const c={};return n.integrity&&(c.integrity=n.integrity),n.referrerPolicy&&(c.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?c.credentials="include":n.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function o(n){if(n.ep)return;n.ep=!0;const c=r(n);fetch(n.href,c)}})();function G(e,t,r){const o=JSON.parse(window.localStorage.getItem("userInfo")),n="EoIG3R1I4JdyS4L1",c=new ScaleDrone(n,{data:{userInfo:o}}),l=c.subscribe(e);return c.on("open",t),l.on("message",r),{drone:c,room:l}}function S(e,t){const r=document.getElementById("toastContainer"),o=document.createElement("div");o.classList.add("toast",e.toLowerCase()),o.textContent=t,r.innerHTML="",r.appendChild(o),setTimeout(()=>{o.remove()},3e3)}const p=[],P=JSON.parse(window.localStorage.getItem("userInfo")),y={};let x,q=null,u=null,C=null;const K=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],Y={iceServers:K};function z(e,t){x=e;const r="observable-e7b2d4",{drone:o,room:n}=G(r,c,l);u=o,C=n;function c(s){if(s)return console.error(s);console.log("Connected to Scaledrone")}function l(s){const{data:i,member:h}=s,a=h.id;if(a!==u.clientId)switch(i.type){case"offer":console.log("Received an offer from",a),b(a,!1,t),y[a].setRemoteDescription(new RTCSessionDescription(i.offer)),y[a].createAnswer().then(f=>{y[a].setLocalDescription(f),u.publish({room:r,message:{type:"answer",answer:f,to:a,userInfo:P}})});break;case"answer":console.log("Received an answer from",a),i.to===u.clientId&&y[a]&&y[a].setRemoteDescription(new RTCSessionDescription(i.answer));break;case"candidate":console.log("Received a candidate from",a),i.to===u.clientId&&y[a]&&y[a].addIceCandidate(new RTCIceCandidate(i.candidate));break;case"leave":console.log(a,"has left the room");const m=p.findIndex(f=>h.id===f.id),v=document.getElementById(a);v&&(v.remove(),m>-1&&S("Info",p[m].clientData.userInfo.nickname+" has left the room!")),p.splice(m,1),y[a]&&(y[a].close(),delete y[a]);break;case"join":p.push(h),console.log(a,"has joined the room"),b(a,!0,t);break;case"screenShare":{const f=document.getElementById(a);f&&(i.isShared===!0?f.setAttribute("screenShare","true"):f.removeAttribute("screenShare"))}break;default:console.warn("Unknown data type:",i.type),S("Warning","Unknown data type: "+i.type)}}C.on("members",s=>{console.log("Members connected:",s),s.forEach(i=>{i.id!==u.clientId&&(p.push(i),b(i.id,!0,t))})}),C.on("member_join",s=>{p.push(s),console.log("Member joined:",s.clientData.userInfo.nickname)}),C.on("member_leave",s=>{const i=p.findIndex(a=>a.id===s.id);console.log("Member left:",p[i].clientData.userInfo.nickname);const h=document.getElementById(s.id);h&&(h.remove(),i>-1&&S("Info",p[i].clientData.userInfo.nickname+" has left the room!")),p.splice(i,1)});async function b(s,i,h){const a=q=new RTCPeerConnection(Y);if(a.onicecandidate=m=>{m.candidate?u.publish({room:r,message:{type:"candidate",candidate:m.candidate,to:s,userInfo:P}}):console.log("All ICE candidates have been gathered.")},a.oniceconnectionstatechange=()=>{var m,v,f;a.iceConnectionState==="failed"?((m=document.getElementById(s))==null||m.remove(),S("Error","Connection failed. User is not connected!")):a.iceConnectionState==="disconnected"?((v=document.getElementById(s))==null||v.remove(),S("Error","Connection disconnected. Could be a network issue!")):a.iceConnectionState==="closed"&&((f=document.getElementById(s))==null||f.remove(),S("Info","User has left the room!"))},a.onconnectionstatechange=()=>{},a.onnegotiationneeded=()=>{},a.onsignalingstatechange=()=>{},a.ontrack=m=>{console.log("Track received:",m.track.kind),h(m.streams[0],s);const v=p.findIndex(f=>f.id===s);v>-1&&S("Info",p[v].clientData.userInfo.nickname+" has joined the room!")},x.getTracks().forEach(m=>a.addTrack(m,x)),i){const m=await _(a);u.publish({room:r,message:{type:"offer",offer:m,to:s,userInfo:P}})}y[s]=a}}const j=JSON.parse(window.localStorage.getItem("userInfo"));let k=0,I=0,d=null,E=0,N="user";const L=document.querySelector("#quality"),O=document.querySelector("#framerate"),R=document.querySelector("#shareScreen"),U=document.querySelector("#muteVideo"),H=document.querySelector("#switchCamera");L.addEventListener("change",async e=>{if(!d)return;const[t,r]=e.target.value.split("x").map(Number);await A(t,r,E)});O.addEventListener("change",async e=>{if(!d)return;const t=Number(e.target.value);await A(k,I,t)});R.addEventListener("click",async e=>{const t=document.querySelector("#localVideo");if(e.target.setAttribute("disabled","true"),e.target.getAttribute("isShared")==="true"){e.target.textContent="🖥️ Share Screen",e.target.setAttribute("isShared","false"),U.removeAttribute("disabled"),L.removeAttribute("disabled"),O.removeAttribute("disabled"),H.removeAttribute("disabled"),e.target.removeAttribute("disabled"),t.removeAttribute("screenShare"),await A(k,I,E),u.publish({room:Object.keys(u.rooms)[0],message:{type:"screenShare",from:u.clientId,isShared:!1,userInfo:j}});return}if(d)try{const r=await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:"screen"}});e.target.textContent="🖥️ Stop Sharing",e.target.setAttribute("isShared","true"),U.setAttribute("disabled","true"),L.setAttribute("disabled","true"),O.setAttribute("disabled","true"),H.setAttribute("disabled","true"),t.setAttribute("screenShare","true"),d&&(d.getVideoTracks()[0].stop(),d.removeTrack(d.getVideoTracks()[0]));const o=r.getVideoTracks()[0];d.addTrack(o),await W(),u.publish({room:Object.keys(u.rooms)[0],message:{type:"screenShare",from:u.clientId,isShared:!0,userInfo:j}})}catch(r){console.error("Error starting screen share:",r)}finally{e.target.removeAttribute("disabled")}});async function Q(e,t,r,o){d&&(d.getVideoTracks()[0].stop(),d.removeTrack(d.getVideoTracks()[0]));try{const n={video:{width:{ideal:e},height:{ideal:t},frameRate:{ideal:r},facingMode:{ideal:o}},audio:!d};return await navigator.mediaDevices.getUserMedia(n)}catch(n){return console.error("Failed to get media stream:",n),S("Error","Failed to get media stream!"),null}}async function A(e,t,r,o=!1,n=!1){I=t,k=e,E=r;const c=n&&d.getVideoTracks()[0].getSettings().facingMode||"user";N=n?c==="user"?"environment":"user":N;const l=await Q(k,I,E,N);if(!l)return!1;const b=l.getVideoTracks()[0];if(d){const s=d.getVideoTracks()[0];s&&(s.stop(),d.removeTrack(s)),d.addTrack(b)}else d=l;if(o){const s=document.querySelector("#localVideo");s.setAttribute("mode",d.getVideoTracks()[0].getSettings().facingMode||"user"),s.srcObject=d}return await W(),!0}function X(){A(k,I,E,!0,!0)}async function Z(){const[e,t]=L.value.split("x").map(Number),r=Number(O.value);return await A(e,t,r),d}function J(e,t,r=!1){const o=document.createElement("video");o.srcObject=e,o.id=t,o.autoplay=!0,o.playsInline=!0,o.setAttribute("memberId",t),r?(o.muted=!0,document.getElementsByClassName("Channel")[0].appendChild(o),o.setAttribute("mode",d.getVideoTracks()[0].getSettings().facingMode||"user")):(o.setAttribute("isRemote","true"),document.getElementsByClassName("Channel")[0].prepend(o),ee(e,o))}function ee(e,t){const o=new AudioContext,n=o.createMediaStreamSource(e),c=o.createGain();c.gain.value=2.5;const l=o.createAnalyser();l.fftSize=256;const b=l.frequencyBinCount,s=new Uint8Array(b);n.connect(l),n.connect(c).connect(o.destination),t.srcObject=e,t.volume=0;let i=!1;setInterval(()=>{l.getByteFrequencyData(s);let h=0;for(let m=0;m<s.length;m++)h+=s[m];h/s.length>20?i||(i=!0,$(!0,t)):i&&(i=!1,$(!1,t))},100)}function $(e,t){const r=t;e?r.style.border="2px solid #1e90ff":r.style.border=""}async function W(){const e=q;if(!e)return;const t=e.getSenders().find(r=>r.track&&r.track.kind==="video");if(t){const r=t.track;try{r.stop();const n=d.getVideoTracks()[0];await t.replaceTrack(n),await _(e)}catch(o){console.error("Error updating local video stream:",o),S("Error","Error updating local video stream!"),t&&r&&t.replaceTrack&&await t.replaceTrack(r)}}else console.log("No video sender found.")}function te(){const e=navigator.userAgent;return/iPhone|iPad|iPod/.test(e)&&/Safari/.test(e)&&!/CriOS/.test(e)?"H264":(/Android/.test(e)&&/Chrome/.test(e)||/Firefox/.test(e)||/Edge|Edg/.test(e),"VP8")}function oe(e,t,r="video"){const o=e.split(`\r
`),n=o.findIndex(i=>i.startsWith(`m=${r}`));if(n===-1)return e;const c=new RegExp(`a=rtpmap:(\\d+)\\s${t}`,"i"),l=o.filter(i=>c.test(i)).map(i=>i.match(c)[1]);if(l.length===0)return e;const b=o[n].split(" "),s=l.concat(b.slice(3).filter(i=>!l.includes(i)));return o[n]=[...b.slice(0,3),...s].join(" "),o.join(`\r
`)}async function _(e){const t=await e.createOffer(),r=te(),o=oe(t.sdp,r);return await e.setLocalDescription({type:t.type,sdp:o}),console.log("Preferred codec:",r),console.log("Modified SDP:",o),t}function re(){return/iphone|ipod|ipad/i.test(navigator.userAgent)?(console.log("Screen sharing is not supported on iOS devices via web apps. Please use a native app or WebView."),R.setAttribute("disabled","true"),!1):"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices?(console.log("Screen sharing is supported on this platform."),!0):(console.log("Screen sharing is not supported on this platform."),R.setAttribute("disabled","true"),!1)}re();const ne=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let g=null;const ae=document.querySelector("#muteVideo"),se=document.querySelector("#muteAudio"),M=document.querySelector("#userInfoModal");let w=window.localStorage.getItem("userInfo");if(!w)D();else{w=JSON.parse(w);const{nickname:e,gender:t,status:r,age:o}=w;(!e||!t||!r||!o)&&D()}document.querySelector("#audioOutputSelect").addEventListener("change",e=>{const t=audioOutputSelect.value,r=document.querySelectorAll("video[isRemote]");try{r.forEach(async o=>{await o.setSinkId(t)}),console.log(`Audio output set to device: ${t}`)}catch(o){console.error("Error setting audio output device:",o)}});navigator.mediaDevices.addEventListener("devicechange",()=>{B()});async function B(){try{const t=(await navigator.mediaDevices.enumerateDevices()).filter(r=>r.kind==="audiooutput"||r.label.includes("headset"));t.length>0&&t.forEach(r=>{if(audioOutputSelect.querySelector(`option[value="${r.deviceId}"]`))return;const o=document.createElement("option");o.value=r.deviceId,o.text=r.label||r.kind||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(o)})}catch(e){console.error("Error fetching audio output devices:",e)}}document.querySelector("#controls").addEventListener("click",async e=>{const t=e.target;switch(e.target.id){case"start":t.disabled=!0,await ie(),t.disabled=!1;break;case"muteAudio":t.textContent="🔇 "+(g.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio"),g.getAudioTracks()[0].enabled=!g.getAudioTracks()[0].enabled;break;case"muteVideo":t.textContent="🎥 "+(g.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video"),g.getVideoTracks()[0].enabled=!g.getVideoTracks()[0].enabled;break;case"switchCamera":await X();break;case"audioOutputRefresh":B();break;case"hangup":ae.textContent="🎥 Mute Video",se.textContent="🔇 Mute Audio",g&&(g.getTracks().forEach(o=>{o.enabled=!1}),setTimeout(()=>{g.getTracks().forEach(o=>o.stop()),g=null,u.publish({room:Object.keys(u.rooms)[0],message:{type:"leave",from:u.clientId,userInfo:w}}),document.querySelector(".Channel").innerHTML="",q&&q.getSenders().forEach(o=>{o.track&&o.track.stop()})},300));break}});async function ie(){if(g=await Z(),J(g,"localVideo",!0),u){u.publish({room:Object.keys(u.rooms)[0],message:{type:"join",from:u.clientId,userInfo:w}});return}z(g,(e,t)=>{document.getElementById(t)||J(e,t)})}B();ne||(document.querySelector("#switchCamera").style.display="none");let T;const V=document.getElementById("install-btn");window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),T=e,V.style.display="flex",setTimeout(()=>{V.style.display="none",S("Info","You can add this app to your home screen!")},15e3),V.addEventListener("click",()=>{T.prompt(),T.userChoice.then(t=>{t.outcome==="accepted"?console.log("User accepted the A2HS prompt"):console.log("User dismissed the A2HS prompt"),T=null})})});window.matchMedia("(display-mode: standalone)").matches&&(V.style.display="none");M.addEventListener("click",e=>{if(e.target===M||e.target.id==="closeModal")F();else if(e.target.id==="submit-btn"){e.stopPropagation();const t=document.querySelector("#nickname").value,r=document.querySelector("#gender").value,o=document.querySelector("#status").value,n=document.querySelector("#age").value;if(!t||!r||!o||!n){S("Error","Please fill all the fields!");return}w={nickname:t,gender:r,status:o,age:n,id:new Date().getTime()},window.localStorage.setItem("userInfo",JSON.stringify(w)),F()}});function D(){M.classList.add("show-modal");const e=window.localStorage.getItem("userInfo"),t=document.querySelector("h4");e?(document.querySelector("#nickname").value=JSON.parse(e).nickname,document.querySelector("#gender").value=JSON.parse(e).gender,document.querySelector("#status").value=JSON.parse(e).status,document.querySelector("#age").value=JSON.parse(e).age,t.innerHTML="Video Conferencing with KiteCite"):(document.querySelector("#start").setAttribute("disabled",!0),t.innerHTML="Dear Anonymous User, Please Enter Your Details")}function F(){const e=window.localStorage.getItem("userInfo"),t=document.querySelector("h4");M.classList.remove("show-modal"),e?(document.querySelector("#nickname").value="",document.querySelector("#gender").value="",document.querySelector("#status").value="",document.querySelector("#age").value="",t.innerHTML="Video Conferencing with KiteCite",document.querySelector("#start").removeAttribute("disabled"),t.removeEventListener("click",D)):(document.querySelector("#start").setAttribute("disabled",!0),t.innerHTML="Dear Anonymous User, Please Enter Your Details By Clicking Here",t.addEventListener("click",D))}
