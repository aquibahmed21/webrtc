(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const d of s.addedNodes)d.tagName==="LINK"&&d.rel==="modulepreload"&&o(d)}).observe(document,{childList:!0,subtree:!0});function n(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=n(r);fetch(r.href,s)}})();let H=null;"serviceWorker"in navigator&&window.addEventListener("load",async()=>{H=await navigator.serviceWorker.register("/webrtc/service-worker.js").catch(e=>console.log("ServiceWorker registration failed:",e))});function Z(t,e,n){const o=JSON.parse(window.localStorage.getItem("userInfo")),r="EoIG3R1I4JdyS4L1",s=new ScaleDrone(r,{data:{userInfo:o}}),d=s.subscribe(t);return s.on("open",e),d.on("message",n),{drone:s,room:d}}function m(t,e){const n=document.getElementById("toastContainer"),o=document.createElement("div");o.classList.add("toast",t.toLowerCase()),o.textContent=e,n.innerHTML="",n.appendChild(o),setTimeout(()=>{o.remove()},3e3)}const g=[],J=JSON.parse(window.localStorage.getItem("userInfo")),S={};let U,L=null,f=null,q=null;const ee=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],te={iceServers:ee};function oe(t,e){U=t;const n="observable-e7b2d4",{drone:o,room:r}=Z(n,s,d);f=o,q=r;function s(a){if(a)return console.error(a);console.log("Connected to Scaledrone")}function d(a){const{data:i,member:y}=a,c=y.id;if(c!==f.clientId)switch(i.type){case"offer":b(c,!1,e),S[c].setRemoteDescription(new RTCSessionDescription(i.offer)),S[c].createAnswer().then(p=>{S[c].setLocalDescription(p),f.publish({room:n,message:{type:"answer",answer:p,to:c,userInfo:J}})});break;case"answer":i.to===f.clientId&&S[c]&&S[c].setRemoteDescription(new RTCSessionDescription(i.answer));break;case"candidate":i.to===f.clientId&&S[c]&&S[c].addIceCandidate(new RTCIceCandidate(i.candidate));break;case"leave":console.log(c,"has left the room");const u=g.findIndex(p=>y.id===p.id),v=document.getElementById(c);v&&(v.remove(),u>-1&&m("Info",g[u].clientData.userInfo.nickname+" has left the room!")),g.splice(u,1),S[c]&&(S[c].close(),delete S[c]);break;case"join":g.push(y),console.log(c,"has joined the room"),b(c,!0,e);break;case"screenShare":{const p=document.getElementById(c);p&&(i.isShared===!0?p.setAttribute("screenShare","true"):p.removeAttribute("screenShare"))}break;default:console.warn("Unknown data type:",i.type),m("Warning","Unknown data type: "+i.type)}}q.on("members",a=>{console.log("Members connected:",a),a.forEach(i=>{i.id!==f.clientId&&(g.push(i),b(i.id,!0,e))})}),q.on("member_join",a=>{var i;g.push(a),console.log("Member joined:",(i=a.clientData)==null?void 0:i.userInfo.nickname),b(a.id,!1,e)}),q.on("member_leave",a=>{var c;const i=g.findIndex(u=>u.id===a.id);console.log("Member left:",(c=g[i].clientData)==null?void 0:c.userInfo.nickname);const y=document.getElementById(a.id);y&&(y.remove(),i>-1&&m("Info",g[i].clientData.userInfo.nickname+" has left the room!")),g.splice(i,1)});async function b(a,i,y){const c=L=new RTCPeerConnection(te);if(c.onicecandidate=u=>{u.candidate&&f.publish({room:n,message:{type:"candidate",candidate:u.candidate,to:a,userInfo:J}})},c.oniceconnectionstatechange=()=>{var u,v,p;c.iceConnectionState==="failed"?((u=document.getElementById(a))==null||u.remove(),m("Error","Connection failed. User is not connected!")):c.iceConnectionState==="disconnected"?((v=document.getElementById(a))==null||v.remove(),m("Error","Connection disconnected. Could be a network issue!")):c.iceConnectionState==="closed"&&((p=document.getElementById(a))==null||p.remove(),m("Info","User has left the room!"))},c.onconnectionstatechange=()=>{},c.onnegotiationneeded=()=>{},c.onsignalingstatechange=()=>{},c.ontrack=u=>{var p,$;y(u.streams[0],a,($=(p=g.find(j=>j.id===a).clientData)==null?void 0:p.userInfo)==null?void 0:$.nickname);const v=g.findIndex(j=>j.id===a);v>-1&&m("Info",g[v].clientData.userInfo.nickname+" has joined the room!")},U.getTracks().forEach(u=>c.addTrack(u,U)),i){const u=await Q(c);f.publish({room:n,message:{type:"offer",offer:u,to:a,userInfo:J}})}S[a]=c}}const W=JSON.parse(window.localStorage.getItem("userInfo"));let I=0,A=0,l=null,E=0,R="user";const C=document.querySelector("#quality"),T=document.querySelector("#framerate"),B=document.querySelector("#shareScreen"),K=document.querySelector("#muteVideo"),F=document.querySelector("#switchCamera");C.addEventListener("click",async t=>{if(!l)return;const e=C.querySelector("input:checked").value,[n,o]=e.split("x").map(Number);await O(n,o,E)});T.addEventListener("click",async t=>{if(!l)return;const e=T.querySelector("input:checked").value,n=Number(e);await O(I,A,n)});B.addEventListener("click",async t=>{const e=document.querySelector("#localVideo");if(t.target.setAttribute("disabled","true"),t.target.getAttribute("isShared")==="true"){t.target.textContent="🖥️ Share Screen",t.target.setAttribute("isShared","false"),K.removeAttribute("disabled"),C.removeAttribute("disabled"),T.removeAttribute("disabled"),F.removeAttribute("disabled"),t.target.removeAttribute("disabled"),e.removeAttribute("screenShare"),await O(I,A,E),f.publish({room:Object.keys(f.rooms)[0],message:{type:"screenShare",from:f.clientId,isShared:!1,userInfo:W}});return}if(l)try{const n=await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:"screen"}});t.target.textContent="🖥️ Stop Sharing",t.target.setAttribute("isShared","true"),K.setAttribute("disabled","true"),C.setAttribute("disabled","true"),T.setAttribute("disabled","true"),F.setAttribute("disabled","true"),e.setAttribute("screenShare","true"),l&&(l.getVideoTracks()[0].stop(),l.removeTrack(l.getVideoTracks()[0]));const o=n.getVideoTracks()[0];l.addTrack(o),await G(),f.publish({room:Object.keys(f.rooms)[0],message:{type:"screenShare",from:f.clientId,isShared:!0,userInfo:W}})}catch(n){console.error("Error starting screen share:",n)}finally{t.target.removeAttribute("disabled")}});async function ne(t,e,n,o){l&&l.getVideoTracks().forEach(r=>{l.removeTrack(r),r.stop()});try{const r={video:{width:{ideal:t},height:{ideal:e},frameRate:{ideal:n},facingMode:{ideal:o}},audio:!l};return await navigator.mediaDevices.getUserMedia(r)}catch(r){return console.error("Failed to get media stream:",r),m("Error","Failed to get media stream!"),null}}async function O(t,e,n,o=!1,r=!1){A=e,I=t,E=n;const s=r&&l.getVideoTracks()[0].getSettings().facingMode||"user";R=r?s==="user"?"environment":"user":R;const d=await ne(I,A,E,R);if(!d)return!1;const b=d.getVideoTracks()[0];if(l){const a=l.getVideoTracks()[0];a&&(a.stop(),l.removeTrack(a)),l.addTrack(b)}else l=d;if(o){const a=document.querySelector("#localVideo");a.setAttribute("mode",l.getVideoTracks()[0].getSettings().facingMode||"user"),a.srcObject=l}return await G(),!0}function re(){O(I,A,E,!0,!0)}async function se(){const t=C.querySelector("input:checked").value,[e,n]=t.split("x").map(Number),o=T.querySelector("input:checked"),r=Number(o.value);return await O(e,n,r),l}function _(t,e,n=!1,o=""){const r=document.createElement("div");r.className="participant",r.setAttribute("data-id",e),r.innerHTML=`<video autoplay playsinline></video>
    <div class="overlay">
      <span class="name">${o}</span>
      <div class="controls">
        <button class="muteAudio">🔇</button>
        <button class="muteVideo">🎥</button>
        <button class="switchCamera">🔄</button>
        <button class="hangup">📞</button>
      </div>
    </div>
  </div>`;const s=r.querySelector("video");s.srcObject=t,s.id=e,s.autoplay=!0,s.playsInline=!0,s.setAttribute("memberId",e),n?(s.muted=!0,document.getElementsByClassName("Channel")[0].appendChild(r),s.setAttribute("mode",l.getVideoTracks()[0].getSettings().facingMode||"user")):(s.setAttribute("isRemote","true"),document.getElementsByClassName("Channel")[0].prepend(r),ae(t,s))}function ae(t,e){const o=new AudioContext,r=o.createMediaStreamSource(t),s=o.createGain();s.gain.value=2.5;const d=o.createAnalyser();d.fftSize=256;const b=d.frequencyBinCount,a=new Uint8Array(b);r.connect(d),r.connect(s).connect(o.destination),e.srcObject=t,e.volume=0;let i=!1;setInterval(()=>{d.getByteFrequencyData(a);let y=0;for(let u=0;u<a.length;u++)y+=a[u];y/a.length>20?i||(i=!0,Y(!0,e)):i&&(i=!1,Y(!1,e))},100)}function Y(t,e){const n=e;t?n.style.border="2px solid #1e90ff":n.style.border=""}async function G(){const t=L;if(!t)return;const e=t.getSenders().find(n=>n.track&&n.track.kind==="video");if(e){const n=e.track;try{n.stop();const r=l.getVideoTracks()[0];await e.replaceTrack(r),await Q(t)}catch(o){console.error("Error updating local video stream:",o),m("Error","Error updating local video stream!"),e&&n&&e.replaceTrack&&await e.replaceTrack(n)}}else console.log("No video sender found.")}function ie(){const t=navigator.userAgent;return/iPhone|iPad|iPod/.test(t)&&/Safari/.test(t)&&!/CriOS/.test(t)?"H264":(/Android/.test(t)&&/Chrome/.test(t)||/Firefox/.test(t)||/Edge|Edg/.test(t),"VP8")}function ce(t,e,n="video"){const o=t.split(`\r
`),r=o.findIndex(i=>i.startsWith(`m=${n}`));if(r===-1)return t;const s=new RegExp(`a=rtpmap:(\\d+)\\s${e}`,"i"),d=o.filter(i=>s.test(i)).map(i=>i.match(s)[1]);if(d.length===0)return t;const b=o[r].split(" "),a=d.concat(b.slice(3).filter(i=>!d.includes(i)));return o[r]=[...b.slice(0,3),...a].join(" "),o.join(`\r
`)}async function Q(t){const e=await t.createOffer(),n=ie(),o=ce(e.sdp,n);return await t.setLocalDescription({type:e.type,sdp:o}),console.log("Preferred codec:",n),e}function de(){return/iphone|ipod|ipad/i.test(navigator.userAgent)?(console.log("Screen sharing is not supported on iOS devices via web apps. Please use a native app or WebView."),B.setAttribute("disabled","true"),!1):"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices?(console.log("Screen sharing is supported on this platform."),!0):(console.log("Screen sharing is not supported on this platform."),B.setAttribute("disabled","true"),!1)}de();function le(t){const e="=".repeat((4-t.length%4)%4),n=(t+e).replace(/\-/g,"+").replace(/_/g,"/"),o=atob(n),r=new Uint8Array(o.length);for(let s=0;s<o.length;++s)r[s]=o.charCodeAt(s);return r}const X=/iphone|ipod|ipad/i.test(navigator.userAgent),ue=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let h=null;const fe=document.querySelector("#muteVideo"),me=document.querySelector("#muteAudio"),P=document.querySelector("#userInfoModal"),M=window.location.hostname==="localhost"?"http://localhost:3000/":"https://web-push-3zaz.onrender.com/",k=document.querySelector("#push");function pe(t,e){var o;const n=((o=JSON.parse(window.localStorage.getItem("userInfo")))==null?void 0:o.id)||0;fetch(M+"notifyAll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({initiator:n,title:t,body:e})})}async function ge(){if(!JSON.parse(window.localStorage.getItem("userInfo")))return!1;if(Notification.permission==="granted"){const e=localStorage.getItem("subscription");if(!e){const r=await H.pushManager.getSubscription();return r&&(await r.unsubscribe(),m("Info","Notification unsubscribed locally!, Please resubscribe.")),!1}return(await(await fetch(M+"isPushSubscribed",{method:"POST",headers:{"Content-Type":"application/json"},body:e})).json()).isSubscribed}}k.addEventListener("click",async t=>{const e=await fetch(M+"vapid").catch(d=>console.log(d));if(!e)return;const{publicKey:n}=await e.json();if(k.setAttribute("disabled","true"),await Notification.requestPermission()!=="granted"){m("Error","Unable to subscribe to push notifications"),k.setAttribute("disabled","false");return}const r=await H.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:le(n)}),s={endpoint:r.toJSON().endpoint,expirationTime:r.toJSON().expirationTime,keys:{p256dh:r.toJSON().keys.p256dh,auth:r.toJSON().keys.auth,id:JSON.parse(window.localStorage.getItem("userInfo")).id}};localStorage.setItem("subscription",JSON.stringify(r)),await fetch(M+"subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)}).then(d=>{d.status===200?m("Success","Push notifications subscribed successfully"):m("Error","Unable to subscribe to push notifications")}).catch(d=>{console.log(d),m("Error","Unable to subscribe to push notifications")}),k.style.display="none",m("Success","Push notifications subscribed successfully")},!1);setTimeout(async()=>{const t=await ge();k.style.display=t?"none":""},1e3);let w=window.localStorage.getItem("userInfo");if(!w)D();else{w=JSON.parse(w);const{nickname:t,gender:e,status:n,age:o}=w;(!t||!e)&&D()}document.querySelector("#audioOutputSelect").addEventListener("change",t=>{const e=audioOutputSelect.value,n=document.querySelectorAll("video[isRemote]");try{n.forEach(async o=>{await o.setSinkId(e)}),console.log(`Audio output set to device: ${e}`)}catch(o){console.error("Error setting audio output device:",o)}});navigator.mediaDevices.addEventListener("devicechange",()=>{x()});async function x(){try{const e=(await navigator.mediaDevices.enumerateDevices()).filter(n=>n.kind==="audiooutput"||n.label.includes("headset"));e.length>0&&e.forEach(n=>{if(audioOutputSelect.querySelector(`option[value="${n.deviceId}"]`))return;const o=document.createElement("option");o.value=n.deviceId,o.text=n.label||n.kind||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(o)})}catch(t){console.error("Error fetching audio output devices:",t)}}document.querySelector("#controls").addEventListener("click",async t=>{const e=t.target;switch(t.target.id){case"start":e.disabled=!0,await he(),e.disabled=!1;break;case"muteAudio":e.textContent="🔇 "+(h.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio"),h.getAudioTracks()[0].enabled=!h.getAudioTracks()[0].enabled;break;case"muteVideo":e.textContent="🎥 "+(h.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video"),h.getVideoTracks()[0].enabled=!h.getVideoTracks()[0].enabled;break;case"switchCamera":await re();break;case"audioOutputRefresh":x();break;case"hangup":fe.textContent="🎥 Mute Video",me.textContent="🔇 Mute Audio",h&&(h.getTracks().forEach(o=>{o.enabled=!1}),setTimeout(()=>{h.getTracks().forEach(o=>o.stop()),h=null,f.publish({room:Object.keys(f.rooms)[0],message:{type:"leave",from:f.clientId,userInfo:w}}),document.querySelector(".Channel").innerHTML="",L&&L.getSenders().forEach(o=>{o.track&&o.track.stop()})},300));break}});async function he(){var e;const t=((e=JSON.parse(window.localStorage.getItem("userInfo")))==null?void 0:e.nickname)||"No name";if(pe("Video Conferencing with KiteCite","Started by "+t),h=await se(),_(h,"localVideo",!0,"You"),X||x(),f){f.publish({room:Object.keys(f.rooms)[0],message:{type:"join",from:f.clientId,userInfo:w}});return}oe(h,(n,o,r)=>{document.getElementById(o)||_(n,o,!1,r)})}X||x();ue||(document.querySelector("#switchCamera").style.display="none");let V;const N=document.getElementById("install-btn");window.addEventListener("beforeinstallprompt",t=>{t.preventDefault(),V=t,N.style.display="flex",setTimeout(()=>{N.style.display="none",m("Info","You can add this app to your home screen!")},15e3),N.addEventListener("click",()=>{V.prompt(),V.userChoice.then(e=>{e.outcome==="accepted"?console.log("User accepted the A2HS prompt"):console.log("User dismissed the A2HS prompt"),V=null})})});window.matchMedia("(display-mode: standalone)").matches&&(N.style.display="none");P.addEventListener("click",t=>{if(t.target===P||t.target.id==="closeModal")z();else if(t.target.id==="submit-btn"){t.stopPropagation();const e=document.querySelector("#nickname").value,n=document.querySelector(".radio-group").querySelector("input:checked").value,o=document.querySelector("#status").value,r=document.querySelector("#age").value;if(!e||!n){m("Error","Please fill all the fields!");return}w={nickname:e,gender:n,status:o,age:r,id:new Date().getTime()},window.localStorage.setItem("userInfo",JSON.stringify(w)),z()}});function D(){P.classList.add("show-modal");const t=window.localStorage.getItem("userInfo"),e=document.querySelector("h4");t?(document.querySelector("#nickname").value=JSON.parse(t).nickname,document.querySelector(".radio-group").querySelector("input[value="+JSON.parse(t).gender+"]").checked=!0,document.querySelector("#status").value=JSON.parse(t).status,document.querySelector("#age").value=JSON.parse(t).age,e.innerHTML="Video Conferencing with KiteCite"):(document.querySelector("#start").setAttribute("disabled",!0),e.innerHTML="Dear Anonymous User, Please Enter Your Details")}function z(){const t=window.localStorage.getItem("userInfo"),e=document.querySelector("h4");P.classList.remove("show-modal"),t?(document.querySelector("#nickname").value="",document.querySelector(".radio-group").querySelector("input[value='male']").checked=!0,document.querySelector("#status").value="",document.querySelector("#age").value="",e.innerHTML="Video Conferencing with KiteCite",document.querySelector("#start").removeAttribute("disabled"),e.removeEventListener("click",D)):(document.querySelector("#start").setAttribute("disabled",!0),e.innerHTML="Dear Anonymous User, Please Enter Your Details By Clicking Here",e.addEventListener("click",D))}
