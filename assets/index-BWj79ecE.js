(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const c of r)if(c.type==="childList")for(const u of c.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&n(u)}).observe(document,{childList:!0,subtree:!0});function o(r){const c={};return r.integrity&&(c.integrity=r.integrity),r.referrerPolicy&&(c.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?c.credentials="include":r.crossOrigin==="anonymous"?c.credentials="omit":c.credentials="same-origin",c}function n(r){if(r.ep)return;r.ep=!0;const c=o(r);fetch(r.href,c)}})();function R(e,t,o){const n=new window.Scaledrone("EoIG3R1I4JdyS4L1"),r=n.subscribe(e);return n.on("open",t),r.on("message",o),{drone:n,room:r}}const m={};let k,w=null,g=null,b=null;const N=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],O={iceServers:N};function M(e,t){k=e;const o="observable-e7b2d4",{drone:n,room:r}=R(o,c,u);g=n,b=r;function c(d){if(d)return console.error(d);console.log("Connected to Scaledrone")}function u(d){const{data:s,member:y}=d,a=y.id;if(a!==g.clientId)switch(s.type){case"offer":f(a,!1,t),m[a].setRemoteDescription(new RTCSessionDescription(s.offer)),m[a].createAnswer().then(h=>{m[a].setLocalDescription(h),g.publish({room:o,message:{type:"answer",answer:h,to:a}})});break;case"answer":s.to===g.clientId&&m[a]&&m[a].setRemoteDescription(new RTCSessionDescription(s.answer));break;case"candidate":s.to===g.clientId&&m[a]&&m[a].addIceCandidate(new RTCIceCandidate(s.candidate));break;case"leave":const l=document.getElementById(a);l&&l.remove(),m[a]&&(m[a].close(),delete m[a]);break}}b.on("members",d=>{d.forEach(s=>{s.id!==g.clientId&&f(s.id,!0,t)})});async function f(d,s,y){const a=w=new RTCPeerConnection(O);if(a.onicecandidate=l=>{l.candidate?(console.log("New ICE Candidate:",l.candidate),g.publish({room:o,message:{type:"candidate",candidate:l.candidate,to:d}})):console.log("All ICE candidates have been gathered.")},a.oniceconnectionstatechange=()=>{var l,h,S;console.log("ICE connection state changed:",a.iceConnectionState),a.iceConnectionState==="failed"?(console.warn("ICE Connection failed. Likely need TURN."),(l=document.getElementById(d))==null||l.remove()):a.iceConnectionState==="disconnected"?(console.warn("ICE Connection disconnected. Could be a network issue."),(h=document.getElementById(d))==null||h.remove()):a.iceConnectionState==="closed"&&(console.warn("ICE Connection closed."),(S=document.getElementById(d))==null||S.remove())},a.onconnectionstatechange=()=>{console.log("PeerConnection state:",a.connectionState)},a.onnegotiationneeded=()=>{console.log("Negotiation needed")},a.onsignalingstatechange=()=>{console.log("Signaling state changed:",a.signalingState)},a.ontrack=l=>{console.log("Track received:",l.track.kind),y(l.streams[0],d)},k.getTracks().forEach(l=>a.addTrack(l,k)),s){const l=await L(a);g.publish({room:o,message:{type:"offer",offer:l,to:d}})}m[d]=a}}let T=0,E=0,p=null,I=0;const V=document.querySelector("#quality"),P=document.querySelector("#framerate");V.addEventListener("change",async e=>{if(!p)return;const[t,o]=e.target.value.split("x").map(Number);await C(t,o,I)&&await D()});P.addEventListener("change",async e=>{if(!p)return;const t=Number(e.target.value);await C(T,E,t)&&await D()});async function A(e,t,o){try{const n={video:{width:{ideal:e},height:{ideal:t},frameRate:{ideal:o}},audio:!0};return await navigator.mediaDevices.getUserMedia(n)}catch(n){return console.error("Failed to get media stream:",n),null}}async function x(){try{return!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices?(console.log("enumerateDevices() not supported."),[]):(await navigator.mediaDevices.enumerateDevices()).filter(o=>o.kind==="videoinput")}catch(e){return console.error("Error getting camera list:",e),[]}}async function C(e,t,o){E=t,T=e,I=o;const n=await A(e,t,o);if(!n)return!1;const r=n.getVideoTracks()[0];if(p){const c=p.getVideoTracks()[0];c&&c.stop(),p.removeTrack(c),p.addTrack(r)}else p=n;return!0}async function q(){const[e,t]=V.value.split("x").map(Number),o=Number(P.value);return await C(e,t,o),p}function v(e,t,o=!1){const n=document.createElement("video");n.srcObject=e,n.id=t,n.autoplay=!0,n.playsInline=!0,o?document.getElementsByClassName("Channel")[0].appendChild(n):document.getElementsByClassName("Channel")[0].prepend(n)}async function D(){const e=w;if(!e)return;const t=e.getSenders().find(o=>o.track&&o.track.kind==="video");if(t){const o=t.track;try{o.stop();const r=p.getVideoTracks()[0];await t.replaceTrack(r),await L(e)}catch(n){console.error("Error updating local video stream:",n),t&&o&&t.replaceTrack&&await t.replaceTrack(o)}}else console.log("No video sender found.")}function B(){const e=navigator.userAgent;return/iPhone|iPad|iPod/.test(e)&&/Safari/.test(e)&&!/CriOS/.test(e)?"H264":(/Android/.test(e)&&/Chrome/.test(e)||/Firefox/.test(e)||/Edge|Edg/.test(e),"VP8")}function F(e,t,o="video"){const n=e.split(`\r
`),r=n.findIndex(s=>s.startsWith(`m=${o}`));if(r===-1)return e;const c=new RegExp(`a=rtpmap:(\\d+)\\s${t}`,"i"),u=n.filter(s=>c.test(s)).map(s=>s.match(c)[1]);if(u.length===0)return e;const f=n[r].split(" "),d=u.concat(f.slice(3).filter(s=>!u.includes(s)));return n[r]=[...f.slice(0,3),...d].join(" "),n.join(`\r
`)}async function L(e){const t=await e.createOffer(),o=B(),n=F(t.sdp,o);return await e.setLocalDescription({type:t.type,sdp:n}),console.log("Preferred codec:",o),console.log("Modified SDP:",n),t}let i=null;document.querySelector("#controls").addEventListener("click",async e=>{const t=e.target;switch(e.target.id){case"start":await $();break;case"muteAudio":t.textContent=i.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio",i.getAudioTracks()[0].enabled=!i.getAudioTracks()[0].enabled;break;case"muteVideo":t.textContent=i.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video",i.getVideoTracks()[0].enabled=!i.getVideoTracks()[0].enabled;break;case"switchCamera":const r=(i.getVideoTracks()[0].getSettings().facingMode||"user")==="user"?"environment":"user",c={video:{width:localwidth,height:localheight,frameRate:localframeRate,facingMode:{ideal:r}},audio:!0},u=await navigator.mediaDevices.getUserMedia(c);i.getVideoTracks()[0].stop(),i.removeTrack(i.getVideoTracks()[0]),i.addTrack(u.getVideoTracks()[0]),i=u,v(i,"localVideo",!0);break;case"hangup":i&&(i.getTracks().forEach(f=>{f.enabled=!1}),setTimeout(()=>{i.getTracks().forEach(f=>f.stop()),i=null,g.publish({room:Object.keys(g.rooms)[0],message:{type:"leave",from:g.clientId}}),document.querySelector(".Channel").innerHTML="",w&&(w.getSenders().forEach(f=>{f.track&&f.track.stop()}),w.close())},300));break}});async function $(){i=await q(),v(i,"localVideo",!0),M(i,(e,t)=>{document.getElementById(t)||v(e,t)})}x().then(e=>{e.length<=1&&(document.querySelector("#switchCamera").style.display="none")});
