(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const s of i.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=n(r);fetch(r.href,i)}})();let Ae=null;"serviceWorker"in navigator&&window.addEventListener("load",async()=>{Ae=await navigator.serviceWorker.register("/webrtc/service-worker.js").catch(t=>console.log("ServiceWorker registration failed:",t))});const pt="modulepreload",gt=function(e){return"/webrtc/"+e},Ne={},be=function(t,n,o){let r=Promise.resolve();if(n&&n.length>0){let s=function(u){return Promise.all(u.map(p=>Promise.resolve(p).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),f=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));r=s(n.map(u=>{if(u=gt(u),u in Ne)return;Ne[u]=!0;const p=u.endsWith(".css"),d=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${d}`))return;const a=document.createElement("link");if(a.rel=p?"stylesheet":pt,p||(a.as="script"),a.crossOrigin="",a.href=u,f&&a.setAttribute("nonce",f),document.head.appendChild(a),p)return new Promise((m,l)=>{a.addEventListener("load",m),a.addEventListener("error",()=>l(new Error(`Unable to preload CSS for ${u}`)))})}))}function i(s){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=s,window.dispatchEvent(c),!c.defaultPrevented)throw s}return r.then(s=>{for(const c of s||[])c.status==="rejected"&&i(c.reason);return t().catch(i)})};function yt(e,t,n){const o=JSON.parse(window.localStorage.getItem("userInfo")),r="EoIG3R1I4JdyS4L1",i={drone:null,room:null};let s=null,c=null,f=0;const u=15e3;function p(){s=new ScaleDrone(r,{data:{userInfo:o}}),c=s.subscribe(e),i.drone=s,i.room=c,s.on("open",m=>{f=0,t&&t(m)}),c.on("message",m=>n&&n(m)),s.on("error",m=>{console.error("Scaledrone error:",m)}),s.on("close",()=>{d()}),c.on("error",m=>{console.error("Room error:",m)})}function d(){if(!navigator.onLine){window.addEventListener("online",a,{once:!0});return}const m=Math.min(1e3*Math.pow(2,f++),u);setTimeout(()=>{try{p()}catch(l){console.error("Reconnect attempt failed:",l),d()}},m)}function a(){d()}return p(),i}function g(e,t){try{let n=document.getElementById("toastContainer");n||(n=document.createElement("div"),n.id="toastContainer",document.body.appendChild(n));const o=String(e||"info").toLowerCase(),r=typeof t=="string"?t:JSON.stringify(t),i=document.createElement("div");i.classList.add("toast"),["info","warn","warning","error","success"].includes(o)?i.classList.add(o==="warning"?"warn":o):i.classList.add("info"),i.textContent=r,n.innerHTML="",n.appendChild(i),setTimeout(()=>{try{i.remove()}catch{}},3e3)}catch(n){console.error("showToast failed:",n)}}let j=[],N=null,z=null,D=null,pe=null,_=null,Me=null,L=null;function ht(){bt(),vt(),$t()}function bt(){z=document.createElement("button"),z.id="chatToggle",z.innerHTML="💬 Chat",z.title="Toggle Chat";const e=document.getElementById("switchCamera");e.parentNode.insertBefore(z,e.nextSibling),N=document.createElement("div"),N.className="chat-panel",N.innerHTML=`
    <div class="chat-header">
      <span>Chat</span>
      <button id="closeChat" style="background: none; border: none; color: var(--text-primary); font-size: 1.2rem; cursor: pointer;">×</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message">
        <div class="sender">System</div>
        <div>Welcome to the chat! Type a message below.</div>
        <div class="time">${new Date().toLocaleTimeString()}</div>
      </div>
    </div>
    <div class="chat-input">
      <div style="display:flex;gap:6px;width:100%;align-items:center;justify-content: flex-end;">
        <div id="chatToolbar" style="display:flex; gap:6px;">
          <button id="btnBold" title="Bold" style="flex:unset; padding:4px 8px;">B</button>
          <button id="btnItalic" title="Italic" style="flex:unset; padding:4px 8px;"><i>I</i></button>
          <button id="btnEmoji" title="Emoji" style="flex:unset; padding:4px 8px;">😊</button>
          <button id="btnAttach" title="Attach file" style="flex:unset; padding:4px 8px; display:none;">📎</button>
          <input id="fileInput" type="file" multiple style="display:none;" />
        </div>
        <div id="replyContext" style="display:none; font-size:0.8rem; opacity:0.8; background: var(--bg-secondary); padding:2px 6px; border-radius:6px;"></div>
      </div>
      <div id="chatEditor" contenteditable="true" placeholder="Type a message..." style="flex:1; min-height:44px; max-height:140px; overflow:auto; padding:8px; border: 1px solid var(--border-primary); border-radius: var(--radius-small); background: var(--bg-input);"></div>
      <button id="sendMessage">Send</button>
      <div id="emojiMenu" style="display:none; position:absolute; background: var(--bg-panel); padding:6px; border-radius:8px; box-shadow: var(--shadow-soft); gap:4px;"></div>
    </div>
  `,document.body.appendChild(N),D=N.querySelector("#chatEditor"),pe=N.querySelector("#fileInput"),_=N.querySelector("#replyContext"),L=N.querySelector("#emojiMenu")}function vt(){z.addEventListener("click",()=>{N.classList.toggle("active"),N.classList.contains("active")&&D.focus()}),document.getElementById("closeChat").addEventListener("click",()=>{N.classList.remove("active")}),document.getElementById("sendMessage").addEventListener("click",Oe),D.addEventListener("keypress",n=>{n.key==="Enter"&&(n.shiftKey||(n.preventDefault(),Oe()))});const t=document.getElementById("chatMessages");t.addEventListener("DOMNodeInserted",()=>{t.scrollTop=t.scrollHeight}),document.getElementById("btnBold").addEventListener("click",()=>$e("bold")),document.getElementById("btnItalic").addEventListener("click",()=>$e("italic")),document.getElementById("btnAttach").addEventListener("click",()=>pe.click()),document.getElementById("btnEmoji").addEventListener("click",It),pe.addEventListener("change",Ct)}async function Oe(){const e=(D.innerHTML||"").trim(),t=Be(e).trim().length>0;let n=await Tt();if(n=await Lt(n),!t&&n.length===0)return;const o=JSON.parse(localStorage.getItem("userInfo")||"{}"),r=o.nickname||"Anonymous",i=xt(e),s={id:Date.now(),type:"message",sender:r,senderId:o.id||"unknown",html:i,text:Be(i).slice(0,1e3),timestamp:new Date().toISOString(),replyTo:Me||null,attachments:n,reactions:{}};if(kt({type:"chat",messageData:s})>9500){g("Warning","Message too large to send. Reduce attachments or text.");return}ve(s,!0),Ke(s),Xe(s),Pt()}function ve(e,t=!1){const n=document.getElementById("chatMessages"),o=document.createElement("div");o.className=`chat-message ${t?"own":""}`,o.setAttribute("data-id",e.id);const r=new Date(e.timestamp).toLocaleTimeString();let i="";if(e.replyTo){const u=j.find(p=>p.id===e.replyTo);if(u){const p=(u.text||"").slice(0,120);i=`<div style="font-size:0.75rem; opacity:0.8; border-left:2px solid var(--border-primary); padding-left:6px; margin-bottom:4px;">Replying to <b>${G(u.sender)}</b>: ${G(p)}</div>`}}const s=(e.attachments||[]).map(u=>Mt(u)).join(""),f=e.type==="message"?`<div class="sender">${G(e.sender)}</div>
       ${i}
       <div class="content">${e.html||G(e.text||"")}</div>
       ${s}
       <div class="time">${r}</div>
       <div class="reactions" style="margin-top:6px; display:flex; gap:6px; align-items:center;">
      <button class="reactBtn" data-emoji="👍" title="Like" style="flex:unset; padding:2px 6px;">👍</button>
      <button class="reactBtn" data-emoji="❤️" title="Love" style="flex:unset; padding:2px 6px;">❤️</button>
      <button class="reactBtn" data-emoji="😂" title="Haha" style="flex:unset; padding:2px 6px;">😂</button>
      <button class="replyBtn" title="Reply" style="flex:unset; padding:2px 6px;">↩︎ Reply</button>
      <span class="reactionsDisplay" style="margin-left:auto; font-size:0.9rem;"></span>
    </div>`:"";f&&(o.innerHTML=f),n.appendChild(o),n.scrollTop=n.scrollHeight,j.push(e),j.length>100&&(j=j.slice(-100)),Nt(o,e)}function Ke(e){be(async()=>{const{drone:t}=await Promise.resolve().then(()=>Pe);return{drone:t}},void 0).then(({drone:t})=>{if(t&&t.rooms){const n=Object.keys(t.rooms)[0];n&&typeof t.publish=="function"&&(t.publish({room:n,message:{type:"chat",messageData:e,userInfo:JSON.parse(localStorage.getItem("userInfo")||"{}")}}),console.log("Chat message sent:",e))}}).catch(t=>{console.error("Failed to send chat message:",t),g("Error","Failed to send message")})}function St(e){if(e.type==="reaction"){Ye(e);return}ve(e,!1),Xe(e)}function wt(e,t){const n=JSON.parse(localStorage.getItem("userInfo")||"{}"),o={id:Date.now(),sender:n.nickname||"Anonymous",senderId:n.id||"unknown",message:t,timestamp:new Date().toISOString(),to:e};ve({...o,sender:`${o.sender} → DM`},!0),be(async()=>{const{drone:r}=await Promise.resolve().then(()=>Pe);return{drone:r}},void 0).then(({drone:r})=>{if(r&&r.rooms){const i=Object.keys(r.rooms)[0];i&&r.publish({room:i,message:{type:"dm",to:e,messageData:o,fromUserInfo:n}})}}).catch(()=>{})}function G(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function $e(e){D.focus(),document.execCommand(e,!1,null)}function It(e){var t,n;if(L)if(L.style.display==="none"||!L.style.display){L.style.display="grid",L.style.gridTemplateColumns="repeat(6, 1fr)",L.innerHTML=["😀","😂","😍","👍","🙏","🎉","🔥","😮","😢","😆","😎","❤️"].map(r=>`<button class="emojiPick" style="padding:4px; background:none; border:none; font-size:20px;">${r}</button>`).join("");const o=(n=(t=e==null?void 0:e.target)==null?void 0:t.getBoundingClientRect)==null?void 0:n.call(t);o&&(L.style.top=`${o.bottom+window.scrollY+6}px`,L.style.left=`${o.left+window.scrollX}px`),L.querySelectorAll(".emojiPick").forEach(r=>{r.addEventListener("click",()=>{Et(r.textContent),L.style.display="none",D.focus()})})}else L.style.display="none"}function Et(e){D.focus(),document.execCommand("insertText",!1,e)}function Be(e){const t=document.createElement("div");return t.innerHTML=e||"",t.textContent||t.innerText||""}function xt(e){if(!e)return"";const t=new Set(["B","STRONG","I","EM","BR","SPAN","A"]),n=document.createElement("div");n.innerHTML=e;const o=document.createTreeWalker(n,NodeFilter.SHOW_ELEMENT,null),r=[];for(;o.nextNode();){const i=o.currentNode;if(!t.has(i.nodeName)){r.push(i);continue}if([...i.attributes].forEach(s=>{const c=s.name.toLowerCase();(c.startsWith("on")||c==="style")&&i.removeAttribute(s.name)}),i.nodeName==="A"){const s=i.getAttribute("href")||"";/^https?:\/\//i.test(s)||i.removeAttribute("href"),i.setAttribute("target","_blank"),i.setAttribute("rel","noopener noreferrer")}}return r.forEach(i=>i.replaceWith(document.createTextNode(i.textContent||""))),n.innerHTML}function kt(e){try{return JSON.stringify(e).length}catch{return 0}}let W=[];function Ct(e){const t=Array.from(e.target.files||[]),n=5*1024*1024;t.forEach(o=>{if(o.size>n){g("Warning",`${o.name} is too large (max 5MB)`);return}W.push(o)}),W.length&&(_.style.display="",_.textContent=`${W.length} attachment(s) selected`)}function Tt(){if(!W.length)return Promise.resolve([]);const e=W.map(t=>new Promise(n=>{const o=new FileReader;o.onload=()=>n({name:t.name,type:t.type,size:t.size,dataUrl:o.result}),o.onerror=()=>n(null),o.readAsDataURL(t)}));return Promise.all(e).then(t=>t.filter(Boolean))}async function Lt(e){const t=[];for(const n of e)if((n.type||"").startsWith("image/")&&typeof n.dataUrl=="string")try{const o=await At(n.dataUrl,900,900,.7);t.push({...n,dataUrl:o})}catch{t.push(n)}else t.push(n);return t}function At(e,t=900,n=900,o=.7){return new Promise((r,i)=>{const s=new Image;s.onload=()=>{let{width:c,height:f}=s;const u=Math.min(1,t/c,n/f),p=Math.max(1,Math.floor(c*u)),d=Math.max(1,Math.floor(f*u)),a=document.createElement("canvas");a.width=p,a.height=d,a.getContext("2d").drawImage(s,0,0,p,d);try{const l=a.toDataURL("image/jpeg",o);r(l)}catch{r(e)}},s.onerror=i,s.src=e})}function Mt(e){const t=G(e.name||"file");return(e.type||"").startsWith("image/")?`<div style="margin-top:6px;"><img src="${e.dataUrl}" alt="${t}" style="max-width:200px; border-radius:6px;" /></div>`:`<div style="margin-top:6px;"><a href="${e.dataUrl}" download="${t}">📎 ${t}</a></div>`}function Pt(){D.innerHTML="",W=[],Me=null,_.style.display="none",_.textContent="",pe.value=""}function Nt(e,t){const n=e.querySelector(".replyBtn"),o=e.querySelectorAll(".reactBtn");n&&n.addEventListener("click",()=>{Me=t.id,_.style.display="",_.textContent=`Replying to ${t.sender}: ${(t.text||"").slice(0,80)}`,D.focus()}),o.forEach(r=>{r.addEventListener("click",()=>{const i=r.getAttribute("data-emoji");Ot(t.id,i)})}),Ge(e,t.reactions||{})}function Ot(e,t){const n=JSON.parse(localStorage.getItem("userInfo")||"{}"),o={id:Date.now(),type:"reaction",messageId:e,emoji:t,userId:n.id,userName:n.nickname,timestamp:new Date().toISOString()};Ye(o),Ke(o)}function Ye(e){const t=j.findIndex(i=>i.id===e.messageId);if(t===-1)return;const n=j[t];n.reactions||(n.reactions={});const o=e.emoji;n.reactions[o]||(n.reactions[o]=new Set),Array.isArray(n.reactions[o])&&(n.reactions[o]=new Set(n.reactions[o])),n.reactions[o].add(e.userId||"unknown");const r=document.querySelector(`.chat-message[data-id="${n.id}"]`);r&&Ge(r,n.reactions),Bt(n)}function Ge(e,t){const n=e.querySelector(".reactionsDisplay");if(!n)return;const o=[];Object.keys(t||{}).forEach(r=>{const i=t[r],s=i instanceof Set?i.size:Array.isArray(i)?i.length:0;s>0&&o.push(`${r} ${s}`)}),n.textContent=o.join("  ")}function Z(){return`chat_history_${localStorage.getItem("roomName")||"observable-e7b2d4"}`}function $t(){try{const e=localStorage.getItem(Z());if(!e)return;(JSON.parse(e)||[]).forEach(n=>{n.reactions&&Object.keys(n.reactions).forEach(o=>{Array.isArray(n.reactions[o])&&(n.reactions[o]=new Set(n.reactions[o]))}),ve(n,n.senderId===JSON.parse(localStorage.getItem("userInfo")||"{}").id)})}catch{}}function Xe(e){try{const t=localStorage.getItem(Z()),n=t?JSON.parse(t):[];n.push(Qe(e)),localStorage.setItem(Z(),JSON.stringify(n.slice(-200)))}catch{}}function Bt(e){try{const t=localStorage.getItem(Z()),n=t?JSON.parse(t):[],o=n.findIndex(r=>r.id===e.id);o!==-1&&(n[o]=Qe(e)),localStorage.setItem(Z(),JSON.stringify(n))}catch{}}function Qe(e){const t=JSON.parse(JSON.stringify(e));return t.reactions&&Object.keys(t.reactions).forEach(n=>{t.reactions[n]instanceof Set&&(t.reactions[n]=Array.from(t.reactions[n]))}),t}const S=[],Te=new Set,ae=JSON.parse(window.localStorage.getItem("userInfo")),v={},P={};let ce,ee=null,y=null,V=null,Y=null;const B={onChange:null,set(e){typeof this.onChange=="function"&&this.onChange(e)}},Rt=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],Dt={iceServers:Rt};function Ze(e,t){ce=e;const n=localStorage.getItem("roomName")||"observable-e7b2d4";Y=yt(n,o,s),y=Y.drone,V=Y.room,window.addEventListener("online",()=>{g("Info","Network connected. Attempting to reconnect..."),B.set("reconnecting"),p(t)}),window.addEventListener("offline",()=>{g("Error","Network disconnected. Trying to recover..."),B.set("disconnected")});function o(d){if(d)return console.error(d);y=Y.drone,V=Y.room,c(t),p(t),B.set("connected"),console.log("Connected to Scaledrone")}function r(d,a){P[d]||(P[d]=[]);const m=v[d];if(m&&m.remoteDescription&&m.remoteDescription.type)try{m.addIceCandidate(new RTCIceCandidate(a))}catch(l){console.warn("addIceCandidate failed, queueing:",l),P[d].push(a)}else P[d].push(a)}async function i(d){const a=v[d];if(!a||!a.remoteDescription||!P[d]||P[d].length===0)return;const m=P[d];for(;m.length;){const l=m.shift();try{await a.addIceCandidate(new RTCIceCandidate(l))}catch(b){console.warn("Failed to add queued ICE candidate:",b)}}}function s(d){var b,C,E,O;const{data:a}=d||{},m=(d==null?void 0:d.member)||{},l=(b=d==null?void 0:d.member)==null?void 0:b.id;if(a&&y&&!(!l||l===y.clientId))switch(a.type){case"offer":f(l,!1,t),v[l].setRemoteDescription(new RTCSessionDescription(a.offer)).then(async()=>{const I=await v[l].createAnswer();await v[l].setLocalDescription(I),y.publish({room:n,message:{type:"answer",answer:I,to:l,userInfo:ae}}),await i(l)});break;case"answer":a.to===y.clientId&&v[l]&&v[l].setRemoteDescription(new RTCSessionDescription(a.answer)).then(async()=>{await i(l)});break;case"candidate":a.to===y.clientId&&r(l,a.candidate);break;case"leave":console.log(l,"has left the room");const x=S.findIndex(I=>m.id===I.id),H=document.getElementById(l);H&&(H.parentElement.remove(),x>-1&&g("Info",S[x].clientData.userInfo.nickname+" has left the room!")),S.splice(x,1),v[l]&&(v[l].close(),delete v[l]),delete P[l];break;case"join":S.find(I=>I.id===m.id)||S.push(m),console.log(l,"has joined the room"),f(l,!0,t);break;case"screenShare":{const I=document.getElementById(l);I&&(a.isShared===!0?I.setAttribute("screenShare","true"):I.removeAttribute("screenShare"))}break;case"chat":a.messageData&&St(a.messageData);break;case"dm":try{a.to===y.clientId&&a.messageData&&be(async()=>{const{receiveDirectMessage:I}=await Promise.resolve().then(()=>nn);return{receiveDirectMessage:I}},void 0).then(({receiveDirectMessage:I})=>{typeof I=="function"&&I(a.messageData,a.fromUserInfo)}).catch(()=>{})}catch{}break;case"invite":try{if(a.to===y.clientId&&a.roomName){const I=((O=(E=(C=S.find(ft=>ft.id===l))==null?void 0:C.clientData)==null?void 0:E.userInfo)==null?void 0:O.nickname)||"Someone";confirm(`${I} invited you to join room "${a.roomName}". Join now?`)&&(localStorage.setItem("roomName",a.roomName),g("Info",`Joining room ${a.roomName}...`),setTimeout(()=>location.reload(),300))}}catch{}break;default:console.warn("Unknown data type:",a.type),g("Warning","Unknown data type: "+a.type)}}function c(d){V&&(V.on("members",a=>{console.log("Members connected:",a),a.forEach(m=>{m.id!==y.clientId&&(S.find(l=>l.id===m.id)||S.push(m),v[m.id]||f(m.id,!0,d))}),Ie()}),V.on("member_join",a=>{var m;S.find(l=>l.id===a.id)||S.push(a),console.log("Member joined:",(m=a.clientData)==null?void 0:m.userInfo.nickname),v[a.id]||f(a.id,!1,d),Ie()}),V.on("member_leave",a=>{var b,C,E;const m=S.findIndex(O=>O.id===a.id);console.log("Member left:",(E=(C=(b=S[m])==null?void 0:b.clientData)==null?void 0:C.userInfo)==null?void 0:E.nickname);const l=document.getElementById(a.id);l&&(l.parentElement.remove(),m>-1&&g("Info",S[m].clientData.userInfo.nickname+" has left the room!")),S.splice(m,1),v[a.id]&&(v[a.id].close(),delete v[a.id]),delete P[a.id],Ie()}))}async function f(d,a,m){if(v[d]&&v[d].connectionState&&v[d].connectionState!=="closed")return;const l=ee=new RTCPeerConnection(Dt);if(ce&&ce.getTracks().forEach(b=>l.addTrack(b,ce)),l.onicecandidate=b=>{b.candidate&&y.publish({room:n,message:{type:"candidate",candidate:b.candidate,to:d,userInfo:ae}})},l.oniceconnectionstatechange=async()=>{if(l.iceConnectionState==="failed")B.set("reconnecting"),g("Error","Connection failed. Attempting ICE restart..."),await u(l,d,n);else if(l.iceConnectionState==="disconnected")B.set("reconnecting"),g("Error","Connection disconnected. Retrying..."),await u(l,d,n);else if(l.iceConnectionState==="closed"){const b=document.getElementById(d);b&&b.remove(),g("Info","User has left the room!")}},l.onconnectionstatechange=async()=>{l.connectionState==="connected"&&B.set("connected"),(l.connectionState==="failed"||l.connectionState==="disconnected")&&(B.set("reconnecting"),await u(l,d,n))},l.onnegotiationneeded=()=>{},l.onsignalingstatechange=()=>{},l.ontrack=b=>{var E,O,x;m(b.streams[0],d,((x=(O=(E=S.find(H=>H.id===d))==null?void 0:E.clientData)==null?void 0:O.userInfo)==null?void 0:x.nickname)||"");const C=S.findIndex(H=>H.id===d);C>-1&&g("Info",S[C].clientData.userInfo.nickname+" has joined the room!")},a){const b=await it(l);b&&y.publish({room:n,message:{type:"offer",offer:b,to:d,userInfo:ae}})}v[d]=l}async function u(d,a,m){try{const l=await d.createOffer({iceRestart:!0});await d.setLocalDescription(l),y.publish({room:m,message:{type:"offer",offer:l,to:a,userInfo:ae}})}catch(l){console.error("ICE restart failed:",l),g("Error","ICE restart failed. Will attempt full reconnection."),p(t)}}function p(d){try{Object.keys(v).forEach(a=>{try{v[a]&&(v[a].close(),delete v[a])}catch{}}),Object.keys(P).forEach(a=>delete P[a]),S.forEach(a=>{y&&a.id!==y.clientId&&f(a.id,!0,d)})}catch(a){console.error("Reconnect attempt failed:",a)}}}function et(){return v}function tt(e){var t,n;try{if(!e)return"";const o=S.find(r=>(r==null?void 0:r.id)===e);return((n=(t=o==null?void 0:o.clientData)==null?void 0:t.userInfo)==null?void 0:n.nickname)||""}catch{return""}}function Ie(){try{Te.forEach(e=>{try{e(te())}catch{}});try{const e=localStorage.getItem("roomName")||"observable-e7b2d4",t=te().map(n=>{var o;return{id:n.id,nickname:((o=n.userInfo)==null?void 0:o.nickname)||""}});localStorage.setItem(`rooms_members_${e}`,JSON.stringify(t))}catch{}}catch{}}function nt(e){if(typeof e=="function"){Te.add(e);try{e(te())}catch{}return()=>Te.delete(e)}return()=>{}}function te(){return S.filter(e=>!!e&&e.id!==(y==null?void 0:y.clientId)).map(e=>{var t;return{id:e.id,userInfo:((t=e.clientData)==null?void 0:t.userInfo)||{}}})}function ot(){if(!!document.getElementById("localVideo")){if(typeof window<"u"){const n=new Event("online");window.dispatchEvent(n)}}else g("Warning","Start the call first to reconnect.")}const Pe=Object.freeze(Object.defineProperty({__proto__:null,connectionStatus:B,get drone(){return y},getMembers:te,getPeerConnections:et,getPeerName:tt,manualReconnect:ot,get pcInfo(){return ee},get room(){return V},setupRoom:Ze,subscribeMembers:nt},Symbol.toStringTag,{value:"Module"})),Re=JSON.parse(window.localStorage.getItem("userInfo"));let ne=0,oe=0,h=null,re=0,Ee="user";const A=document.querySelector("#quality"),M=document.querySelector("#framerate"),k=document.querySelector("#shareScreen"),U=document.querySelector("#muteVideo"),J=document.querySelector("#switchCamera");A&&A.addEventListener("click",async e=>{var r;if(e.target.tagName!=="INPUT"||!h)return;const t=(r=A.querySelector("input:checked"))==null?void 0:r.value;if(!t)return;const[n,o]=t.split("x").map(Number);await se(n,o,re)});M&&M.addEventListener("click",async e=>{var o;if(e.target.tagName!=="INPUT"||!h)return;const t=(o=M.querySelector("input:checked"))==null?void 0:o.value;if(!t)return;const n=Number(t);await se(ne,oe,n)});k&&k.addEventListener("click",async e=>{const t=document.querySelector("#localVideo");if(e.target.setAttribute("disabled","true"),e.target.getAttribute("isShared")==="true"){if(e.target.textContent="🖥️ Share Screen",e.target.setAttribute("isShared","false"),U==null||U.removeAttribute("disabled"),A==null||A.removeAttribute("disabled"),M==null||M.removeAttribute("disabled"),J==null||J.removeAttribute("disabled"),e.target.removeAttribute("disabled"),t==null||t.removeAttribute("screenShare"),await se(ne,oe,re),y){const n=Object.keys(y.rooms)[0];y.publish({room:n,message:{type:"screenShare",from:y.clientId,isShared:!1,userInfo:Re}})}return}if(!h){e.target.removeAttribute("disabled");return}try{const n=await zt();if(!n)return;if(e.target.textContent="🖥️ Stop Sharing",e.target.setAttribute("isShared","true"),U==null||U.setAttribute("disabled","true"),A==null||A.setAttribute("disabled","true"),M==null||M.setAttribute("disabled","true"),J==null||J.setAttribute("disabled","true"),t==null||t.setAttribute("screenShare","true"),h){const r=h.getVideoTracks()[0];r&&r.stop(),h.getVideoTracks().forEach(i=>h.removeTrack(i))}const o=n.getVideoTracks()[0];if(h.addTrack(o),await rt(),y){const r=Object.keys(y.rooms)[0];y.publish({room:r,message:{type:"screenShare",from:y.clientId,isShared:!0,userInfo:Re}})}}catch(n){console.error("Error starting screen share:",n),g("Error","Error starting screen share")}finally{e.target.removeAttribute("disabled")}});async function qt(e,t,n,o){h&&h.getVideoTracks().forEach(r=>{h.removeTrack(r),r.stop()});try{const r={video:{width:{ideal:e},height:{ideal:t},frameRate:{ideal:n},facingMode:{ideal:o}},audio:!h};return await navigator.mediaDevices.getUserMedia(r)}catch(r){return console.error("Failed to get media stream:",r),g("Error","Failed to get media stream!"),null}}async function se(e,t,n,o=!1,r=!1){var f;oe=t,ne=e,re=n;const i=r&&((f=h==null?void 0:h.getVideoTracks()[0])==null?void 0:f.getSettings().facingMode)||"user";Ee=r?i==="user"?"environment":"user":Ee;const s=await qt(ne,oe,re,Ee);if(!s)return!1;const c=s.getVideoTracks()[0];if(h){const u=h.getVideoTracks()[0];u&&(u.stop(),h.removeTrack(u)),h.addTrack(c)}else h=s;if(o){const u=document.querySelector("#localVideo");u&&h.getVideoTracks()[0]&&(u.setAttribute("mode",h.getVideoTracks()[0].getSettings().facingMode||"user"),u.srcObject=h)}return await rt(),!0}function Vt(){se(ne,oe,re,!0,!0)}async function jt(){var i;const e=((i=A==null?void 0:A.querySelector("input:checked"))==null?void 0:i.value)||"640x480",[t,n]=e.split("x").map(Number),o=M==null?void 0:M.querySelector("input:checked"),r=Number((o==null?void 0:o.value)||30);return await se(t,n,r),h}function De(e,t,n=!1,o=""){const r=document.createElement("div");r.className="participant",r.setAttribute("data-id",t),r.innerHTML=`<video autoplay playsinline></video>
    <div class="overlay">
      <span class="name">${o}</span>
      <div class="controls">
        <button class="muteAudio">🔇</button>
        <button class="muteVideo">🎥</button>
        <button class="switchCamera">🔄</button>
        <button class="hangup">📞</button>
      </div>
    </div>
  </div>`;const i=r.querySelector("video");i.srcObject=e,i.id=t,i.autoplay=!0,i.playsInline=!0,i.setAttribute("memberId",t);const s=document.getElementsByClassName("Channel")[0];s&&(n?(i.muted=!0,s.appendChild(r),h!=null&&h.getVideoTracks()[0]&&i.setAttribute("mode",h.getVideoTracks()[0].getSettings().facingMode||"user"),i.click()):(i.setAttribute("isRemote","true"),s.prepend(r),_t(e,i)))}function _t(e,t){const o=new AudioContext,r=o.createMediaStreamSource(e),i=o.createGain();i.gain.value=2.5;const s=o.createAnalyser();s.fftSize=256;const c=s.frequencyBinCount,f=new Uint8Array(c);r.connect(s),r.connect(i).connect(o.destination),t.srcObject=e,t.volume=0;let u=!1,p=0;const d=500,a=Ht(t),m=setInterval(()=>{s.getByteFrequencyData(f);let l=0;for(let E=0;E<f.length;E++)l+=f[E];const b=l/f.length,C=Date.now();Ut(a,b),b>20?(p=C,u||(u=!0,qe(!0,t),Ve(t.id,!0))):C-p>d&&u&&(u=!1,qe(!1,t),Ve(t.id,!1))},100);t.addEventListener("removed",()=>{clearInterval(m),o.close()})}function qe(e,t){const n=t.closest(".participant");n&&(e?(n.classList.add("speaking"),n.style.transform="scale(1.02)",n.style.boxShadow="0 0 20px rgba(30, 144, 255, 0.6)"):(n.classList.remove("speaking"),n.style.transform="",n.style.boxShadow=""))}function Ht(e){const t=e.closest(".participant");if(!t)return null;const n=document.createElement("div");return n.className="audio-level-indicator",n.innerHTML=`
    <div class="audio-bars">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
  `,t.appendChild(n),n}function Ut(e,t){if(!e)return;const n=e.querySelectorAll(".bar"),o=Math.min(t/50,1),r=Math.ceil(o*n.length);n.forEach((i,s)=>{s<r?(i.style.height=`${20+s*5}px`,i.style.opacity="1"):(i.style.height="5px",i.style.opacity="0.3")})}function Ve(e,t){console.log(`Participant ${e} is ${t?"speaking":"not speaking"}`)}async function rt(){const e=ee;if(!e)return;const t=e.getSenders().find(n=>n.track&&n.track.kind==="video");if(t){const n=t.track;try{n.stop();const r=h.getVideoTracks()[0];await t.replaceTrack(r),await it(e)}catch(o){if(console.error("Error updating local video stream:",o),g("Error","Error updating local video stream!"),t&&n&&t.replaceTrack)try{await t.replaceTrack(n)}catch{}}}else console.log("No video sender found.")}function Jt(){const e=navigator.userAgent,t=/iPhone|iPad|iPod/.test(e),n=/Android/.test(e),o=/Safari/.test(e)&&!/Chrome|CriOS|FxiOS/.test(e),r=/Chrome/.test(e)&&!/Edge|Edg/.test(e),i=/Firefox/.test(e),s=/Edge|Edg/.test(e);return t&&o?"H264":t&&(r||i)||n&&r||n&&i?"VP8":o&&!t?"H264":"VP8"}function Ft(){const e=[];if(RTCRtpReceiver.getCapabilities&&RTCRtpReceiver.getCapabilities("video")){const t=RTCRtpReceiver.getCapabilities("video");t.codecs&&t.codecs.forEach(n=>{n.mimeType.includes("VP8")&&e.push("VP8"),n.mimeType.includes("VP9")&&e.push("VP9"),n.mimeType.includes("H264")&&e.push("H264"),n.mimeType.includes("AV1")&&e.push("AV1")})}return[...new Set(e)]}function je(e,t,n="video"){const o=e.split(`\r
`),r=o.findIndex(u=>u.startsWith(`m=${n}`));if(r===-1)return e;const i=new RegExp(`a=rtpmap:(\\d+)\\s${t}`,"i"),s=o.filter(u=>i.test(u)).map(u=>u.match(i)[1]);if(s.length===0)return e;const c=o[r].split(" "),f=s.concat(c.slice(3).filter(u=>!s.includes(u)));return o[r]=[...c.slice(0,3),...f].join(" "),o.join(`\r
`)}async function it(e){try{const t=await e.createOffer(),n=Ft(),o=Jt();console.log("Supported codecs:",n),console.log("Preferred codec:",o);let r=t;if(n.includes(o)){const i=je(t.sdp,o);r={type:t.type,sdp:i}}else{console.warn(`Preferred codec ${o} not supported, using default`);const i=["VP8","H264","VP9"];for(const s of i)if(n.includes(s)){const c=je(t.sdp,s);r={type:t.type,sdp:c},console.log(`Using fallback codec: ${s}`);break}}return await e.setLocalDescription(r),r}catch(t){console.error("Failed to create/set local description:",t),g("Error","Failed to negotiate video. Retrying may help.");try{const n=await e.createOffer();return await e.setLocalDescription(n),n}catch{return null}}}function st(){const e=navigator.userAgent,t=/iPhone|iPad|iPod/.test(e),n=/Android/.test(e),o=/Safari/.test(e)&&!/Chrome|CriOS|FxiOS/.test(e),r=/Chrome/.test(e)&&!/Edge|Edg/.test(e),i=/Firefox/.test(e),s=/Edge|Edg/.test(e);if(t)return console.log("Screen sharing is not supported on iOS devices via web apps."),k&&(k.style.display="none",k.setAttribute("disabled","true")),!1;if(n)return r&&"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices?(console.log("Screen sharing is supported on Android Chrome."),!0):(console.log("Screen sharing is not supported on this Android browser."),k&&(k.style.display="none",k.setAttribute("disabled","true")),!1);if("mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices){if(o)return console.log("Screen sharing is supported on desktop Safari (limited)."),!0;if(r||i||s)return console.log("Screen sharing is fully supported on this desktop browser."),!0}return console.log("Screen sharing is not supported on this platform."),k&&(k.style.display="none",k.setAttribute("disabled","true")),!1}async function zt(){try{if(!st())return g("Error","Screen sharing is not supported on this device."),null;const e={video:{mediaSource:"screen",width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},audio:!0},t=await navigator.mediaDevices.getDisplayMedia(e);return t.getVideoTracks()[0].addEventListener("ended",()=>{console.log("Screen sharing ended by user"),k&&(k.textContent="🖥️ Share Screen",k.setAttribute("isShared","false"),k.removeAttribute("disabled"))}),t}catch(e){return console.error("Screen sharing error:",e),e.name==="NotAllowedError"?g("Error","Screen sharing permission denied."):e.name==="NotSupportedError"?g("Error","Screen sharing not supported on this device."):g("Error","Failed to start screen sharing."),null}}st();function Wt(e){try{if(!e||typeof e!="string")return new Uint8Array;const t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/\-/g,"+").replace(/_/g,"/"),o=atob(n),r=new Uint8Array(o.length);for(let i=0;i<o.length;++i)r[i]=o.charCodeAt(i);return r}catch{return new Uint8Array}}const at={default:{name:"Default",colors:{"--bg-primary":"#0f2027","--bg-secondary":"#203a43","--bg-tertiary":"#2c5364","--bg-panel":"rgba(255, 255, 255, 0.05)","--text-primary":"#ffffff","--border-primary":"rgba(255, 255, 255, 0.15)"}},dark:{name:"Dark",colors:{"--bg-primary":"#0b0b0b","--bg-secondary":"#1a1a1a","--bg-tertiary":"#2d2d2d","--text-primary":"#ffffff","--border-primary":"rgba(255, 255, 255, 0.1)"}},light:{name:"Light",colors:{"--bg-primary":"#f8fafc","--bg-secondary":"#e2e8f0","--bg-tertiary":"#cbd5e1","--text-primary":"#1e293b","--border-primary":"rgba(0, 0, 0, 0.1)"}},darkcyan:{name:"Dark Cyan",colors:{"--bg-primary":"#052b2b","--bg-secondary":"#074040","--bg-tertiary":"#0b5a5a","--text-primary":"#ffffff","--border-primary":"rgba(255, 255, 255, 0.15)"}}};function ct(e){e==="purple"&&(e="darkcyan");const t=at[e];if(!t)return;const n=document.documentElement;Object.entries(t.colors).forEach(([o,r])=>{n.style.setProperty(o,r)}),localStorage.setItem("selectedTheme",e)}function lt(){const e=localStorage.getItem("selectedTheme")||"default";return e==="purple"?"darkcyan":e}function Kt(){const e=lt();return ct(e),e}function Yt(){const e=document.createElement("div");e.id="themeSelector",e.innerHTML=`
    <label for="themeSelect">Theme:</label>
    <select id="themeSelect">
      ${Object.entries(at).map(([n,o])=>`<option value="${n}">${o.name}</option>`).join("")}
    </select>
  `;const t=e.querySelector("#themeSelect");return t.value=lt(),t.addEventListener("change",n=>{ct(n.target.value)}),e}let $=null,F=null,Gt=null;function dt(){try{if(document.getElementById("usersToggle"))return;Xt(),Gt=nt(_e);try{_e(te())}catch{}try{Q()}catch{}}catch(e){console.error("Failed to initialize users panel:",e)}}function Xt(){F=document.createElement("button"),F.id="usersToggle",F.innerHTML="👥 Users",F.title="Show Participants";const e=document.getElementById("pipToggle")||document.getElementById("hangup");e.parentNode.insertBefore(F,e.nextSibling),$=document.createElement("div"),$.className="chat-panel",$.style.zIndex="1003",$.style.right="unset",$.style.left="unset",$.innerHTML=`
    <div class="chat-header"><span>Participants</span>
      <button id="closeUsers" style="background: none; border: none; color: var(--text-primary); font-size: 1.2rem; cursor: pointer;">×</button>
    </div>
    <div class="chat-input" style="padding:6px; gap:6px;">
      <input id="customRoomName" placeholder="Enter room name" maxlength="100" />
      <button id="setRoom">Set Room</button>
    </div>
    <div class="chat-messages" id="usersList" style="gap:6px"></div>
    <div class="chat-messages" id="roomsList" style="gap:6px; margin-top:6px;"></div>
  `,document.body.appendChild($),F.addEventListener("click",()=>$.classList.toggle("active")),$.querySelector("#closeUsers").addEventListener("click",()=>$.classList.remove("active")),document.getElementById("setRoom").addEventListener("click",()=>{const n=(document.getElementById("customRoomName").value||"").trim();n&&(localStorage.setItem("roomName",n),g("Success",`Room set to ${n}. Share invite from list.`),Qt(n),Q())})}function _e(e){try{const t=document.getElementById("usersList");if(!t)return;t.innerHTML="";const n=JSON.parse(localStorage.getItem("userInfo")||"{}").id;e.filter(o=>o.id!==void 0&&o.id!==null&&o.id!==n).forEach(o=>{const{userInfo:r={}}=o,i=document.createElement("div");i.className="chat-message";const s=r.nickname||"Unknown",c=r.gender||"-",f=r.status||"",u=r.age||"";i.innerHTML=`
        <div class="sender">${R(s)}</div>
        <div style="font-size: 0.85rem; opacity: 0.9;">${R(c)}${f?" • "+R(f):""}${u?" • "+R(String(u)):""}</div>
        <div style="margin-top:6px; display:flex; gap:6px;">
          <button class="dmBtn" data-id="${o.id}" style="flex:unset; padding:4px 8px;">Message</button>
          <button class="inviteBtn" data-id="${o.id}" style="flex:unset; padding:4px 8px;">Invite</button>
        </div>
      `,t.appendChild(i)}),t.querySelectorAll(".dmBtn").forEach(o=>{o.addEventListener("click",()=>{const r=o.getAttribute("data-id"),i=prompt("Send a direct message:");if(!(!i||!i.trim()))try{wt(r,i.trim()),g("Success","Message sent")}catch{g("Error","Failed to send message")}})}),t.querySelectorAll(".inviteBtn").forEach(o=>{o.addEventListener("click",()=>{const r=o.getAttribute("data-id"),i=(localStorage.getItem("roomName")||"").trim();if(!i){g("Warning","Set a room name first");return}be(async()=>{const{drone:s}=await Promise.resolve().then(()=>Pe);return{drone:s}},void 0).then(({drone:s})=>{if(s&&s.rooms){const c=Object.keys(s.rooms)[0];s.publish({room:c,message:{type:"invite",to:r,roomName:i,fromUserInfo:JSON.parse(localStorage.getItem("userInfo")||"{}")}}),g("Success",`Invite sent to join ${i}`)}}).catch(()=>g("Error","Failed to send invite"))})})}catch(t){console.error("Render members failed:",t)}}function ie(){try{const e=localStorage.getItem("rooms_list");return e?JSON.parse(e):[]}catch{return[]}}function Se(e){try{localStorage.setItem("rooms_list",JSON.stringify(e))}catch{}}function Qt(e){const t=ie();t.includes(e)||t.push(e),Se(t)}function Zt(e){const t=ie().filter(n=>n!==e);Se(t);try{localStorage.removeItem(`rooms_members_${e}`)}catch{}}function en(){ie().forEach(t=>{try{localStorage.removeItem(`rooms_members_${t}`)}catch{}}),Se([])}function Q(){const e=document.getElementById("roomsList");if(!e)return;const t=ie();e.innerHTML="";const n=localStorage.getItem("roomName")||"observable-e7b2d4",o=document.createElement("div");o.className="chat-message",o.innerHTML='<div class="sender">Rooms</div>',e.appendChild(o),t.forEach(s=>{const c=document.createElement("div");c.className="chat-message";const u=JSON.parse(localStorage.getItem(`rooms_members_${s}`)||"[]").map(p=>p.nickname||p.id).join(", ");c.innerHTML=`
      <div style="display:flex; align-items:center; gap:6px;">
        <div style="flex:1;">
          <div><b>${R(s)}</b> ${s===n?"(current)":""}</div>
          <div style="font-size:0.8rem; opacity:0.85;">Users: ${R(u)}</div>
        </div>
        <button class="roomSwitch" data-room="${R(s)}" style="flex:unset; padding:4px 8px;">Join</button>
        <button class="roomEdit" data-room="${R(s)}" style="flex:unset; padding:4px 8px;">Edit</button>
        <button class="roomDelete" data-room="${R(s)}" style="flex:unset; padding:4px 8px;">Delete</button>
      </div>`,e.appendChild(c)});const r=document.createElement("div");r.className="chat-message",r.innerHTML='<div style="display:flex; gap:6px; justify-content:flex-end;"><button id="roomsClearAll" style="flex:unset; padding:4px 8px;">Clear All</button></div>',e.appendChild(r),e.querySelectorAll(".roomSwitch").forEach(s=>s.addEventListener("click",()=>{const c=s.getAttribute("data-room");c&&(localStorage.setItem("roomName",c),g("Info",`Joining ${c}...`),setTimeout(()=>location.reload(),300))})),e.querySelectorAll(".roomEdit").forEach(s=>s.addEventListener("click",()=>{const c=s.getAttribute("data-room"),f=prompt("Rename room",c);if(!f||!f.trim())return;const u=ie(),p=u.indexOf(c);p!==-1&&(u[p]=f.trim()),Se(u);const d=localStorage.getItem(`rooms_members_${c}`);d&&(localStorage.setItem(`rooms_members_${f.trim()}`,d),localStorage.removeItem(`rooms_members_${c}`)),(localStorage.getItem("roomName")||"")===c&&localStorage.setItem("roomName",f.trim()),Q()})),e.querySelectorAll(".roomDelete").forEach(s=>s.addEventListener("click",()=>{const c=s.getAttribute("data-room");c&&confirm(`Delete room ${c}?`)&&(Zt(c),Q())}));const i=document.getElementById("roomsClearAll");i&&i.addEventListener("click",()=>{confirm("Clear all rooms?")&&(en(),Q())})}function tn(e,t){const n=(t==null?void 0:t.nickname)||"Unknown";g("Info",`DM from ${n}: ${e.message}`)}function R(e){const t=document.createElement("div");return t.textContent=e==null?"":String(e),t.innerHTML}const nn=Object.freeze(Object.defineProperty({__proto__:null,initializeUsersPanel:dt,receiveDirectMessage:tn},Symbol.toStringTag,{value:"Module"})),ut=/iphone|ipod|ipad/i.test(navigator.userAgent),on=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let T=null;const rn=document.querySelector("#muteVideo"),sn=document.querySelector("#muteAudio"),ge=document.querySelector("#userInfoModal"),He=document.querySelector("#retryBtn"),K=document.querySelector("#connectionStatus"),le=K==null?void 0:K.querySelector(".text");let Le=null,xe=null,ke=!0;const de=document.getElementById("pipToggle"),ye=window.location.hostname==="localhost"?"http://localhost:3000/":"https://web-push-3zaz.onrender.com/",X=document.querySelector("#push");function an(e,t){var n;try{if(!navigator.onLine)return;const o=((n=JSON.parse(window.localStorage.getItem("userInfo")))==null?void 0:n.id)||0,r=new AbortController,i=setTimeout(()=>r.abort(),5e3);fetch(ye+"notifyAll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({initiator:o,title:e,body:t}),signal:r.signal}).catch(s=>{console.warn("NotifyAll failed (ignored):",(s==null?void 0:s.message)||s)}).finally(()=>clearTimeout(i))}catch(o){console.warn("NotifyAll threw (ignored):",(o==null?void 0:o.message)||o)}}async function cn(){if(!JSON.parse(window.localStorage.getItem("userInfo")))return!1;if(Notification.permission==="granted"){const t=localStorage.getItem("subscription");if(!t){const r=await Ae.pushManager.getSubscription();return r&&(await r.unsubscribe(),g("Info","Notification unsubscribed locally!, Please resubscribe.")),!1}return(await(await fetch(ye+"isPushSubscribed",{method:"POST",headers:{"Content-Type":"application/json"},body:t})).json()).isSubscribed}}K&&(B.onChange=e=>{K.classList.remove("connected","reconnecting","disconnected"),K.classList.add(e),le&&(e==="connected"&&(le.textContent="Connected"),e==="reconnecting"&&(le.textContent="Reconnecting…"),e==="disconnected"&&(le.textContent="Disconnected"))});He&&He.addEventListener("click",()=>{B.set("reconnecting"),ot()});X.addEventListener("click",async e=>{const t=await fetch(ye+"vapid").catch(s=>console.log(s));if(!t)return;const{publicKey:n}=await t.json();if(X.setAttribute("disabled","true"),await Notification.requestPermission()!=="granted"){g("Error","Unable to subscribe to push notifications"),X.setAttribute("disabled","false");return}const r=await Ae.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:Wt(n)}),i={endpoint:r.toJSON().endpoint,expirationTime:r.toJSON().expirationTime,keys:{p256dh:r.toJSON().keys.p256dh,auth:r.toJSON().keys.auth,id:JSON.parse(window.localStorage.getItem("userInfo")).id}};localStorage.setItem("subscription",JSON.stringify(r)),await fetch(ye+"subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(s=>{s.status===200?g("Success","Push notifications subscribed successfully"):g("Error","Unable to subscribe to push notifications")}).catch(s=>{console.log(s),g("Error","Unable to subscribe to push notifications")}),X.style.display="none",g("Success","Push notifications subscribed successfully")},!1);setTimeout(async()=>{const e=await cn();X.style.display=e?"none":""},1e3);let q=window.localStorage.getItem("userInfo");if(!q)he();else{q=JSON.parse(q);const{nickname:e,gender:t}=q;(!e||!t)&&he()}document.querySelector("#audioOutputSelect").addEventListener("change",async()=>{const e=audioOutputSelect.value,t=document.querySelectorAll("video[isRemote]");try{for(const n of t)typeof n.setSinkId=="function"&&await n.setSinkId(e);console.log(`Audio output set to device: ${e}`)}catch(n){console.error("Error setting audio output device:",n)}});navigator.mediaDevices.addEventListener("devicechange",()=>{we()});async function we(){try{const t=(await navigator.mediaDevices.enumerateDevices()).filter(n=>n.kind==="audiooutput"||n.label.includes("headset"));t.length>0&&t.forEach(n=>{if(audioOutputSelect.querySelector(`option[value="${n.deviceId}"]`))return;const o=document.createElement("option");o.value=n.deviceId,o.text=n.label||n.kind||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(o)}),audioOutputSelect.parentElement.style.display=t.length<=1?"none":""}catch(e){console.error("Error fetching audio output devices:",e)}}document.querySelector("#controls").addEventListener("click",async e=>{const t=e.target;switch(e.target.id){case"start":t.disabled=!0,await dn(),t.disabled=!1;break;case"muteAudio":t.textContent="🔇 "+(T.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio"),T.getAudioTracks()[0].enabled=!T.getAudioTracks()[0].enabled;break;case"muteVideo":t.textContent="🎥 "+(T.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video"),T.getVideoTracks()[0].enabled=!T.getVideoTracks()[0].enabled;break;case"switchCamera":await Vt();break;case"audioOutputRefresh":we();break;case"hangup":rn.textContent="🎥 Mute Video",sn.textContent="🔇 Mute Audio",document.querySelector("#localMainVideo").classList.remove("active"),T&&(T.getTracks().forEach(o=>{o.enabled=!1}),setTimeout(()=>{T.getTracks().forEach(o=>o.stop()),T=null,y.publish({room:Object.keys(y.rooms)[0],message:{type:"leave",from:y.clientId,userInfo:q}}),document.querySelector(".Channel").innerHTML="",ee&&ee.getSenders().forEach(o=>{o.track&&o.track.stop()})},300));break;case"pipToggle":ln();break}});document.querySelector(".Channel").addEventListener("click",e=>{if(e.target.tagName!=="VIDEO")return;const t=document.getElementById("localMainVideo");t.srcObject=e.target.srcObject,t.classList.add("active"),t.style.transform=e.target.id==="localVideo"?"scale(-1, 1)":""});document.querySelector("#localMainVideo").addEventListener("dblclick",e=>{e.target.requestFullscreen()});if(de)if(!("pictureInPictureEnabled"in document&&typeof HTMLVideoElement<"u"&&"requestPictureInPicture"in HTMLVideoElement.prototype))de.style.display="none";else{const t=document.getElementById("localMainVideo");t&&(t.addEventListener("enterpictureinpicture",()=>{de.textContent="🗗 Exit PiP"}),t.addEventListener("leavepictureinpicture",()=>{de.textContent="🗔 Picture-in-Picture"}))}async function ln(){try{if(!("pictureInPictureEnabled"in document))return;const e=document.getElementById("localMainVideo");if(!e||!e.srcObject)return;if(e.paused)try{await e.play()}catch{}if(document.pictureInPictureElement){await document.exitPictureInPicture();return}document.pictureInPictureElement&&document.pictureInPictureElement!==e&&await document.exitPictureInPicture(),await e.requestPictureInPicture()}catch(e){console.error("PiP toggle failed:",e),g("Error","Unable to toggle Picture-in-Picture")}}async function dn(){var t;const e=((t=JSON.parse(window.localStorage.getItem("userInfo")))==null?void 0:t.nickname)||"No name";if(an("Video Conferencing with KiteCite","Started by "+e),T=await jt(),De(T,"localVideo",!0,"You"),Le=Date.now(),pn(),ut||we(),y){y.publish({room:Object.keys(y.rooms)[0],message:{type:"join",from:y.clientId,userInfo:q}});return}Ze(T,(n,o,r)=>{document.getElementById(o)||De(n,o,!1,r)})}ut||we();on||(document.querySelector("#switchCamera").style.display="none");Kt();const un=Yt(),Ue=document.querySelector(".controls");Ue&&Ue.insertAdjacentElement("afterend",un);const Ce=document.getElementById("pipToggle")||document.getElementById("shareScreen")||document.getElementById("hangup");if(Ce){const e=document.createElement("button");e.id="statsToggle",e.textContent="📊 Stats",e.title="Show/Hide bitrate stats",Ce.parentNode.insertBefore(e,Ce.nextSibling),e.addEventListener("click",()=>{ke=!ke;const t=document.getElementById("statsPanel");t&&(t.style.display=ke?"":"none")})}ht();dt();"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{if(e.data&&e.data.type==="NOTIFICATION_CLICK"){if(console.log("Notification clicked:",e.data.data),e.data.data.type==="chat"){const t=document.querySelector(".chat-panel");if(t){t.classList.add("active");const n=document.getElementById("chatInput");n&&n.focus()}}e.data.data.type==="call"&&e.data.data.roomId&&g("Info",`Incoming call to room: ${e.data.data.roomId}`)}});let ue;const fe=document.getElementById("install-btn");window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),ue=e,fe.style.display="flex",setTimeout(()=>{fe.style.display="none",g("Info","You can add this app to your home screen!")},15e3),fe.addEventListener("click",()=>{ue.prompt(),ue.userChoice.then(t=>{t.outcome==="accepted"?console.log("User accepted the A2HS prompt"):console.log("User dismissed the A2HS prompt"),ue=null})})});window.matchMedia("(display-mode: standalone)").matches&&(fe.style.display="none");ge.addEventListener("click",e=>{if(e.target===ge||e.target.id==="closeModal")Je();else if(e.target.id==="submit-btn"){e.stopPropagation();const t=document.querySelector("#nickname").value,n=document.querySelector("#divGender").querySelector("input:checked").value,o=document.querySelector("#status").value,r=document.querySelector("#age").value;if(!t||!n){g("Error","Please fill all the fields!");return}q={nickname:t,gender:n,status:o,age:r,id:new Date().getTime()},window.localStorage.setItem("userInfo",JSON.stringify(q)),Je()}});function he(){ge.classList.add("show-modal");const e=window.localStorage.getItem("userInfo"),t=document.querySelector("h4");e?(document.querySelector("#nickname").value=JSON.parse(e).nickname,document.querySelector("#divGender").querySelector("input[value="+JSON.parse(e).gender+"]").checked=!0,document.querySelector("#status").value=JSON.parse(e).status,document.querySelector("#age").value=JSON.parse(e).age,t.innerHTML="Video Conferencing with KiteCite"):(document.querySelector("#start").setAttribute("disabled",!0),t.innerHTML="Dear Anonymous User, Please Enter Your Details")}function Je(){const e=window.localStorage.getItem("userInfo"),t=document.querySelector("h4");ge.classList.remove("show-modal"),e?(document.querySelector("#nickname").value="",document.querySelector("#divGender").querySelector("input[value='male']").checked=!0,document.querySelector("#status").value="",document.querySelector("#age").value="",t.innerHTML="Video Conferencing with KiteCite",document.querySelector("#start").removeAttribute("disabled"),t.removeEventListener("click",he)):(document.querySelector("#start").setAttribute("disabled",!0),t.innerHTML="Dear Anonymous User, Please Enter Your Details By Clicking Here",t.addEventListener("click",he))}let w=null;function mt(){return w||(w=document.createElement("div"),w.id="statsPanel",w.style.position="fixed",w.style.bottom="10px",w.style.left="10px",w.style.zIndex="1001",w.style.background="var(--bg-card)",w.style.border="1px solid var(--border-primary)",w.style.borderRadius="8px",w.style.padding="8px 10px",w.style.fontSize="12px",w.style.maxWidth="320px",w.innerHTML='<div id="callDuration">Duration: 00:00</div><div id="overallStats"></div><div id="perPeerStats" style="margin-top:6px;"></div>',document.body.appendChild(w),yn(w),w)}function mn(e){const t=Math.floor(e/1e3),n=Math.floor(t/3600).toString().padStart(2,"0"),o=Math.floor(t%3600/60).toString().padStart(2,"0"),r=Math.floor(t%60).toString().padStart(2,"0");return n==="00"?`${o}:${r}`:`${n}:${o}:${r}`}let Fe={},me={};async function fn(){try{if(mt(),Le){const p=document.getElementById("callDuration");p&&(p.textContent=`Duration: ${mn(Date.now()-Le)}`)}const e=et();let t=0,n=0,o=0,r=0;const i=[],s=Date.now(),c=Object.entries(e);for(const[p,d]of c){if(!d||typeof d.getStats!="function")continue;const a=await d.getStats();let m=0,l=0;a.forEach(x=>{x.type==="outbound-rtp"&&!x.isRemote&&typeof x.bytesSent=="number"&&(m+=x.bytesSent),x.type==="inbound-rtp"&&!x.isRemote&&typeof x.bytesReceived=="number"&&(l+=x.bytesReceived)}),me[p]||(me[p]={sent:m,recv:l});const b=Fe[p]||{t:s,sent:m,recv:l},C=Math.max(1,s-b.t)/1e3,E=Math.max(0,(m-b.sent)*8/C),O=Math.max(0,(l-b.recv)*8/C);Fe[p]={t:s,sent:m,recv:l},t+=E,n+=O,o+=Math.max(0,m-me[p].sent),r+=Math.max(0,l-me[p].recv),i.push({peerId:p,upBps:E,downBps:O})}const f=document.getElementById("overallStats");f&&(f.textContent=`Total Up: ${We(o)} | Total Down: ${We(r)}`);const u=document.getElementById("perPeerStats");u&&(u.innerHTML=i.map(p=>{const d=tt(p.peerId)||p.peerId;return`<div>${gn(d)}: ↑ ${ze(p.upBps)} ↓ ${ze(p.downBps)}</div>`}).join(""))}catch{}}function ze(e){return isFinite(e)?e<1e3?`${e.toFixed(0)} bps`:e<1e6?`${(e/1e3).toFixed(1)} Kbps`:e<1e9?`${(e/1e6).toFixed(1)} Mbps`:`${(e/1e9).toFixed(2)} Gbps`:"0 bps"}function We(e){return isFinite(e)?e<1024?`${e.toFixed(0)} B`:e<1024*1024?`${(e/1024).toFixed(1)} KB`:e<1024*1024*1024?`${(e/1024/1024).toFixed(1)} MB`:`${(e/1024/1024/1024).toFixed(2)} GB`:"0 B"}function pn(){try{mt(),xe&&clearInterval(xe),xe=setInterval(fn,1e3)}catch{}}function gn(e){const t=document.createElement("div");return t.textContent=e==null?"":String(e),t.innerHTML}function yn(e){let t=!1,n=0,o=0;const r=(c,f)=>{const u=e.getBoundingClientRect();t=!0,n=c-u.left,o=f-u.top,e.style.right="unset",e.style.bottom="unset",e.style.transform="none",document.body.style.userSelect="none"},i=(c,f)=>{if(!t)return;const u=window.innerWidth-e.offsetWidth-4,p=window.innerHeight-e.offsetHeight-4;let d=Math.max(4,Math.min(c-n,u)),a=Math.max(4,Math.min(f-o,p));e.style.left=`${d}px`,e.style.top=`${a}px`},s=()=>{t=!1,document.body.style.userSelect=""};e.style.cursor="move",e.addEventListener("mousedown",c=>{c.button===0&&(r(c.clientX,c.clientY),c.preventDefault())}),window.addEventListener("mousemove",c=>i(c.clientX,c.clientY)),window.addEventListener("mouseup",s),e.addEventListener("touchstart",c=>{const f=c.touches[0];r(f.clientX,f.clientY)},{passive:!0}),window.addEventListener("touchmove",c=>{const f=c.touches[0];i(f.clientX,f.clientY)},{passive:!0}),window.addEventListener("touchend",s)}
