(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))r(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();let ne=null;"serviceWorker"in navigator&&window.addEventListener("load",async()=>{ne=await navigator.serviceWorker.register("/webrtc/service-worker.js").catch(t=>console.log("ServiceWorker registration failed:",t))});function Ee(e,t,n){const r=JSON.parse(window.localStorage.getItem("userInfo")),o="EoIG3R1I4JdyS4L1",i={drone:null,room:null};let c=null,f=null,b=0;const u=15e3;function w(){c=new ScaleDrone(o,{data:{userInfo:r}}),f=c.subscribe(e),i.drone=c,i.room=f,c.on("open",l=>{b=0,t&&t(l)}),f.on("message",l=>n&&n(l)),c.on("error",l=>{console.error("Scaledrone error:",l)}),c.on("close",()=>{d()}),f.on("error",l=>{console.error("Room error:",l)})}function d(){if(!navigator.onLine){window.addEventListener("online",s,{once:!0});return}const l=Math.min(1e3*Math.pow(2,b++),u);setTimeout(()=>{try{w()}catch(a){console.error("Reconnect attempt failed:",a),d()}},l)}function s(){d()}return w(),i}function p(e,t){try{let n=document.getElementById("toastContainer");n||(n=document.createElement("div"),n.id="toastContainer",document.body.appendChild(n));const r=String(e||"info").toLowerCase(),o=typeof t=="string"?t:JSON.stringify(t),i=document.createElement("div");i.classList.add("toast"),["info","warn","warning","error","success"].includes(r)?i.classList.add(r==="warning"?"warn":r):i.classList.add("info"),i.textContent=o,n.innerHTML="",n.appendChild(i),setTimeout(()=>{try{i.remove()}catch{}},3e3)}catch(n){console.error("showToast failed:",n)}}const ke="modulepreload",Ce=function(e){return"/webrtc/"+e},oe={},Te=function(t,n,r){let o=Promise.resolve();if(n&&n.length>0){let c=function(u){return Promise.all(u.map(w=>Promise.resolve(w).then(d=>({status:"fulfilled",value:d}),d=>({status:"rejected",reason:d}))))};document.getElementsByTagName("link");const f=document.querySelector("meta[property=csp-nonce]"),b=(f==null?void 0:f.nonce)||(f==null?void 0:f.getAttribute("nonce"));o=c(n.map(u=>{if(u=Ce(u),u in oe)return;oe[u]=!0;const w=u.endsWith(".css"),d=w?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${d}`))return;const s=document.createElement("link");if(s.rel=w?"stylesheet":ke,w||(s.as="script"),s.crossOrigin="",s.href=u,b&&s.setAttribute("nonce",b),document.head.appendChild(s),w)return new Promise((l,a)=>{s.addEventListener("load",l),s.addEventListener("error",()=>a(new Error(`Unable to preload CSS for ${u}`)))})}))}function i(c){const f=new Event("vite:preloadError",{cancelable:!0});if(f.payload=c,window.dispatchEvent(f),!f.defaultPrevented)throw c}return o.then(c=>{for(const f of c||[])f.status==="rejected"&&i(f.reason);return t().catch(i)})};let F=[],N=null,P=null;function Ae(){Le(),Oe()}function Le(){P=document.createElement("button"),P.id="chatToggle",P.className="chat-toggle",P.innerHTML="💬",P.title="Toggle Chat",document.body.appendChild(P),N=document.createElement("div"),N.className="chat-panel",N.innerHTML=`
    <div class="chat-header">
      <h3>Chat</h3>
      <button id="closeChat" style="background: none; border: none; color: var(--text-primary); font-size: 1.2rem; cursor: pointer;">×</button>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="chat-message">
        <div class="sender">System</div>
        <div>Welcome to the chat! Type a message below.</div>
        <div class="time">${new Date().toLocaleTimeString()}</div>
      </div>
    </div>
    <div class="chat-input">
      <input type="text" id="chatInput" placeholder="Type a message..." maxlength="500">
      <button id="sendMessage">Send</button>
    </div>
  `,document.body.appendChild(N)}function Oe(){P.addEventListener("click",()=>{N.classList.toggle("active"),N.classList.contains("active")&&document.getElementById("chatInput").focus()}),document.getElementById("closeChat").addEventListener("click",()=>{N.classList.remove("active")});const e=document.getElementById("sendMessage"),t=document.getElementById("chatInput");e.addEventListener("click",re),t.addEventListener("keypress",r=>{r.key==="Enter"&&re()});const n=document.getElementById("chatMessages");n.addEventListener("DOMNodeInserted",()=>{n.scrollTop=n.scrollHeight})}function re(){const e=document.getElementById("chatInput"),t=e.value.trim();if(!t)return;const n=JSON.parse(localStorage.getItem("userInfo")||"{}"),r=n.nickname||"Anonymous",o={id:Date.now(),sender:r,senderId:n.id||"unknown",message:t,timestamp:new Date().toISOString()};me(o,!0),Pe(o),e.value=""}function me(e,t=!1){const n=document.getElementById("chatMessages"),r=document.createElement("div");r.className=`chat-message ${t?"own":""}`;const o=new Date(e.timestamp).toLocaleTimeString();r.innerHTML=`
    <div class="sender">${e.sender}</div>
    <div>${Ne(e.message)}</div>
    <div class="time">${o}</div>
  `,n.appendChild(r),n.scrollTop=n.scrollHeight,F.push(e),F.length>100&&(F=F.slice(-100))}function Pe(e){Te(async()=>{const{drone:t}=await Promise.resolve().then(()=>qe);return{drone:t}},void 0).then(({drone:t})=>{if(t&&t.rooms){const n=Object.keys(t.rooms)[0];n&&(t.publish({room:n,message:{type:"chat",messageData:e,userInfo:JSON.parse(localStorage.getItem("userInfo")||"{}")}}),console.log("Chat message sent:",e))}}).catch(t=>{console.error("Failed to send chat message:",t),p("Error","Failed to send message")})}function Me(e){me(e,!1)}function Ne(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}const v=[],_=JSON.parse(window.localStorage.getItem("userInfo")),y={},A={};let W,j=null,m=null,M=null,D=null;const L={onChange:null,set(e){typeof this.onChange=="function"&&this.onChange(e)}},xe=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],Ve={iceServers:xe};function ge(e,t){W=e;const n="observable-e7b2d4";D=Ee(n,r,c),m=D.drone,M=D.room,window.addEventListener("online",()=>{p("Info","Network connected. Attempting to reconnect..."),L.set("reconnecting"),w(t)}),window.addEventListener("offline",()=>{p("Error","Network disconnected. Trying to recover..."),L.set("disconnected")});function r(d){if(d)return console.error(d);m=D.drone,M=D.room,f(t),w(t),L.set("connected"),console.log("Connected to Scaledrone")}function o(d,s){A[d]||(A[d]=[]);const l=y[d];if(l&&l.remoteDescription&&l.remoteDescription.type)try{l.addIceCandidate(new RTCIceCandidate(s))}catch(a){console.warn("addIceCandidate failed, queueing:",a),A[d].push(s)}else A[d].push(s)}async function i(d){const s=y[d];if(!s||!s.remoteDescription||!A[d]||A[d].length===0)return;const l=A[d];for(;l.length;){const a=l.shift();try{await s.addIceCandidate(new RTCIceCandidate(a))}catch(h){console.warn("Failed to add queued ICE candidate:",h)}}}function c(d){const{data:s,member:l}=d,a=l.id;if(m&&a!==m.clientId)switch(s.type){case"offer":b(a,!1,t),y[a].setRemoteDescription(new RTCSessionDescription(s.offer)).then(async()=>{const S=await y[a].createAnswer();await y[a].setLocalDescription(S),m.publish({room:n,message:{type:"answer",answer:S,to:a,userInfo:_}}),await i(a)});break;case"answer":s.to===m.clientId&&y[a]&&y[a].setRemoteDescription(new RTCSessionDescription(s.answer)).then(async()=>{await i(a)});break;case"candidate":s.to===m.clientId&&o(a,s.candidate);break;case"leave":console.log(a,"has left the room");const h=v.findIndex(S=>l.id===S.id),T=document.getElementById(a);T&&(T.parentElement.remove(),h>-1&&p("Info",v[h].clientData.userInfo.nickname+" has left the room!")),v.splice(h,1),y[a]&&(y[a].close(),delete y[a]),delete A[a];break;case"join":v.find(S=>S.id===l.id)||v.push(l),console.log(a,"has joined the room"),b(a,!0,t);break;case"screenShare":{const S=document.getElementById(a);S&&(s.isShared===!0?S.setAttribute("screenShare","true"):S.removeAttribute("screenShare"))}break;case"chat":s.messageData&&Me(s.messageData);break;default:console.warn("Unknown data type:",s.type),p("Warning","Unknown data type: "+s.type)}}function f(d){M&&(M.on("members",s=>{console.log("Members connected:",s),s.forEach(l=>{l.id!==m.clientId&&(v.find(a=>a.id===l.id)||v.push(l),y[l.id]||b(l.id,!0,d))})}),M.on("member_join",s=>{var l;v.find(a=>a.id===s.id)||v.push(s),console.log("Member joined:",(l=s.clientData)==null?void 0:l.userInfo.nickname),y[s.id]||b(s.id,!1,d)}),M.on("member_leave",s=>{var h,T,S;const l=v.findIndex($=>$.id===s.id);console.log("Member left:",(S=(T=(h=v[l])==null?void 0:h.clientData)==null?void 0:T.userInfo)==null?void 0:S.nickname);const a=document.getElementById(s.id);a&&(a.parentElement.remove(),l>-1&&p("Info",v[l].clientData.userInfo.nickname+" has left the room!")),v.splice(l,1),y[s.id]&&(y[s.id].close(),delete y[s.id]),delete A[s.id]}))}async function b(d,s,l){if(y[d]&&y[d].connectionState&&y[d].connectionState!=="closed")return;const a=j=new RTCPeerConnection(Ve);if(W&&W.getTracks().forEach(h=>a.addTrack(h,W)),a.onicecandidate=h=>{h.candidate&&m.publish({room:n,message:{type:"candidate",candidate:h.candidate,to:d,userInfo:_}})},a.oniceconnectionstatechange=async()=>{if(a.iceConnectionState==="failed")L.set("reconnecting"),p("Error","Connection failed. Attempting ICE restart..."),await u(a,d,n);else if(a.iceConnectionState==="disconnected")L.set("reconnecting"),p("Error","Connection disconnected. Retrying..."),await u(a,d,n);else if(a.iceConnectionState==="closed"){const h=document.getElementById(d);h&&h.remove(),p("Info","User has left the room!")}},a.onconnectionstatechange=async()=>{a.connectionState==="connected"&&L.set("connected"),(a.connectionState==="failed"||a.connectionState==="disconnected")&&(L.set("reconnecting"),await u(a,d,n))},a.onnegotiationneeded=()=>{},a.onsignalingstatechange=()=>{},a.ontrack=h=>{var S,$;l(h.streams[0],d,($=(S=v.find(ee=>ee.id===d).clientData)==null?void 0:S.userInfo)==null?void 0:$.nickname);const T=v.findIndex(ee=>ee.id===d);T>-1&&p("Info",v[T].clientData.userInfo.nickname+" has joined the room!")},s){const h=await ye(a);h&&m.publish({room:n,message:{type:"offer",offer:h,to:d,userInfo:_}})}y[d]=a}async function u(d,s,l){try{const a=await d.createOffer({iceRestart:!0});await d.setLocalDescription(a),m.publish({room:l,message:{type:"offer",offer:a,to:s,userInfo:_}})}catch(a){console.error("ICE restart failed:",a),p("Error","ICE restart failed. Will attempt full reconnection."),w(t)}}function w(d){try{Object.keys(y).forEach(s=>{try{y[s]&&(y[s].close(),delete y[s])}catch{}}),Object.keys(A).forEach(s=>delete A[s]),v.forEach(s=>{m&&s.id!==m.clientId&&b(s.id,!0,d)})}catch(s){console.error("Reconnect attempt failed:",s)}}}function pe(){if(!!document.getElementById("localVideo")){if(typeof window<"u"){const n=new Event("online");window.dispatchEvent(n)}}else p("Warning","Start the call first to reconnect.")}const qe=Object.freeze(Object.defineProperty({__proto__:null,connectionStatus:L,get drone(){return m},manualReconnect:pe,get pcInfo(){return j},get room(){return M},setupRoom:ge},Symbol.toStringTag,{value:"Module"})),ie=JSON.parse(window.localStorage.getItem("userInfo"));let B=0,U=0,g=null,H=0,te="user";const k=document.querySelector("#quality"),C=document.querySelector("#framerate"),I=document.querySelector("#shareScreen"),x=document.querySelector("#muteVideo"),V=document.querySelector("#switchCamera");k&&k.addEventListener("click",async e=>{var o;if(e.target.tagName!=="INPUT"||!g)return;const t=(o=k.querySelector("input:checked"))==null?void 0:o.value;if(!t)return;const[n,r]=t.split("x").map(Number);await J(n,r,H)});C&&C.addEventListener("click",async e=>{var r;if(e.target.tagName!=="INPUT"||!g)return;const t=(r=C.querySelector("input:checked"))==null?void 0:r.value;if(!t)return;const n=Number(t);await J(B,U,n)});I&&I.addEventListener("click",async e=>{const t=document.querySelector("#localVideo");if(e.target.setAttribute("disabled","true"),e.target.getAttribute("isShared")==="true"){if(e.target.textContent="🖥️ Share Screen",e.target.setAttribute("isShared","false"),x==null||x.removeAttribute("disabled"),k==null||k.removeAttribute("disabled"),C==null||C.removeAttribute("disabled"),V==null||V.removeAttribute("disabled"),e.target.removeAttribute("disabled"),t==null||t.removeAttribute("screenShare"),await J(B,U,H),m){const n=Object.keys(m.rooms)[0];m.publish({room:n,message:{type:"screenShare",from:m.clientId,isShared:!1,userInfo:ie}})}return}if(!g){e.target.removeAttribute("disabled");return}try{const n=await Fe();if(!n)return;if(e.target.textContent="🖥️ Stop Sharing",e.target.setAttribute("isShared","true"),x==null||x.setAttribute("disabled","true"),k==null||k.setAttribute("disabled","true"),C==null||C.setAttribute("disabled","true"),V==null||V.setAttribute("disabled","true"),t==null||t.setAttribute("screenShare","true"),g){const o=g.getVideoTracks()[0];o&&o.stop(),g.getVideoTracks().forEach(i=>g.removeTrack(i))}const r=n.getVideoTracks()[0];if(g.addTrack(r),await he(),m){const o=Object.keys(m.rooms)[0];m.publish({room:o,message:{type:"screenShare",from:m.clientId,isShared:!0,userInfo:ie}})}}catch(n){console.error("Error starting screen share:",n),p("Error","Error starting screen share")}finally{e.target.removeAttribute("disabled")}});async function De(e,t,n,r){g&&g.getVideoTracks().forEach(o=>{g.removeTrack(o),o.stop()});try{const o={video:{width:{ideal:e},height:{ideal:t},frameRate:{ideal:n},facingMode:{ideal:r}},audio:!g};return await navigator.mediaDevices.getUserMedia(o)}catch(o){return console.error("Failed to get media stream:",o),p("Error","Failed to get media stream!"),null}}async function J(e,t,n,r=!1,o=!1){var b;U=t,B=e,H=n;const i=o&&((b=g==null?void 0:g.getVideoTracks()[0])==null?void 0:b.getSettings().facingMode)||"user";te=o?i==="user"?"environment":"user":te;const c=await De(B,U,H,te);if(!c)return!1;const f=c.getVideoTracks()[0];if(g){const u=g.getVideoTracks()[0];u&&(u.stop(),g.removeTrack(u)),g.addTrack(f)}else g=c;if(r){const u=document.querySelector("#localVideo");u&&g.getVideoTracks()[0]&&(u.setAttribute("mode",g.getVideoTracks()[0].getSettings().facingMode||"user"),u.srcObject=g)}return await he(),!0}function Re(){J(B,U,H,!0,!0)}async function je(){var i;const e=((i=k==null?void 0:k.querySelector("input:checked"))==null?void 0:i.value)||"640x480",[t,n]=e.split("x").map(Number),r=C==null?void 0:C.querySelector("input:checked"),o=Number((r==null?void 0:r.value)||30);return await J(t,n,o),g}function se(e,t,n=!1,r=""){const o=document.createElement("div");o.className="participant",o.setAttribute("data-id",t),o.innerHTML=`<video autoplay playsinline></video>
    <div class="overlay">
      <span class="name">${r}</span>
      <div class="controls">
        <button class="muteAudio">🔇</button>
        <button class="muteVideo">🎥</button>
        <button class="switchCamera">🔄</button>
        <button class="hangup">📞</button>
      </div>
    </div>
  </div>`;const i=o.querySelector("video");i.srcObject=e,i.id=t,i.autoplay=!0,i.playsInline=!0,i.setAttribute("memberId",t);const c=document.getElementsByClassName("Channel")[0];c&&(n?(i.muted=!0,c.appendChild(o),g!=null&&g.getVideoTracks()[0]&&i.setAttribute("mode",g.getVideoTracks()[0].getSettings().facingMode||"user"),i.click()):(i.setAttribute("isRemote","true"),c.prepend(o),Be(e,i)))}function Be(e,t){const r=new AudioContext,o=r.createMediaStreamSource(e),i=r.createGain();i.gain.value=2.5;const c=r.createAnalyser();c.fftSize=256;const f=c.frequencyBinCount,b=new Uint8Array(f);o.connect(c),o.connect(i).connect(r.destination),t.srcObject=e,t.volume=0;let u=!1,w=0;const d=500,s=Ue(t),l=setInterval(()=>{c.getByteFrequencyData(b);let a=0;for(let S=0;S<b.length;S++)a+=b[S];const h=a/b.length,T=Date.now();He(s,h),h>20?(w=T,u||(u=!0,ae(!0,t),ce(t.id,!0))):T-w>d&&u&&(u=!1,ae(!1,t),ce(t.id,!1))},100);t.addEventListener("removed",()=>{clearInterval(l),r.close()})}function ae(e,t){const n=t.closest(".participant");n&&(e?(n.classList.add("speaking"),n.style.transform="scale(1.02)",n.style.boxShadow="0 0 20px rgba(30, 144, 255, 0.6)"):(n.classList.remove("speaking"),n.style.transform="",n.style.boxShadow=""))}function Ue(e){const t=e.closest(".participant");if(!t)return null;const n=document.createElement("div");return n.className="audio-level-indicator",n.innerHTML=`
    <div class="audio-bars">
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
      <div class="bar"></div>
    </div>
  `,t.appendChild(n),n}function He(e,t){if(!e)return;const n=e.querySelectorAll(".bar"),r=Math.min(t/50,1),o=Math.ceil(r*n.length);n.forEach((i,c)=>{c<o?(i.style.height=`${20+c*5}px`,i.style.opacity="1"):(i.style.height="5px",i.style.opacity="0.3")})}function ce(e,t){console.log(`Participant ${e} is ${t?"speaking":"not speaking"}`)}async function he(){const e=j;if(!e)return;const t=e.getSenders().find(n=>n.track&&n.track.kind==="video");if(t){const n=t.track;try{n.stop();const o=g.getVideoTracks()[0];await t.replaceTrack(o),await ye(e)}catch(r){if(console.error("Error updating local video stream:",r),p("Error","Error updating local video stream!"),t&&n&&t.replaceTrack)try{await t.replaceTrack(n)}catch{}}}else console.log("No video sender found.")}function Je(){const e=navigator.userAgent,t=/iPhone|iPad|iPod/.test(e),n=/Android/.test(e),r=/Safari/.test(e)&&!/Chrome|CriOS|FxiOS/.test(e),o=/Chrome/.test(e)&&!/Edge|Edg/.test(e),i=/Firefox/.test(e),c=/Edge|Edg/.test(e);return t&&r?"H264":t&&(o||i)||n&&o||n&&i?"VP8":r&&!t?"H264":"VP8"}function $e(){const e=[];if(RTCRtpReceiver.getCapabilities&&RTCRtpReceiver.getCapabilities("video")){const t=RTCRtpReceiver.getCapabilities("video");t.codecs&&t.codecs.forEach(n=>{n.mimeType.includes("VP8")&&e.push("VP8"),n.mimeType.includes("VP9")&&e.push("VP9"),n.mimeType.includes("H264")&&e.push("H264"),n.mimeType.includes("AV1")&&e.push("AV1")})}return[...new Set(e)]}function de(e,t,n="video"){const r=e.split(`\r
`),o=r.findIndex(u=>u.startsWith(`m=${n}`));if(o===-1)return e;const i=new RegExp(`a=rtpmap:(\\d+)\\s${t}`,"i"),c=r.filter(u=>i.test(u)).map(u=>u.match(i)[1]);if(c.length===0)return e;const f=r[o].split(" "),b=c.concat(f.slice(3).filter(u=>!c.includes(u)));return r[o]=[...f.slice(0,3),...b].join(" "),r.join(`\r
`)}async function ye(e){try{const t=await e.createOffer(),n=$e(),r=Je();console.log("Supported codecs:",n),console.log("Preferred codec:",r);let o=t;if(n.includes(r)){const i=de(t.sdp,r);o={type:t.type,sdp:i}}else{console.warn(`Preferred codec ${r} not supported, using default`);const i=["VP8","H264","VP9"];for(const c of i)if(n.includes(c)){const f=de(t.sdp,c);o={type:t.type,sdp:f},console.log(`Using fallback codec: ${c}`);break}}return await e.setLocalDescription(o),o}catch(t){console.error("Failed to create/set local description:",t),p("Error","Failed to negotiate video. Retrying may help.");try{const n=await e.createOffer();return await e.setLocalDescription(n),n}catch{return null}}}function be(){const e=navigator.userAgent,t=/iPhone|iPad|iPod/.test(e),n=/Android/.test(e),r=/Safari/.test(e)&&!/Chrome|CriOS|FxiOS/.test(e),o=/Chrome/.test(e)&&!/Edge|Edg/.test(e),i=/Firefox/.test(e),c=/Edge|Edg/.test(e);if(t)return console.log("Screen sharing is not supported on iOS devices via web apps."),I&&(I.style.display="none",I.setAttribute("disabled","true")),!1;if(n)return o&&"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices?(console.log("Screen sharing is supported on Android Chrome."),!0):(console.log("Screen sharing is not supported on this Android browser."),I&&(I.style.display="none",I.setAttribute("disabled","true")),!1);if("mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices){if(r)return console.log("Screen sharing is supported on desktop Safari (limited)."),!0;if(o||i||c)return console.log("Screen sharing is fully supported on this desktop browser."),!0}return console.log("Screen sharing is not supported on this platform."),I&&(I.style.display="none",I.setAttribute("disabled","true")),!1}async function Fe(){try{if(!be())return p("Error","Screen sharing is not supported on this device."),null;const e={video:{mediaSource:"screen",width:{ideal:1920},height:{ideal:1080},frameRate:{ideal:30}},audio:!0},t=await navigator.mediaDevices.getDisplayMedia(e);return t.getVideoTracks()[0].addEventListener("ended",()=>{console.log("Screen sharing ended by user"),I&&(I.textContent="🖥️ Share Screen",I.setAttribute("isShared","false"),I.removeAttribute("disabled"))}),t}catch(e){return console.error("Screen sharing error:",e),e.name==="NotAllowedError"?p("Error","Screen sharing permission denied."):e.name==="NotSupportedError"?p("Error","Screen sharing not supported on this device."):p("Error","Failed to start screen sharing."),null}}be();function _e(e){try{if(!e||typeof e!="string")return new Uint8Array;const t="=".repeat((4-e.length%4)%4),n=(e+t).replace(/\-/g,"+").replace(/_/g,"/"),r=atob(n),o=new Uint8Array(r.length);for(let i=0;i<r.length;++i)o[i]=r.charCodeAt(i);return o}catch{return new Uint8Array}}const Se={default:{name:"Default",colors:{"--bg-primary":"#0f2027","--bg-secondary":"#203a43","--bg-tertiary":"#2c5364","--bg-panel":"rgba(255, 255, 255, 0.05)","--bg-card":"rgba(0, 0, 0, 0.2)","--bg-button":"#1e90ff","--bg-button-hover":"#3ea0ff","--bg-success":"#16a34a","--bg-warning":"#f59e0b","--bg-error":"#dc2626","--bg-info":"#17a2b8","--text-primary":"#fff","--text-secondary":"#ddd","--text-muted":"#bbb","--border-primary":"rgba(255, 255, 255, 0.15)","--border-success":"#4ade80"}},dark:{name:"Dark",colors:{"--bg-primary":"#000000","--bg-secondary":"#1a1a1a","--bg-tertiary":"#2d2d2d","--bg-panel":"rgba(255, 255, 255, 0.03)","--bg-card":"rgba(0, 0, 0, 0.4)","--bg-button":"#6366f1","--bg-button-hover":"#818cf8","--bg-success":"#10b981","--bg-warning":"#f59e0b","--bg-error":"#ef4444","--bg-info":"#06b6d4","--text-primary":"#ffffff","--text-secondary":"#e5e7eb","--text-muted":"#9ca3af","--border-primary":"rgba(255, 255, 255, 0.1)","--border-success":"#10b981"}},light:{name:"Light",colors:{"--bg-primary":"#f8fafc","--bg-secondary":"#e2e8f0","--bg-tertiary":"#cbd5e1","--bg-panel":"rgba(0, 0, 0, 0.05)","--bg-card":"rgba(255, 255, 255, 0.8)","--bg-button":"#3b82f6","--bg-button-hover":"#2563eb","--bg-success":"#059669","--bg-warning":"#d97706","--bg-error":"#dc2626","--bg-info":"#0891b2","--text-primary":"#1e293b","--text-secondary":"#475569","--text-muted":"#64748b","--border-primary":"rgba(0, 0, 0, 0.1)","--border-success":"#059669"}},purple:{name:"Purple",colors:{"--bg-primary":"#1e1b4b","--bg-secondary":"#312e81","--bg-tertiary":"#4338ca","--bg-panel":"rgba(255, 255, 255, 0.05)","--bg-card":"rgba(0, 0, 0, 0.2)","--bg-button":"#8b5cf6","--bg-button-hover":"#a78bfa","--bg-success":"#10b981","--bg-warning":"#f59e0b","--bg-error":"#ef4444","--bg-info":"#06b6d4","--text-primary":"#ffffff","--text-secondary":"#e0e7ff","--text-muted":"#c7d2fe","--border-primary":"rgba(255, 255, 255, 0.15)","--border-success":"#10b981"}}};function ve(e){const t=Se[e];if(!t)return;const n=document.documentElement;Object.entries(t.colors).forEach(([r,o])=>{n.style.setProperty(r,o)}),localStorage.setItem("selectedTheme",e)}function we(){return localStorage.getItem("selectedTheme")||"default"}function We(){const e=we();return ve(e),e}function ze(){const e=document.createElement("div");e.id="themeSelector",e.innerHTML=`
    <label for="themeSelect">Theme:</label>
    <select id="themeSelect">
      ${Object.entries(Se).map(([n,r])=>`<option value="${n}">${r.name}</option>`).join("")}
    </select>
  `;const t=e.querySelector("#themeSelect");return t.value=we(),t.addEventListener("change",n=>{ve(n.target.value)}),e}const Ie=/iphone|ipod|ipad/i.test(navigator.userAgent),Ke=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let E=null;const Ye=document.querySelector("#muteVideo"),Ge=document.querySelector("#muteAudio"),G=document.querySelector("#userInfoModal"),le=document.querySelector("#retryBtn"),q=document.querySelector("#connectionStatus"),z=q==null?void 0:q.querySelector(".text"),Q=window.location.hostname==="localhost"?"http://localhost:3000/":"https://web-push-3zaz.onrender.com/",R=document.querySelector("#push");function Qe(e,t){var r;const n=((r=JSON.parse(window.localStorage.getItem("userInfo")))==null?void 0:r.id)||0;fetch(Q+"notifyAll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({initiator:n,title:e,body:t})})}async function Xe(){if(!JSON.parse(window.localStorage.getItem("userInfo")))return!1;if(Notification.permission==="granted"){const t=localStorage.getItem("subscription");if(!t){const o=await ne.pushManager.getSubscription();return o&&(await o.unsubscribe(),p("Info","Notification unsubscribed locally!, Please resubscribe.")),!1}return(await(await fetch(Q+"isPushSubscribed",{method:"POST",headers:{"Content-Type":"application/json"},body:t})).json()).isSubscribed}}q&&(L.onChange=e=>{q.classList.remove("connected","reconnecting","disconnected"),q.classList.add(e),z&&(e==="connected"&&(z.textContent="Connected"),e==="reconnecting"&&(z.textContent="Reconnecting…"),e==="disconnected"&&(z.textContent="Disconnected"))});le&&le.addEventListener("click",()=>{L.set("reconnecting"),pe()});R.addEventListener("click",async e=>{const t=await fetch(Q+"vapid").catch(c=>console.log(c));if(!t)return;const{publicKey:n}=await t.json();if(R.setAttribute("disabled","true"),await Notification.requestPermission()!=="granted"){p("Error","Unable to subscribe to push notifications"),R.setAttribute("disabled","false");return}const o=await ne.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:_e(n)}),i={endpoint:o.toJSON().endpoint,expirationTime:o.toJSON().expirationTime,keys:{p256dh:o.toJSON().keys.p256dh,auth:o.toJSON().keys.auth,id:JSON.parse(window.localStorage.getItem("userInfo")).id}};localStorage.setItem("subscription",JSON.stringify(o)),await fetch(Q+"subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)}).then(c=>{c.status===200?p("Success","Push notifications subscribed successfully"):p("Error","Unable to subscribe to push notifications")}).catch(c=>{console.log(c),p("Error","Unable to subscribe to push notifications")}),R.style.display="none",p("Success","Push notifications subscribed successfully")},!1);setTimeout(async()=>{const e=await Xe();R.style.display=e?"none":""},1e3);let O=window.localStorage.getItem("userInfo");if(!O)X();else{O=JSON.parse(O);const{nickname:e,gender:t}=O;(!e||!t)&&X()}document.querySelector("#audioOutputSelect").addEventListener("change",async()=>{const e=audioOutputSelect.value,t=document.querySelectorAll("video[isRemote]");try{for(const n of t)typeof n.setSinkId=="function"&&await n.setSinkId(e);console.log(`Audio output set to device: ${e}`)}catch(n){console.error("Error setting audio output device:",n)}});navigator.mediaDevices.addEventListener("devicechange",()=>{Z()});async function Z(){try{const t=(await navigator.mediaDevices.enumerateDevices()).filter(n=>n.kind==="audiooutput"||n.label.includes("headset"));t.length>0&&t.forEach(n=>{if(audioOutputSelect.querySelector(`option[value="${n.deviceId}"]`))return;const r=document.createElement("option");r.value=n.deviceId,r.text=n.label||n.kind||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(r)})}catch(e){console.error("Error fetching audio output devices:",e)}}document.querySelector("#controls").addEventListener("click",async e=>{const t=e.target;switch(e.target.id){case"start":t.disabled=!0,await Ze(),t.disabled=!1;break;case"muteAudio":t.textContent="🔇 "+(E.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio"),E.getAudioTracks()[0].enabled=!E.getAudioTracks()[0].enabled;break;case"muteVideo":t.textContent="🎥 "+(E.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video"),E.getVideoTracks()[0].enabled=!E.getVideoTracks()[0].enabled;break;case"switchCamera":await Re();break;case"audioOutputRefresh":Z();break;case"hangup":Ye.textContent="🎥 Mute Video",Ge.textContent="🔇 Mute Audio",document.querySelector("#localMainVideo").classList.remove("active"),E&&(E.getTracks().forEach(r=>{r.enabled=!1}),setTimeout(()=>{E.getTracks().forEach(r=>r.stop()),E=null,m.publish({room:Object.keys(m.rooms)[0],message:{type:"leave",from:m.clientId,userInfo:O}}),document.querySelector(".Channel").innerHTML="",j&&j.getSenders().forEach(r=>{r.track&&r.track.stop()})},300));break}});document.querySelector(".Channel").addEventListener("click",e=>{if(e.target.tagName!=="VIDEO")return;const t=document.getElementById("localMainVideo");t.srcObject=e.target.srcObject,t.classList.add("active"),t.style.transform=e.target.id==="localVideo"?"scale(-1, 1)":""});document.querySelector("#localMainVideo").addEventListener("dblclick",e=>{e.target.requestFullscreen()});async function Ze(){var t;const e=((t=JSON.parse(window.localStorage.getItem("userInfo")))==null?void 0:t.nickname)||"No name";if(Qe("Video Conferencing with KiteCite","Started by "+e),E=await je(),se(E,"localVideo",!0,"You"),Ie||Z(),m){m.publish({room:Object.keys(m.rooms)[0],message:{type:"join",from:m.clientId,userInfo:O}});return}ge(E,(n,r,o)=>{document.getElementById(r)||se(n,r,!1,o)})}Ie||Z();Ke||(document.querySelector("#switchCamera").style.display="none");We();const et=ze(),ue=document.querySelector(".controls");ue&&ue.appendChild(et);Ae();"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{if(e.data&&e.data.type==="NOTIFICATION_CLICK"){if(console.log("Notification clicked:",e.data.data),e.data.data.type==="chat"){const t=document.querySelector(".chat-panel");if(t){t.classList.add("active");const n=document.getElementById("chatInput");n&&n.focus()}}e.data.data.type==="call"&&e.data.data.roomId&&p("Info",`Incoming call to room: ${e.data.data.roomId}`)}});let K;const Y=document.getElementById("install-btn");window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),K=e,Y.style.display="flex",setTimeout(()=>{Y.style.display="none",p("Info","You can add this app to your home screen!")},15e3),Y.addEventListener("click",()=>{K.prompt(),K.userChoice.then(t=>{t.outcome==="accepted"?console.log("User accepted the A2HS prompt"):console.log("User dismissed the A2HS prompt"),K=null})})});window.matchMedia("(display-mode: standalone)").matches&&(Y.style.display="none");G.addEventListener("click",e=>{if(e.target===G||e.target.id==="closeModal")fe();else if(e.target.id==="submit-btn"){e.stopPropagation();const t=document.querySelector("#nickname").value,n=document.querySelector(".radio-group").querySelector("input:checked").value,r=document.querySelector("#status").value,o=document.querySelector("#age").value;if(!t||!n){p("Error","Please fill all the fields!");return}O={nickname:t,gender:n,status:r,age:o,id:new Date().getTime()},window.localStorage.setItem("userInfo",JSON.stringify(O)),fe()}});function X(){G.classList.add("show-modal");const e=window.localStorage.getItem("userInfo"),t=document.querySelector("h4");e?(document.querySelector("#nickname").value=JSON.parse(e).nickname,document.querySelector(".radio-group").querySelector("input[value="+JSON.parse(e).gender+"]").checked=!0,document.querySelector("#status").value=JSON.parse(e).status,document.querySelector("#age").value=JSON.parse(e).age,t.innerHTML="Video Conferencing with KiteCite"):(document.querySelector("#start").setAttribute("disabled",!0),t.innerHTML="Dear Anonymous User, Please Enter Your Details")}function fe(){const e=window.localStorage.getItem("userInfo"),t=document.querySelector("h4");G.classList.remove("show-modal"),e?(document.querySelector("#nickname").value="",document.querySelector(".radio-group").querySelector("input[value='male']").checked=!0,document.querySelector("#status").value="",document.querySelector("#age").value="",t.innerHTML="Video Conferencing with KiteCite",document.querySelector("#start").removeAttribute("disabled"),t.removeEventListener("click",X)):(document.querySelector("#start").setAttribute("disabled",!0),t.innerHTML="Dear Anonymous User, Please Enter Your Details By Clicking Here",t.addEventListener("click",X))}
