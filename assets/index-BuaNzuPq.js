(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const f of s.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&n(f)}).observe(document,{childList:!0,subtree:!0});function r(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=r(o);fetch(o.href,s)}})();function M(t,e,r){const n=new window.Scaledrone("EoIG3R1I4JdyS4L1"),o=n.subscribe(t);return n.on("open",e),o.on("message",r),{drone:n,room:o}}const g={};let T,y=null,u=null,I=null;const O=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],N={iceServers:O};function R(t,e){T=t;const r="observable-e7b2d4",{drone:n,room:o}=M(r,s,f);u=n,I=o;function s(c){if(c)return console.error(c);console.log("Connected to Scaledrone")}function f(c){const{data:i,member:S}=c,a=S.id;if(a!==u.clientId)switch(i.type){case"offer":p(a,!1,e),g[a].setRemoteDescription(new RTCSessionDescription(i.offer)),g[a].createAnswer().then(h=>{g[a].setLocalDescription(h),u.publish({room:r,message:{type:"answer",answer:h,to:a}})});break;case"answer":i.to===u.clientId&&g[a]&&g[a].setRemoteDescription(new RTCSessionDescription(i.answer));break;case"candidate":i.to===u.clientId&&g[a]&&g[a].addIceCandidate(new RTCIceCandidate(i.candidate));break;case"leave":const l=document.getElementById(a);l&&l.remove(),g[a]&&(g[a].close(),delete g[a]);break;case"join":p(a,!0,e);break;default:console.warn("Unknown data type:",i.type)}}I.on("members",c=>{c.forEach(i=>{i.id!==u.clientId&&p(i.id,!0,e)})});async function p(c,i,S){const a=y=new RTCPeerConnection(N);if(a.onicecandidate=l=>{l.candidate?(console.log("New ICE Candidate:",l.candidate),u.publish({room:r,message:{type:"candidate",candidate:l.candidate,to:c}})):console.log("All ICE candidates have been gathered.")},a.oniceconnectionstatechange=()=>{var l,h,E;console.log("ICE connection state changed:",a.iceConnectionState),a.iceConnectionState==="failed"?(console.warn("ICE Connection failed. Likely need TURN."),(l=document.getElementById(c))==null||l.remove()):a.iceConnectionState==="disconnected"?(console.warn("ICE Connection disconnected. Could be a network issue."),(h=document.getElementById(c))==null||h.remove()):a.iceConnectionState==="closed"&&(console.warn("ICE Connection closed."),(E=document.getElementById(c))==null||E.remove())},a.onconnectionstatechange=()=>{console.log("PeerConnection state:",a.connectionState)},a.onnegotiationneeded=()=>{console.log("Negotiation needed")},a.onsignalingstatechange=()=>{console.log("Signaling state changed:",a.signalingState)},a.ontrack=l=>{console.log("Track received:",l.track.kind),S(l.streams[0],c)},T.getTracks().forEach(l=>a.addTrack(l,T)),i){const l=await A(a);u.publish({room:r,message:{type:"offer",offer:l,to:c}})}g[c]=a}}let w=0,k=0,d=null,b=0,v="user";const P=document.querySelector("#quality"),L=document.querySelector("#framerate");P.addEventListener("change",async t=>{if(!d)return;const[e,r]=t.target.value.split("x").map(Number);await C(e,r,b)});L.addEventListener("change",async t=>{if(!d)return;const e=Number(t.target.value);await C(w,k,e)});async function D(t,e,r,n){d&&(d.getVideoTracks()[0].stop(),d.removeTrack(d.getVideoTracks()[0]));try{const o={video:{width:{ideal:t},height:{ideal:e},frameRate:{ideal:r},facingMode:{ideal:n}},audio:!d};return await navigator.mediaDevices.getUserMedia(o)}catch(o){return console.error("Failed to get media stream:",o),null}}async function C(t,e,r,n=!1,o=!1){k=e,w=t,b=r;const s=o&&d.getVideoTracks()[0].getSettings().facingMode||"user";v=o?s==="user"?"environment":"user":v;const f=await D(w,k,b,v);if(!f)return!1;const p=f.getVideoTracks()[0];if(d){const c=d.getVideoTracks()[0];c&&(c.stop(),d.removeTrack(c)),d.addTrack(p)}else d=f;if(n){const c=document.querySelector("#localVideo");c.setAttribute("mode",d.getVideoTracks()[0].getSettings().facingMode||"user"),c.srcObject=d}return await j(),!0}function q(){C(w,k,b,!0,!0)}async function x(){const[t,e]=P.value.split("x").map(Number),r=Number(L.value);return await C(t,e,r),d}function V(t,e,r=!1){const n=document.createElement("video");n.srcObject=t,n.id=e,n.autoplay=!0,n.playsInline=!0,r?(n.muted=!0,document.getElementsByClassName("Channel")[0].appendChild(n),n.setAttribute("mode",d.getVideoTracks()[0].getSettings().facingMode||"user")):document.getElementsByClassName("Channel")[0].prepend(n)}async function j(){const t=y;if(!t)return;const e=t.getSenders().find(r=>r.track&&r.track.kind==="video");if(e){const r=e.track;try{r.stop();const o=d.getVideoTracks()[0];await e.replaceTrack(o),await A(t)}catch(n){console.error("Error updating local video stream:",n),e&&r&&e.replaceTrack&&await e.replaceTrack(r)}}else console.log("No video sender found.")}function B(){const t=navigator.userAgent;return/iPhone|iPad|iPod/.test(t)&&/Safari/.test(t)&&!/CriOS/.test(t)?"H264":(/Android/.test(t)&&/Chrome/.test(t)||/Firefox/.test(t)||/Edge|Edg/.test(t),"VP8")}function U(t,e,r="video"){const n=t.split(`\r
`),o=n.findIndex(i=>i.startsWith(`m=${r}`));if(o===-1)return t;const s=new RegExp(`a=rtpmap:(\\d+)\\s${e}`,"i"),f=n.filter(i=>s.test(i)).map(i=>i.match(s)[1]);if(f.length===0)return t;const p=n[o].split(" "),c=f.concat(p.slice(3).filter(i=>!f.includes(i)));return n[o]=[...p.slice(0,3),...c].join(" "),n.join(`\r
`)}async function A(t){const e=await t.createOffer(),r=B(),n=U(e.sdp,r);return await t.setLocalDescription({type:e.type,sdp:n}),console.log("Preferred codec:",r),console.log("Modified SDP:",n),e}const F=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let m=null;document.querySelector("#controls").addEventListener("click",async t=>{const e=t.target;switch(t.target.id){case"start":e.disabled=!0,await $(),e.disabled=!1;break;case"muteAudio":e.textContent=m.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio",m.getAudioTracks()[0].enabled=!m.getAudioTracks()[0].enabled;break;case"muteVideo":e.textContent=m.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video",m.getVideoTracks()[0].enabled=!m.getVideoTracks()[0].enabled;break;case"switchCamera":await q();break;case"hangup":m&&(m.getTracks().forEach(n=>{n.enabled=!1}),setTimeout(()=>{m.getTracks().forEach(n=>n.stop()),m=null,u.publish({room:Object.keys(u.rooms)[0],message:{type:"leave",from:u.clientId}}),document.querySelector(".Channel").innerHTML="",y&&y.getSenders().forEach(n=>{n.track&&n.track.stop()})},300));break}});async function $(){if(m=await x(),V(m,"localVideo",!0),u){u.publish({room:Object.keys(u.rooms)[0],message:{type:"join",from:u.clientId}});return}R(m,(t,e)=>{document.getElementById(e)||V(t,e)})}F||(document.querySelector("#switchCamera").style.display="none");
