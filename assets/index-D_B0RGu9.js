(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const d of r)if(d.type==="childList")for(const f of d.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&o(f)}).observe(document,{childList:!0,subtree:!0});function n(r){const d={};return r.integrity&&(d.integrity=r.integrity),r.referrerPolicy&&(d.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?d.credentials="include":r.crossOrigin==="anonymous"?d.credentials="omit":d.credentials="same-origin",d}function o(r){if(r.ep)return;r.ep=!0;const d=n(r);fetch(r.href,d)}})();function j(e,t,n){const o=new window.Scaledrone("EoIG3R1I4JdyS4L1"),r=o.subscribe(e);return o.on("open",t),r.on("message",n),{drone:o,room:r}}function S(e,t){const n=document.getElementById("toastContainer"),o=document.createElement("div");o.classList.add("toast",e.toLowerCase()),o.textContent=t,n.appendChild(o),setTimeout(()=>{o.remove()},3e3)}const g={};let T,E=null,u=null,L=null;const $=[{urls:["stun:stun.l.google.com:19302"]},{urls:["turn:122.166.150.147:5060?transport=tcp"],username:"test",credential:"pa55w0rd!"}],F={iceServers:$};function H(e,t){T=e;const n="observable-e7b2d4",{drone:o,room:r}=j(n,d,f);u=o,L=r;function d(i){if(i)return console.error(i);console.log("Connected to Scaledrone")}function f(i){const{data:c,member:y}=i,a=y.id;if(a!==u.clientId)switch(c.type){case"offer":p(a,!1,t),g[a].setRemoteDescription(new RTCSessionDescription(c.offer)),g[a].createAnswer().then(h=>{g[a].setLocalDescription(h),u.publish({room:n,message:{type:"answer",answer:h,to:a}})});break;case"answer":c.to===u.clientId&&g[a]&&g[a].setRemoteDescription(new RTCSessionDescription(c.answer));break;case"candidate":c.to===u.clientId&&g[a]&&g[a].addIceCandidate(new RTCIceCandidate(c.candidate));break;case"leave":const l=document.getElementById(a);l&&l.remove(),g[a]&&(g[a].close(),delete g[a]);break;case"join":p(a,!0,t);break;case"screenShare":{const h=document.getElementById(a);h&&(c.isShared===!0?h.setAttribute("screenShare","true"):h.removeAttribute("screenShare"))}break;default:console.warn("Unknown data type:",c.type),S("Warning","Unknown data type: "+c.type)}}L.on("members",i=>{i.forEach(c=>{c.id!==u.clientId&&p(c.id,!0,t)})});async function p(i,c,y){const a=E=new RTCPeerConnection(F);if(a.onicecandidate=l=>{l.candidate?(console.log("New ICE Candidate:",l.candidate),u.publish({room:n,message:{type:"candidate",candidate:l.candidate,to:i}})):console.log("All ICE candidates have been gathered.")},a.oniceconnectionstatechange=()=>{var l,h,P;console.log("ICE connection state changed:",a.iceConnectionState),a.iceConnectionState==="failed"?(console.warn("ICE Connection failed. Likely need TURN."),(l=document.getElementById(i))==null||l.remove(),S("Error","Connection failed. User is not connected!")):a.iceConnectionState==="disconnected"?(console.warn("ICE Connection disconnected. Could be a network issue."),(h=document.getElementById(i))==null||h.remove(),S("Error","Connection disconnected. Could be a network issue!")):a.iceConnectionState==="closed"&&(console.warn("ICE Connection closed."),(P=document.getElementById(i))==null||P.remove(),S("Info","User has left the room!"))},a.onconnectionstatechange=()=>{console.log("PeerConnection state:",a.connectionState)},a.onnegotiationneeded=()=>{console.log("Negotiation needed")},a.onsignalingstatechange=()=>{console.log("Signaling state changed:",a.signalingState)},a.ontrack=l=>{console.log("Track received:",l.track.kind),y(l.streams[0],i),S("Info","User has joined the room!")},T.getTracks().forEach(l=>a.addTrack(l,T)),c){const l=await B(a);u.publish({room:n,message:{type:"offer",offer:l,to:i}})}g[i]=a}}let b=0,v=0,s=null,w=0,V="user";const A=document.querySelector("#quality"),I=document.querySelector("#framerate"),O=document.querySelector("#shareScreen"),D=document.querySelector("#muteVideo"),q=document.querySelector("#switchCamera");A.addEventListener("change",async e=>{if(!s)return;const[t,n]=e.target.value.split("x").map(Number);await k(t,n,w)});I.addEventListener("change",async e=>{if(!s)return;const t=Number(e.target.value);await k(b,v,t)});O.addEventListener("click",async e=>{const t=document.querySelector("#localVideo");if(e.target.setAttribute("disabled","true"),e.target.getAttribute("isShared")==="true"){e.target.textContent="🖥️ Share Screen",e.target.setAttribute("isShared","false"),D.removeAttribute("disabled"),A.removeAttribute("disabled"),I.removeAttribute("disabled"),q.removeAttribute("disabled"),e.target.removeAttribute("disabled"),t.removeAttribute("screenShare"),await k(b,v,w),u.publish({room:ROOM_NAME,message:{type:"screenShare",from:u.clientId,isShared:!1}});return}if(s)try{const n=await navigator.mediaDevices.getDisplayMedia({video:{mediaSource:"screen"}});e.target.textContent="🖥️ Stop Sharing",e.target.setAttribute("isShared","true"),D.setAttribute("disabled","true"),A.setAttribute("disabled","true"),I.setAttribute("disabled","true"),q.setAttribute("disabled","true"),t.setAttribute("screenShare","true"),s&&(s.getVideoTracks()[0].stop(),s.removeTrack(s.getVideoTracks()[0]));const o=n.getVideoTracks()[0];s.addTrack(o),await R(),u.publish({room:ROOM_NAME,message:{type:"screenShare",from:u.clientId,isShared:!0}})}catch(n){console.error("Error starting screen share:",n)}finally{e.target.removeAttribute("disabled")}});async function W(e,t,n,o){s&&(s.getVideoTracks()[0].stop(),s.removeTrack(s.getVideoTracks()[0]));try{const r={video:{width:{ideal:e},height:{ideal:t},frameRate:{ideal:n},facingMode:{ideal:o}},audio:!s};return await navigator.mediaDevices.getUserMedia(r)}catch(r){return console.error("Failed to get media stream:",r),S("Error","Failed to get media stream!"),null}}async function k(e,t,n,o=!1,r=!1){v=t,b=e,w=n;const d=r&&s.getVideoTracks()[0].getSettings().facingMode||"user";V=r?d==="user"?"environment":"user":V;const f=await W(b,v,w,V);if(!f)return!1;const p=f.getVideoTracks()[0];if(s){const i=s.getVideoTracks()[0];i&&(i.stop(),s.removeTrack(i)),s.addTrack(p)}else s=f;if(o){const i=document.querySelector("#localVideo");i.setAttribute("mode",s.getVideoTracks()[0].getSettings().facingMode||"user"),i.srcObject=s}return await R(),!0}function G(){k(b,v,w,!0,!0)}async function _(){const[e,t]=A.value.split("x").map(Number),n=Number(I.value);return await k(e,t,n),s}function x(e,t,n=!1){const o=document.createElement("video");o.srcObject=e,o.id=t,o.autoplay=!0,o.playsInline=!0,n?(o.muted=!0,document.getElementsByClassName("Channel")[0].appendChild(o),o.setAttribute("mode",s.getVideoTracks()[0].getSettings().facingMode||"user")):(document.getElementsByClassName("Channel")[0].prepend(o),z(e,o))}function z(e,t){const o=new AudioContext,r=o.createMediaStreamSource(e),d=o.createGain();d.gain.value=1;const f=o.createAnalyser();f.fftSize=256;const p=f.frequencyBinCount,i=new Uint8Array(p);r.connect(f),r.connect(d).connect(o.destination),t.srcObject=e,t.volume=0;let c=!1;setInterval(()=>{f.getByteFrequencyData(i);let y=0;for(let l=0;l<i.length;l++)y+=i[l];const a=y/i.length;console.log({totalEnergy:y,averageEnergy:y/i.length,threshold:20}),a>20?c||(c=!0,N(!0,t)):c&&(c=!1,N(!1,t))},100)}function N(e,t){const n=t;e?n.style.border="2px solid #1e90ff":n.style.border="none"}async function R(){const e=E;if(!e)return;const t=e.getSenders().find(n=>n.track&&n.track.kind==="video");if(t){const n=t.track;try{n.stop();const r=s.getVideoTracks()[0];await t.replaceTrack(r),await B(e)}catch(o){console.error("Error updating local video stream:",o),S("Error","Error updating local video stream!"),t&&n&&t.replaceTrack&&await t.replaceTrack(n)}}else console.log("No video sender found.")}function J(){const e=navigator.userAgent;return/iPhone|iPad|iPod/.test(e)&&/Safari/.test(e)&&!/CriOS/.test(e)?"H264":(/Android/.test(e)&&/Chrome/.test(e)||/Firefox/.test(e)||/Edge|Edg/.test(e),"VP8")}function K(e,t,n="video"){const o=e.split(`\r
`),r=o.findIndex(c=>c.startsWith(`m=${n}`));if(r===-1)return e;const d=new RegExp(`a=rtpmap:(\\d+)\\s${t}`,"i"),f=o.filter(c=>d.test(c)).map(c=>c.match(d)[1]);if(f.length===0)return e;const p=o[r].split(" "),i=f.concat(p.slice(3).filter(c=>!f.includes(c)));return o[r]=[...p.slice(0,3),...i].join(" "),o.join(`\r
`)}async function B(e){const t=await e.createOffer(),n=J(),o=K(t.sdp,n);return await e.setLocalDescription({type:t.type,sdp:o}),console.log("Preferred codec:",n),console.log("Modified SDP:",o),t}function Q(){return/iphone|ipod|ipad/i.test(navigator.userAgent)?(console.log("Screen sharing is not supported on iOS devices via web apps. Please use a native app or WebView."),O.setAttribute("disabled","true"),!1):"mediaDevices"in navigator&&"getDisplayMedia"in navigator.mediaDevices?(console.log("Screen sharing is supported on this platform."),!0):(console.log("Screen sharing is not supported on this platform."),O.setAttribute("disabled","true"),!1)}Q();const X=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);let m=null;const Y=document.querySelector("#muteVideo"),Z=document.querySelector("#muteAudio");document.querySelector("#audioOutputSelect").addEventListener("change",e=>{const t=audioOutputSelect.value,n=document.querySelectorAll("video:not(#localVideo)");try{n.forEach(async o=>{await o.setSinkId(t)}),console.log(`Audio output set to device: ${t}`)}catch(o){console.error("Error setting audio output device:",o)}});navigator.mediaDevices.addEventListener("devicechange",()=>{U()});async function U(){const e=document.querySelectorAll("video:not(#localVideo)");for(const t of e)if(typeof t.setSinkId>"u"){console.log("Audio output device selection is not supported on this device.");return}try{const n=(await navigator.mediaDevices.enumerateDevices()).filter(o=>o.kind==="audiooutput");n.length>0&&n.forEach(o=>{if(audioOutputSelect.querySelector(`option[value="${o.deviceId}"]`))return;const r=document.createElement("option");r.value=o.deviceId,r.text=o.label||o.kind||`Speaker ${audioOutputSelect.length+1}`,audioOutputSelect.appendChild(r)})}catch(t){console.error("Error fetching audio output devices:",t)}}document.querySelector("#controls").addEventListener("click",async e=>{const t=e.target;switch(e.target.id){case"start":t.disabled=!0,await ee(),t.disabled=!1;break;case"muteAudio":t.textContent="🔇 "+(m.getAudioTracks()[0].enabled?"Unmute Audio":"Mute Audio"),m.getAudioTracks()[0].enabled=!m.getAudioTracks()[0].enabled;break;case"muteVideo":t.textContent="🎥 "+(m.getVideoTracks()[0].enabled?"Unmute Video":"Mute Video"),m.getVideoTracks()[0].enabled=!m.getVideoTracks()[0].enabled;break;case"switchCamera":await G();break;case"hangup":Y.textContent="🎥 Mute Video",Z.textContent="🔇 Mute Audio",m&&(m.getTracks().forEach(o=>{o.enabled=!1}),setTimeout(()=>{m.getTracks().forEach(o=>o.stop()),m=null,u.publish({room:Object.keys(u.rooms)[0],message:{type:"leave",from:u.clientId}}),document.querySelector(".Channel").innerHTML="",E&&E.getSenders().forEach(o=>{o.track&&o.track.stop()})},300));break}});async function ee(){if(m=await _(),x(m,"localVideo",!0),u){u.publish({room:Object.keys(u.rooms)[0],message:{type:"join",from:u.clientId}});return}H(m,(e,t)=>{document.getElementById(t)||x(e,t)})}U();X||(document.querySelector("#switchCamera").style.display="none");let C;const M=document.getElementById("install-btn");window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),C=e,M.style.display="flex",M.addEventListener("click",()=>{C.prompt(),C.userChoice.then(t=>{t.outcome==="accepted"?console.log("User accepted the A2HS prompt"):console.log("User dismissed the A2HS prompt"),C=null})})});window.matchMedia("(display-mode: standalone)").matches&&(M.style.display="none");
